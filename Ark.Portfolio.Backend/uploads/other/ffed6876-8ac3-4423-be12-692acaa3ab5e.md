# Ark Alliance Trading Bot - Position Service

## Overview

Autonomous microservice for Binance Futures position tracking and Click Strategy execution. This is the backend that powers the automated trading engine.

---

## Features

- âœ… **Position Tracking** - Real-time position updates via User Data Stream
- âœ… **Click Strategy Engine** - Automated PnL-based trading with click thresholds
- âœ… **GTX Orders** - Post-Only limit orders for reduced fees (0.02%)
- âœ… **Algo Stop-Limit** - Conditional orders for inversion protection
- âœ… **Market Order Close** - Fast execution with taker fee (0.05%)
- âœ… **Wait Trends** - AI-powered direction analysis using GeminiTrendAnalyzer
- âœ… **WebSocket API** - Low-latency order execution via Binance WS API
- âœ… **Multi-Instance** - Support for multiple exchange accounts
- âœ… **Real-time Market Data** - BookTicker and MiniTicker streaming
- âœ… **Hybrid PnL Monitoring** - WebSocket events + 200ms polling loop

---

## Technology Stack

| Technology | Purpose |
|------------|---------|
| **Node.js 20+** | Runtime |
| **Express** | HTTP server |
| **TypeScript** | Type safety |
| **SQLite (better-sqlite3)** | Database |
| **Socket.IO** | WebSocket server |
| **Binance Futures API** | Exchange integration |

---

## Prerequisites

### Node.js Version
- **Recommended**: Node.js v20 LTS
- **Supported**: Node.js >= 18

### Windows Build Dependencies (for better-sqlite3)

`better-sqlite3` is a native module that requires C++ compilation on Windows.

#### Option 1: Install Visual Studio Build Tools (Recommended)

1. Download [Visual Studio Build Tools](https://visualstudio.microsoft.com/visual-cpp-build-tools/)
2. Run the installer
3. Select **"Desktop development with C++"** workload
4. Complete installation and restart terminal

```powershell
# Then install dependencies
npm install
```

#### Option 2: Use Node.js v20 LTS (Prebuilt binaries available)

Prebuilt binaries for `better-sqlite3` are available for Node.js v20:

```powershell
# Install nvm-windows if not already installed
# https://github.com/coreybutler/nvm-windows/releases

nvm install 20
nvm use 20
npm install
```

#### Option 3: Use sql.js (JavaScript pure alternative)

If you cannot install Visual Studio Build Tools:

```powershell
npm uninstall better-sqlite3
npm install sql.js
```

> âš ï¸ Note: This requires code modifications to use async API

---

## Installation

```powershell
# Navigate to project directory
cd Ark.Alliance.Trading.Bot.PositionService

# Install dependencies
npm install

# Run development server
npm run dev
```

---

## Configuration

### Environment Variables

Create a `.env` file:

```env
# Server
PORT=3055
NODE_ENV=development

# Binance Environment (TESTNET or MAINNET)
BINANCE_ENV=TESTNET
```

### Database

SQLite database is automatically created at `./data/position-service.db`

---

## Project Structure

```
src/
â”œâ”€â”€ controllers/          # HTTP route handlers
â”‚   â”œâ”€â”€ InstanceController.ts
â”‚   â”œâ”€â”€ StrategyController.ts
â”‚   â”œâ”€â”€ MarketController.ts
â”‚   â””â”€â”€ AccountController.ts
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ cache/            # In-memory caches
â”‚   â”‚   â”œâ”€â”€ PositionCache.ts
â”‚   â”‚   â””â”€â”€ OrderCache.ts
â”‚   â”œâ”€â”€ factory/          # Instance factories
â”‚   â”‚   â””â”€â”€ ServicePositionFactory.ts
â”‚   â”œâ”€â”€ instance/         # Service instances
â”‚   â”‚   â”œâ”€â”€ PositionServiceInstance.ts
â”‚   â”‚   â””â”€â”€ handlers/     # Event handlers
â”‚   â”œâ”€â”€ services/         # Business logic services
â”‚   â”‚   â”œâ”€â”€ ClickMonitoringService.ts
â”‚   â”‚   â”œâ”€â”€ MarketDataService.ts
â”‚   â”‚   â”œâ”€â”€ GeminiTrendAnalyzerService.ts
â”‚   â”‚   â””â”€â”€ FuturesCostAndPnLService.ts
â”‚   â””â”€â”€ strategy/         # Click Strategy engine
â”‚       â””â”€â”€ click/
â”‚           â”œâ”€â”€ ClickStrategyCore.ts
â”‚           â”œâ”€â”€ ClickStrategyEngine.ts
â”‚           â”œâ”€â”€ ClickStrategyOrderManager.ts
â”‚           â”œâ”€â”€ ClickStrategyStateManager.ts
â”‚           â””â”€â”€ ClickStrategyEventHandler.ts
â”œâ”€â”€ Data/
â”‚   â”œâ”€â”€ Entities/         # Database entities
â”‚   â”œâ”€â”€ repositories/     # Data access layer
â”‚   â”œâ”€â”€ schemas/          # SQL schema files
â”‚   â””â”€â”€ DatabaseService.ts
â”œâ”€â”€ clients/              # Binance API clients
â”‚   â”œâ”€â”€ BinanceRestClient.ts
â”‚   â”œâ”€â”€ BinanceApiWsClient.ts
â”‚   â””â”€â”€ BinanceUserDataStream.ts
â”œâ”€â”€ models/               # TypeScript interfaces
â”‚   â””â”€â”€ strategy/
â”‚       â””â”€â”€ ClickStrategyConfig.ts
â”œâ”€â”€ helpers/              # Utility functions
â””â”€â”€ server.ts             # Express server entry
```

---

## API Endpoints

### Instance Management

| Route | Method | Description |
|-------|--------|-------------|
| `/api/instance/list` | GET | List all instances |
| `/api/instance/:key` | GET | Get instance details |
| `/api/instance/start` | POST | Start instance |
| `/api/instance/stop` | POST | Stop instance |

### Strategy Control

| Route | Method | Description |
|-------|--------|-------------|
| `/api/strategy/start` | POST | Start Click Strategy |
| `/api/strategy/stop` | POST | Stop Click Strategy |
| `/api/strategy/:instanceKey/:symbol` | GET | Get strategy lifecycle |
| `/api/strategy/:instanceKey/:symbol/monitoring` | GET | Get monitoring indicators |
| `/api/strategy/:instanceKey/:symbol/sigma` | PATCH | Update sigma |
| `/api/strategy/:instanceKey/:symbol/takeProfit` | PATCH | Update take profit |

### Market Data

| Route | Method | Description |
|-------|--------|-------------|
| `/api/market/prices` | GET | All cached market prices |
| `/api/market/price/:symbol` | GET | Single symbol price |
| `/api/market/symbols` | GET | List tradeable symbols |
| `/api/market/symbol/:symbol/info` | GET | Get symbol precision/filters |

### Account

| Route | Method | Description |
|-------|--------|-------------|
| `/api/account/:instanceKey` | GET | Get account info |
| `/api/account/:instanceKey/positions` | GET | Get positions |
| `/api/account/:instanceKey/orders` | GET | Get open orders |

### System Status

| Route | Method | Description |
|-------|--------|-------------|
| `/api/status/metrics` | GET | System metrics |
| `/api/status/memory` | GET | Memory usage |
| `/api/status/cpu` | GET | CPU usage |

See Swagger UI at `http://localhost:3055/api-docs` for full documentation.

---

## Strategy Engine Logic Reference

For complete technical documentation of the Click Strategy Engine, see:

ğŸ“– [**Strategy Engine Logic**](./Docs/StrategyEngineLogic.md)

This comprehensive document includes:

| Section | Description |
|---------|-------------|
| Service Architecture | Layered, event-driven system design |
| Monitoring Loop | Hybrid PnL strategy (Push + Pull) |
| Click Event Processing | Threshold formulas and state machine |
| Inversion Processing | GTX vs Stop-Limit mutual exclusion |
| TrendCalculatorService | Pre-entry AI direction analysis |
| Market Order Close | Post-inversion with Wait Trends mode |

---

## System Settings

Default settings managed in `system_settings` table:

| Key | Default | Description |
|-----|---------|-------------|
| `strategy_click_debounce_ms` | 500 | Min time between CLICKs |
| `strategy_inversion_order_timeout_ms` | 1300 | GTX inversion timeout |
| `strategy_initial_order_timeout_ms` | 30000 | Initial order timeout |
| `strategy_max_inversion_retries` | 5 | Max inversion retries |
| `stop_limit_initial_order_timeout_ms` | 1000 | Stop-limit timeout |
| `market_data_default_symbols` | JSON | Symbols to stream at startup |

---

## WebSocket Events

### Server â†’ Client

| Event | Description |
|-------|-------------|
| `positions:snapshot` | All positions for instance |
| `position:update` | Single position update |
| `orders:snapshot` | All orders for instance |
| `strategy:status` | Strategy state changes |
| `click:event` | Click triggered |
| `inversion:event` | Inversion triggered |
| `monitoring:indicators` | Real-time PnL indicators |

### Client â†’ Server

| Event | Description |
|-------|-------------|
| `subscribe:instance` | Subscribe to instance updates |
| `unsubscribe:instance` | Unsubscribe from instance |

---

## Troubleshooting

### npm install fails with gyp errors

This is related to `better-sqlite3` native compilation. See [Windows Build Dependencies](#windows-build-dependencies-for-better-sqlite3) section above.

### Connection timeout errors

Check your Binance API credentials and network connectivity.

### Strategy not starting

1. Verify symbol exists and is tradeable
2. Check account has sufficient balance
3. Confirm leverage is set correctly

### Position updates delayed

1. Verify User Data Stream is connected
2. Check for WebSocket reconnection in logs
3. Verify ACCOUNT_UPDATE events are being received

---

## Database Schema

Key tables:

| Table | Description |
|-------|-------------|
| `positions` | Current position state |
| `orders` | Order history |
| `strategy_sessions` | Strategy session records |
| `strategy_history` | Click/inversion event log |
| `system_settings` | Configuration key-value store |

---

## Related Documentation

- ğŸ“– [**Position Service UI**](../Ark.Alliance.Trading.Bot.PositionService.Ui/README.md) - React frontend
- ğŸ“– [**Main Project**](../README.md) - Overall architecture

---

## License

Proprietary - Ark Alliance

---

**Version:** 2.0.0  
**Last Updated:** 2025-12-24  
**Status:** âœ… Production Ready
