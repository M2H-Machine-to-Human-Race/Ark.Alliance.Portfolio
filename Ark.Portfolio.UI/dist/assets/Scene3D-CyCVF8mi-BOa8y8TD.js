import{j as V}from"./markdown-D8NX56fe.js";import{r as x,K as Sn}from"./react-vendor-DabIWvu9.js";import{bC as En,bD as xn,bE as Mn,bF as Tn,bG as de,bH as wt,bI as Kt,bJ as Bt,bK as we,bL as _n,bM as Qt,bN as Rn,bO as Ue,bP as An,bQ as Un,bR as Pn,bS as Cn,bT as On,bU as zn,bV as Dn,bW as Bn,bX as In,bY as Fn,bZ as De,b_ as Me,b$ as Gr,c0 as je,c1 as mt,c2 as vt,c3 as dr,c4 as _r,c5 as Ut,c6 as re,c7 as Vt,c8 as Be,c9 as Vr,ca as Xt,cb as Nn,cc as kn,cd as Xe,ce as Se,cf as Ln,cg as Hn,ch as Yr,ci as jn,cj as Wt,ck as yt,cl as gr,cm as Ot,cn as Xr,co as Wr,cp as nt,cq as Gn,cr as Vn,cs as fr,ct as Zt,cu as Yn,cv as Xn,cw as qt,cx as Wn,cy as At,cz as Rr,cA as Lt,cB as Zn,cC as at,cD as J,cE as Zr,cF as $r,cG as $n,cH as Kn,cI as Ar,cJ as Qn,cK as Kr,cL as Yt,cM as gt,cN as zt,cO as qn,cP as Jn,cQ as es,cR as $t,cS as st,cT as Ur,cU as Qr,cV as ts,cW as rs,cX as ns,cY as ss,cZ as as,c_ as is,c$ as os}from"./index-sJJkRNmh.js";import"./mermaid-CVR_yEWu.js";import"./katex-XbL3y5x-.js";function Pr(e,t){let r;return(...a)=>{window.clearTimeout(r),r=window.setTimeout(()=>e(...a),t)}}function ls({debounce:e,scroll:t,polyfill:r,offsetSize:a}={debounce:0,scroll:!1,offsetSize:!1}){const i=r||(typeof window>"u"?class{}:window.ResizeObserver);if(!i)throw new Error("This browser does not support ResizeObserver out of the box. See: https://github.com/react-spring/react-use-measure/#resize-observer-polyfills");const[o,l]=x.useState({left:0,top:0,width:0,height:0,bottom:0,right:0,x:0,y:0}),u=x.useRef({element:null,scrollContainers:null,resizeObserver:null,lastBounds:o,orientationHandler:null}),f=e?typeof e=="number"?e:e.scroll:null,d=e?typeof e=="number"?e:e.resize:null,w=x.useRef(!1);x.useEffect(()=>(w.current=!0,()=>{w.current=!1}));const[S,M,E]=x.useMemo(()=>{const C=()=>{if(!u.current.element)return;const{left:P,top:g,width:B,height:_,bottom:O,right:j,x:k,y:R}=u.current.element.getBoundingClientRect(),X={left:P,top:g,width:B,height:_,bottom:O,right:j,x:k,y:R};u.current.element instanceof HTMLElement&&a&&(X.height=u.current.element.offsetHeight,X.width=u.current.element.offsetWidth),Object.freeze(X),w.current&&!ds(u.current.lastBounds,X)&&l(u.current.lastBounds=X)};return[C,d?Pr(C,d):C,f?Pr(C,f):C]},[l,a,f,d]);function N(){u.current.scrollContainers&&(u.current.scrollContainers.forEach(C=>C.removeEventListener("scroll",E,!0)),u.current.scrollContainers=null),u.current.resizeObserver&&(u.current.resizeObserver.disconnect(),u.current.resizeObserver=null),u.current.orientationHandler&&("orientation"in screen&&"removeEventListener"in screen.orientation?screen.orientation.removeEventListener("change",u.current.orientationHandler):"onorientationchange"in window&&window.removeEventListener("orientationchange",u.current.orientationHandler))}function L(){u.current.element&&(u.current.resizeObserver=new i(E),u.current.resizeObserver.observe(u.current.element),t&&u.current.scrollContainers&&u.current.scrollContainers.forEach(C=>C.addEventListener("scroll",E,{capture:!0,passive:!0})),u.current.orientationHandler=()=>{E()},"orientation"in screen&&"addEventListener"in screen.orientation?screen.orientation.addEventListener("change",u.current.orientationHandler):"onorientationchange"in window&&window.addEventListener("orientationchange",u.current.orientationHandler))}const y=C=>{!C||C===u.current.element||(N(),u.current.element=C,u.current.scrollContainers=qr(C),L())};return us(E,!!t),cs(M),x.useEffect(()=>{N(),L()},[t,E,M]),x.useEffect(()=>N,[]),[y,o,S]}function cs(e){x.useEffect(()=>{const t=e;return window.addEventListener("resize",t),()=>{window.removeEventListener("resize",t)}},[e])}function us(e,t){x.useEffect(()=>{if(t){const r=e;return window.addEventListener("scroll",r,{capture:!0,passive:!0}),()=>{window.removeEventListener("scroll",r,!0)}}},[e,t])}function qr(e){const t=[];if(!e||e===document.body)return t;const{overflow:r,overflowX:a,overflowY:i}=window.getComputedStyle(e);return[r,a,i].some(o=>o==="auto"||o==="scroll")&&t.push(e),[...t,...qr(e.parentElement)]}const hs=["x","y","top","bottom","left","right","width","height"],ds=(e,t)=>hs.every(r=>e[r]===t[r]);function fs({ref:e,children:t,fallback:r,resize:a,style:i,gl:o,events:l=zn,eventSource:u,eventPrefix:f,shadows:d,linear:w,flat:S,legacy:M,orthographic:E,frameloop:N,dpr:L,performance:y,raycaster:C,camera:P,scene:g,onPointerMissed:B,onCreated:_,...O}){x.useMemo(()=>Qt(os),[]);const j=Un(),[k,R]=ls({scroll:!0,debounce:{scroll:50,resize:0},...a}),X=x.useRef(null),ee=x.useRef(null);x.useImperativeHandle(e,()=>X.current);const Q=Pn(B),[Ee,ne]=x.useState(!1),[le,Ce]=x.useState(!1);if(Ee)throw Ee;if(le)throw le;const _e=x.useRef(null);return Cn(()=>{const Oe=X.current;if(R.width>0&&R.height>0&&Oe){_e.current||(_e.current=On(Oe));async function Ie(){await _e.current.configure({gl:o,scene:g,events:l,shadows:d,linear:w,flat:S,legacy:M,orthographic:E,frameloop:N,dpr:L,performance:y,raycaster:C,camera:P,size:R,onPointerMissed:(...fe)=>Q.current==null?void 0:Q.current(...fe),onCreated:fe=>{fe.events.connect==null||fe.events.connect(u?Dn(u)?u.current:u:ee.current),f&&fe.setEvents({compute:(Ge,pe)=>{const Ve=Ge[f+"X"],We=Ge[f+"Y"];pe.pointer.set(Ve/pe.size.width*2-1,-(We/pe.size.height)*2+1),pe.raycaster.setFromCamera(pe.pointer,pe.camera)}}),_?.(fe)}}),_e.current.render(V.jsx(j,{children:V.jsx(Bn,{set:Ce,children:V.jsx(x.Suspense,{fallback:V.jsx(In,{set:ne}),children:t??null})})}))}Ie()}}),x.useEffect(()=>{const Oe=X.current;if(Oe)return()=>Fn(Oe)},[]),V.jsx("div",{ref:ee,style:{position:"relative",width:"100%",height:"100%",overflow:"hidden",pointerEvents:u?"none":"auto",...i},...O,children:V.jsx("div",{ref:k,style:{width:"100%",height:"100%"},children:V.jsx("canvas",{ref:X,style:{display:"block"},children:r})})})}function ps(e){return V.jsx(Tn,{children:V.jsx(fs,{...e})})}var Le=Uint8Array,ht=Uint16Array,pr=Uint32Array,Jr=new Le([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),en=new Le([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),ms=new Le([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),tn=function(e,t){for(var r=new ht(31),a=0;a<31;++a)r[a]=t+=1<<e[a-1];for(var i=new pr(r[30]),a=1;a<30;++a)for(var o=r[a];o<r[a+1];++o)i[o]=o-r[a]<<5|a;return[r,i]},rn=tn(Jr,2),nn=rn[0],vs=rn[1];nn[28]=258,vs[258]=28;var gs=tn(en,0),bs=gs[0],sn=new ht(32768);for(var ce=0;ce<32768;++ce){var tt=(ce&43690)>>>1|(ce&21845)<<1;tt=(tt&52428)>>>2|(tt&13107)<<2,tt=(tt&61680)>>>4|(tt&3855)<<4,sn[ce]=((tt&65280)>>>8|(tt&255)<<8)>>>1}var Pt=(function(e,t,r){for(var a=e.length,i=0,o=new ht(t);i<a;++i)++o[e[i]-1];var l=new ht(t);for(i=0;i<t;++i)l[i]=l[i-1]+o[i-1]<<1;var u;{u=new ht(1<<t);var f=15-t;for(i=0;i<a;++i)if(e[i])for(var d=i<<4|e[i],w=t-e[i],S=l[e[i]-1]++<<w,M=S|(1<<w)-1;S<=M;++S)u[sn[S]>>>f]=d}return u}),It=new Le(288);for(var ce=0;ce<144;++ce)It[ce]=8;for(var ce=144;ce<256;++ce)It[ce]=9;for(var ce=256;ce<280;++ce)It[ce]=7;for(var ce=280;ce<288;++ce)It[ce]=8;var an=new Le(32);for(var ce=0;ce<32;++ce)an[ce]=5;var ws=Pt(It,9),ys=Pt(an,5),lr=function(e){for(var t=e[0],r=1;r<e.length;++r)e[r]>t&&(t=e[r]);return t},He=function(e,t,r){var a=t/8|0;return(e[a]|e[a+1]<<8)>>(t&7)&r},cr=function(e,t){var r=t/8|0;return(e[r]|e[r+1]<<8|e[r+2]<<16)>>(t&7)},Ss=function(e){return(e/8|0)+(e&7&&1)},Es=function(e,t,r){(r==null||r>e.length)&&(r=e.length);var a=new(e instanceof ht?ht:e instanceof pr?pr:Le)(r-t);return a.set(e.subarray(t,r)),a},xs=function(e,t,r){var a=e.length;if(!a||r&&!r.l&&a<5)return t||new Le(0);var i=!t||r,o=!r||r.i;r||(r={}),t||(t=new Le(a*3));var l=function(Ze){var ft=t.length;if(Ze>ft){var pt=new Le(Math.max(ft*2,Ze));pt.set(t),t=pt}},u=r.f||0,f=r.p||0,d=r.b||0,w=r.l,S=r.d,M=r.m,E=r.n,N=a*8;do{if(!w){r.f=u=He(e,f,1);var L=He(e,f+1,3);if(f+=3,L)if(L==1)w=ws,S=ys,M=9,E=5;else if(L==2){var y=He(e,f,31)+257,C=He(e,f+10,15)+4,P=y+He(e,f+5,31)+1;f+=14;for(var g=new Le(P),B=new Le(19),_=0;_<C;++_)B[ms[_]]=He(e,f+_*3,7);f+=C*3;for(var O=lr(B),j=(1<<O)-1,k=Pt(B,O),_=0;_<P;){var R=k[He(e,f,j)];f+=R&15;var X=R>>>4;if(X<16)g[_++]=X;else{var ee=0,Q=0;for(X==16?(Q=3+He(e,f,3),f+=2,ee=g[_-1]):X==17?(Q=3+He(e,f,7),f+=3):X==18&&(Q=11+He(e,f,127),f+=7);Q--;)g[_++]=ee}}var Ee=g.subarray(0,y),ne=g.subarray(y);M=lr(Ee),E=lr(ne),w=Pt(Ee,M),S=Pt(ne,E)}else throw"invalid block type";else{var X=Ss(f)+4,le=e[X-4]|e[X-3]<<8,Ce=X+le;if(Ce>a){if(o)throw"unexpected EOF";break}i&&l(d+le),t.set(e.subarray(X,Ce),d),r.b=d+=le,r.p=f=Ce*8;continue}if(f>N){if(o)throw"unexpected EOF";break}}i&&l(d+131072);for(var _e=(1<<M)-1,Oe=(1<<E)-1,Ie=f;;Ie=f){var ee=w[cr(e,f)&_e],fe=ee>>>4;if(f+=ee&15,f>N){if(o)throw"unexpected EOF";break}if(!ee)throw"invalid length/literal";if(fe<256)t[d++]=fe;else if(fe==256){Ie=f,w=null;break}else{var Ge=fe-254;if(fe>264){var _=fe-257,pe=Jr[_];Ge=He(e,f,(1<<pe)-1)+nn[_],f+=pe}var Ve=S[cr(e,f)&Oe],We=Ve>>>4;if(!Ve)throw"invalid distance";f+=Ve&15;var ne=bs[We];if(We>3){var pe=en[We];ne+=cr(e,f)&(1<<pe)-1,f+=pe}if(f>N){if(o)throw"unexpected EOF";break}i&&l(d+131072);for(var Qe=d+Ge;d<Qe;d+=4)t[d]=t[d-ne],t[d+1]=t[d+1-ne],t[d+2]=t[d+2-ne],t[d+3]=t[d+3-ne];d=Qe}}r.l=w,r.p=Ie,r.b=d,w&&(u=1,r.m=M,r.d=S,r.n=E)}while(!u);return d==t.length?t:Es(t,0,d)},Ms=new Le(0),Ts=function(e){if((e[0]&15)!=8||e[0]>>>4>7||(e[0]<<8|e[1])%31)throw"invalid zlib data";if(e[1]&32)throw"invalid zlib data: preset dictionaries not supported"};function Ht(e,t){return xs((Ts(e),e.subarray(2,-4)),t)}var _s=typeof TextDecoder<"u"&&new TextDecoder,Rs=0;try{_s.decode(Ms,{stream:!0}),Rs=1}catch{}const As=e=>e&&e.isCubeTexture;class Us extends qt{constructor(t,r){var a,i;const o=As(t),l=((i=o?(a=t.image[0])==null?void 0:a.width:t.image.width)!=null?i:1024)/4,u=Math.floor(Math.log2(l)),f=Math.pow(2,u),d=3*Math.max(f,112),w=4*f,S=[o?"#define ENVMAP_TYPE_CUBE":"",`#define CUBEUV_TEXEL_WIDTH ${1/d}`,`#define CUBEUV_TEXEL_HEIGHT ${1/w}`,`#define CUBEUV_MAX_MIP ${u}.0`],M=`
        varying vec3 vWorldPosition;
        void main() 
        {
            vec4 worldPosition = ( modelMatrix * vec4( position, 1.0 ) );
            vWorldPosition = worldPosition.xyz;
            
            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }
        `,E=S.join(`
`)+`
        #define ENVMAP_TYPE_CUBE_UV
        varying vec3 vWorldPosition;
        uniform float radius;
        uniform float height;
        uniform float angle;
        #ifdef ENVMAP_TYPE_CUBE
            uniform samplerCube map;
        #else
            uniform sampler2D map;
        #endif
        // From: https://www.shadertoy.com/view/4tsBD7
        float diskIntersectWithBackFaceCulling( vec3 ro, vec3 rd, vec3 c, vec3 n, float r ) 
        {
            float d = dot ( rd, n );
            
            if( d > 0.0 ) { return 1e6; }
            
            vec3  o = ro - c;
            float t = - dot( n, o ) / d;
            vec3  q = o + rd * t;
            
            return ( dot( q, q ) < r * r ) ? t : 1e6;
        }
        // From: https://www.iquilezles.org/www/articles/intersectors/intersectors.htm
        float sphereIntersect( vec3 ro, vec3 rd, vec3 ce, float ra ) 
        {
            vec3 oc = ro - ce;
            float b = dot( oc, rd );
            float c = dot( oc, oc ) - ra * ra;
            float h = b * b - c;
            
            if( h < 0.0 ) { return -1.0; }
            
            h = sqrt( h );
            
            return - b + h;
        }
        vec3 project() 
        {
            vec3 p = normalize( vWorldPosition );
            vec3 camPos = cameraPosition;
            camPos.y -= height;
            float intersection = sphereIntersect( camPos, p, vec3( 0.0 ), radius );
            if( intersection > 0.0 ) {
                
                vec3 h = vec3( 0.0, - height, 0.0 );
                float intersection2 = diskIntersectWithBackFaceCulling( camPos, p, h, vec3( 0.0, 1.0, 0.0 ), radius );
                p = ( camPos + min( intersection, intersection2 ) * p ) / radius;
            } else {
                p = vec3( 0.0, 1.0, 0.0 );
            }
            return p;
        }
        #include <common>
        #include <cube_uv_reflection_fragment>
        void main() 
        {
            vec3 projectedWorldPosition = project();
            
            #ifdef ENVMAP_TYPE_CUBE
                vec3 outcolor = textureCube( map, projectedWorldPosition ).rgb;
            #else
                vec3 direction = normalize( projectedWorldPosition );
                vec2 uv = equirectUv( direction );
                vec3 outcolor = texture2D( map, uv ).rgb;
            #endif
            gl_FragColor = vec4( outcolor, 1.0 );
            #include <tonemapping_fragment>
            #include <${$r>=154?"colorspace_fragment":"encodings_fragment"}>
        }
        `,N={map:{value:t},height:{value:r?.height||15},radius:{value:r?.radius||100}},L=new Wn(1,16),y=new Be({uniforms:N,fragmentShader:E,vertexShader:M,side:At});super(L,y)}set radius(t){this.material.uniforms.radius.value=t}get radius(){return this.material.uniforms.radius.value}set height(t){this.material.uniforms.height.value=t}get height(){return this.material.uniforms.height.value}}var Ps=Object.defineProperty,Cs=(e,t,r)=>t in e?Ps(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Os=(e,t,r)=>(Cs(e,t+"",r),r);class zs{constructor(){Os(this,"_listeners")}addEventListener(t,r){this._listeners===void 0&&(this._listeners={});const a=this._listeners;a[t]===void 0&&(a[t]=[]),a[t].indexOf(r)===-1&&a[t].push(r)}hasEventListener(t,r){if(this._listeners===void 0)return!1;const a=this._listeners;return a[t]!==void 0&&a[t].indexOf(r)!==-1}removeEventListener(t,r){if(this._listeners===void 0)return;const a=this._listeners[t];if(a!==void 0){const i=a.indexOf(r);i!==-1&&a.splice(i,1)}}dispatchEvent(t){if(this._listeners===void 0)return;const r=this._listeners[t.type];if(r!==void 0){t.target=this;const a=r.slice(0);for(let i=0,o=a.length;i<o;i++)a[i].call(this,t);t.target=null}}}var Ds=Object.defineProperty,Bs=(e,t,r)=>t in e?Ds(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Y=(e,t,r)=>(Bs(e,typeof t!="symbol"?t+"":t,r),r);const jt=new Gn,Cr=new Vn,Is=Math.cos(70*(Math.PI/180)),Or=(e,t)=>(e%t+t)%t;let Fs=class extends zs{constructor(e,t){super(),Y(this,"object"),Y(this,"domElement"),Y(this,"enabled",!0),Y(this,"target",new we),Y(this,"minDistance",0),Y(this,"maxDistance",1/0),Y(this,"minZoom",0),Y(this,"maxZoom",1/0),Y(this,"minPolarAngle",0),Y(this,"maxPolarAngle",Math.PI),Y(this,"minAzimuthAngle",-1/0),Y(this,"maxAzimuthAngle",1/0),Y(this,"enableDamping",!1),Y(this,"dampingFactor",.05),Y(this,"enableZoom",!0),Y(this,"zoomSpeed",1),Y(this,"enableRotate",!0),Y(this,"rotateSpeed",1),Y(this,"enablePan",!0),Y(this,"panSpeed",1),Y(this,"screenSpacePanning",!0),Y(this,"keyPanSpeed",7),Y(this,"zoomToCursor",!1),Y(this,"autoRotate",!1),Y(this,"autoRotateSpeed",2),Y(this,"reverseOrbit",!1),Y(this,"reverseHorizontalOrbit",!1),Y(this,"reverseVerticalOrbit",!1),Y(this,"keys",{LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"}),Y(this,"mouseButtons",{LEFT:mt.ROTATE,MIDDLE:mt.DOLLY,RIGHT:mt.PAN}),Y(this,"touches",{ONE:vt.ROTATE,TWO:vt.DOLLY_PAN}),Y(this,"target0"),Y(this,"position0"),Y(this,"zoom0"),Y(this,"_domElementKeyEvents",null),Y(this,"getPolarAngle"),Y(this,"getAzimuthalAngle"),Y(this,"setPolarAngle"),Y(this,"setAzimuthalAngle"),Y(this,"getDistance"),Y(this,"getZoomScale"),Y(this,"listenToKeyEvents"),Y(this,"stopListenToKeyEvents"),Y(this,"saveState"),Y(this,"reset"),Y(this,"update"),Y(this,"connect"),Y(this,"dispose"),Y(this,"dollyIn"),Y(this,"dollyOut"),Y(this,"getScale"),Y(this,"setScale"),this.object=e,this.domElement=t,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=()=>d.phi,this.getAzimuthalAngle=()=>d.theta,this.setPolarAngle=h=>{let z=Or(h,2*Math.PI),n=d.phi;n<0&&(n+=2*Math.PI),z<0&&(z+=2*Math.PI);let s=Math.abs(z-n);2*Math.PI-s<s&&(z<n?z+=2*Math.PI:n+=2*Math.PI),w.phi=z-n,r.update()},this.setAzimuthalAngle=h=>{let z=Or(h,2*Math.PI),n=d.theta;n<0&&(n+=2*Math.PI),z<0&&(z+=2*Math.PI);let s=Math.abs(z-n);2*Math.PI-s<s&&(z<n?z+=2*Math.PI:n+=2*Math.PI),w.theta=z-n,r.update()},this.getDistance=()=>r.object.position.distanceTo(r.target),this.listenToKeyEvents=h=>{h.addEventListener("keydown",xt),this._domElementKeyEvents=h},this.stopListenToKeyEvents=()=>{this._domElementKeyEvents.removeEventListener("keydown",xt),this._domElementKeyEvents=null},this.saveState=()=>{r.target0.copy(r.target),r.position0.copy(r.object.position),r.zoom0=r.object.zoom},this.reset=()=>{r.target.copy(r.target0),r.object.position.copy(r.position0),r.object.zoom=r.zoom0,r.object.updateProjectionMatrix(),r.dispatchEvent(a),r.update(),u=l.NONE},this.update=(()=>{const h=new we,z=new we(0,1,0),n=new _r().setFromUnitVectors(e.up,z),s=n.clone().invert(),c=new we,p=new _r,v=2*Math.PI;return function(){const m=r.object.position;n.setFromUnitVectors(e.up,z),s.copy(n).invert(),h.copy(m).sub(r.target),h.applyQuaternion(n),d.setFromVector3(h),r.autoRotate&&u===l.NONE&&Ee(ee()),r.enableDamping?(d.theta+=w.theta*r.dampingFactor,d.phi+=w.phi*r.dampingFactor):(d.theta+=w.theta,d.phi+=w.phi);let T=r.minAzimuthAngle,b=r.maxAzimuthAngle;isFinite(T)&&isFinite(b)&&(T<-Math.PI?T+=v:T>Math.PI&&(T-=v),b<-Math.PI?b+=v:b>Math.PI&&(b-=v),T<=b?d.theta=Math.max(T,Math.min(b,d.theta)):d.theta=d.theta>(T+b)/2?Math.max(T,d.theta):Math.min(b,d.theta)),d.phi=Math.max(r.minPolarAngle,Math.min(r.maxPolarAngle,d.phi)),d.makeSafe(),r.enableDamping===!0?r.target.addScaledVector(M,r.dampingFactor):r.target.add(M),r.zoomToCursor&&k||r.object.isOrthographicCamera?d.radius=pe(d.radius):d.radius=pe(d.radius*S),h.setFromSpherical(d),h.applyQuaternion(s),m.copy(r.target).add(h),r.object.matrixAutoUpdate||r.object.updateMatrix(),r.object.lookAt(r.target),r.enableDamping===!0?(w.theta*=1-r.dampingFactor,w.phi*=1-r.dampingFactor,M.multiplyScalar(1-r.dampingFactor)):(w.set(0,0,0),M.set(0,0,0));let I=!1;if(r.zoomToCursor&&k){let A=null;if(r.object instanceof Vt&&r.object.isPerspectiveCamera){const D=h.length();A=pe(D*S);const U=D-A;r.object.position.addScaledVector(O,U),r.object.updateMatrixWorld()}else if(r.object.isOrthographicCamera){const D=new we(j.x,j.y,0);D.unproject(r.object),r.object.zoom=Math.max(r.minZoom,Math.min(r.maxZoom,r.object.zoom/S)),r.object.updateProjectionMatrix(),I=!0;const U=new we(j.x,j.y,0);U.unproject(r.object),r.object.position.sub(U).add(D),r.object.updateMatrixWorld(),A=h.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),r.zoomToCursor=!1;A!==null&&(r.screenSpacePanning?r.target.set(0,0,-1).transformDirection(r.object.matrix).multiplyScalar(A).add(r.object.position):(jt.origin.copy(r.object.position),jt.direction.set(0,0,-1).transformDirection(r.object.matrix),Math.abs(r.object.up.dot(jt.direction))<Is?e.lookAt(r.target):(Cr.setFromNormalAndCoplanarPoint(r.object.up,r.target),jt.intersectPlane(Cr,r.target))))}else r.object instanceof Ut&&r.object.isOrthographicCamera&&(I=S!==1,I&&(r.object.zoom=Math.max(r.minZoom,Math.min(r.maxZoom,r.object.zoom/S)),r.object.updateProjectionMatrix()));return S=1,k=!1,I||c.distanceToSquared(r.object.position)>f||8*(1-p.dot(r.object.quaternion))>f?(r.dispatchEvent(a),c.copy(r.object.position),p.copy(r.object.quaternion),I=!1,!0):!1}})(),this.connect=h=>{r.domElement=h,r.domElement.style.touchAction="none",r.domElement.addEventListener("contextmenu",lt),r.domElement.addEventListener("pointerdown",Nt),r.domElement.addEventListener("pointercancel",ot),r.domElement.addEventListener("wheel",kt)},this.dispose=()=>{var h,z,n,s,c,p;r.domElement&&(r.domElement.style.touchAction="auto"),(h=r.domElement)==null||h.removeEventListener("contextmenu",lt),(z=r.domElement)==null||z.removeEventListener("pointerdown",Nt),(n=r.domElement)==null||n.removeEventListener("pointercancel",ot),(s=r.domElement)==null||s.removeEventListener("wheel",kt),(c=r.domElement)==null||c.ownerDocument.removeEventListener("pointermove",Et),(p=r.domElement)==null||p.ownerDocument.removeEventListener("pointerup",ot),r._domElementKeyEvents!==null&&r._domElementKeyEvents.removeEventListener("keydown",xt)};const r=this,a={type:"change"},i={type:"start"},o={type:"end"},l={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let u=l.NONE;const f=1e-6,d=new dr,w=new dr;let S=1;const M=new we,E=new re,N=new re,L=new re,y=new re,C=new re,P=new re,g=new re,B=new re,_=new re,O=new we,j=new re;let k=!1;const R=[],X={};function ee(){return 2*Math.PI/60/60*r.autoRotateSpeed}function Q(){return Math.pow(.95,r.zoomSpeed)}function Ee(h){r.reverseOrbit||r.reverseHorizontalOrbit?w.theta+=h:w.theta-=h}function ne(h){r.reverseOrbit||r.reverseVerticalOrbit?w.phi+=h:w.phi-=h}const le=(()=>{const h=new we;return function(z,n){h.setFromMatrixColumn(n,0),h.multiplyScalar(-z),M.add(h)}})(),Ce=(()=>{const h=new we;return function(z,n){r.screenSpacePanning===!0?h.setFromMatrixColumn(n,1):(h.setFromMatrixColumn(n,0),h.crossVectors(r.object.up,h)),h.multiplyScalar(z),M.add(h)}})(),_e=(()=>{const h=new we;return function(z,n){const s=r.domElement;if(s&&r.object instanceof Vt&&r.object.isPerspectiveCamera){const c=r.object.position;h.copy(c).sub(r.target);let p=h.length();p*=Math.tan(r.object.fov/2*Math.PI/180),le(2*z*p/s.clientHeight,r.object.matrix),Ce(2*n*p/s.clientHeight,r.object.matrix)}else s&&r.object instanceof Ut&&r.object.isOrthographicCamera?(le(z*(r.object.right-r.object.left)/r.object.zoom/s.clientWidth,r.object.matrix),Ce(n*(r.object.top-r.object.bottom)/r.object.zoom/s.clientHeight,r.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),r.enablePan=!1)}})();function Oe(h){r.object instanceof Vt&&r.object.isPerspectiveCamera||r.object instanceof Ut&&r.object.isOrthographicCamera?S=h:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),r.enableZoom=!1)}function Ie(h){Oe(S/h)}function fe(h){Oe(S*h)}function Ge(h){if(!r.zoomToCursor||!r.domElement)return;k=!0;const z=r.domElement.getBoundingClientRect(),n=h.clientX-z.left,s=h.clientY-z.top,c=z.width,p=z.height;j.x=n/c*2-1,j.y=-(s/p)*2+1,O.set(j.x,j.y,1).unproject(r.object).sub(r.object.position).normalize()}function pe(h){return Math.max(r.minDistance,Math.min(r.maxDistance,h))}function Ve(h){E.set(h.clientX,h.clientY)}function We(h){Ge(h),g.set(h.clientX,h.clientY)}function Qe(h){y.set(h.clientX,h.clientY)}function Ze(h){N.set(h.clientX,h.clientY),L.subVectors(N,E).multiplyScalar(r.rotateSpeed);const z=r.domElement;z&&(Ee(2*Math.PI*L.x/z.clientHeight),ne(2*Math.PI*L.y/z.clientHeight)),E.copy(N),r.update()}function ft(h){B.set(h.clientX,h.clientY),_.subVectors(B,g),_.y>0?Ie(Q()):_.y<0&&fe(Q()),g.copy(B),r.update()}function pt(h){C.set(h.clientX,h.clientY),P.subVectors(C,y).multiplyScalar(r.panSpeed),_e(P.x,P.y),y.copy(C),r.update()}function er(h){Ge(h),h.deltaY<0?fe(Q()):h.deltaY>0&&Ie(Q()),r.update()}function it(h){let z=!1;switch(h.code){case r.keys.UP:_e(0,r.keyPanSpeed),z=!0;break;case r.keys.BOTTOM:_e(0,-r.keyPanSpeed),z=!0;break;case r.keys.LEFT:_e(r.keyPanSpeed,0),z=!0;break;case r.keys.RIGHT:_e(-r.keyPanSpeed,0),z=!0;break}z&&(h.preventDefault(),r.update())}function ye(){if(R.length==1)E.set(R[0].pageX,R[0].pageY);else{const h=.5*(R[0].pageX+R[1].pageX),z=.5*(R[0].pageY+R[1].pageY);E.set(h,z)}}function St(){if(R.length==1)y.set(R[0].pageX,R[0].pageY);else{const h=.5*(R[0].pageX+R[1].pageX),z=.5*(R[0].pageY+R[1].pageY);y.set(h,z)}}function $e(){const h=R[0].pageX-R[1].pageX,z=R[0].pageY-R[1].pageY,n=Math.sqrt(h*h+z*z);g.set(0,n)}function Ae(){r.enableZoom&&$e(),r.enablePan&&St()}function ge(){r.enableZoom&&$e(),r.enableRotate&&ye()}function Ft(h){if(R.length==1)N.set(h.pageX,h.pageY);else{const n=Z(h),s=.5*(h.pageX+n.x),c=.5*(h.pageY+n.y);N.set(s,c)}L.subVectors(N,E).multiplyScalar(r.rotateSpeed);const z=r.domElement;z&&(Ee(2*Math.PI*L.x/z.clientHeight),ne(2*Math.PI*L.y/z.clientHeight)),E.copy(N)}function F(h){if(R.length==1)C.set(h.pageX,h.pageY);else{const z=Z(h),n=.5*(h.pageX+z.x),s=.5*(h.pageY+z.y);C.set(n,s)}P.subVectors(C,y).multiplyScalar(r.panSpeed),_e(P.x,P.y),y.copy(C)}function qe(h){const z=Z(h),n=h.pageX-z.x,s=h.pageY-z.y,c=Math.sqrt(n*n+s*s);B.set(0,c),_.set(0,Math.pow(B.y/g.y,r.zoomSpeed)),Ie(_.y),g.copy(B)}function tr(h){r.enableZoom&&qe(h),r.enablePan&&F(h)}function rr(h){r.enableZoom&&qe(h),r.enableRotate&&Ft(h)}function Nt(h){var z,n;r.enabled!==!1&&(R.length===0&&((z=r.domElement)==null||z.ownerDocument.addEventListener("pointermove",Et),(n=r.domElement)==null||n.ownerDocument.addEventListener("pointerup",ot)),or(h),h.pointerType==="touch"?ar(h):nr(h))}function Et(h){r.enabled!==!1&&(h.pointerType==="touch"?ir(h):sr(h))}function ot(h){var z,n,s;ct(h),R.length===0&&((z=r.domElement)==null||z.releasePointerCapture(h.pointerId),(n=r.domElement)==null||n.ownerDocument.removeEventListener("pointermove",Et),(s=r.domElement)==null||s.ownerDocument.removeEventListener("pointerup",ot)),r.dispatchEvent(o),u=l.NONE}function nr(h){let z;switch(h.button){case 0:z=r.mouseButtons.LEFT;break;case 1:z=r.mouseButtons.MIDDLE;break;case 2:z=r.mouseButtons.RIGHT;break;default:z=-1}switch(z){case mt.DOLLY:if(r.enableZoom===!1)return;We(h),u=l.DOLLY;break;case mt.ROTATE:if(h.ctrlKey||h.metaKey||h.shiftKey){if(r.enablePan===!1)return;Qe(h),u=l.PAN}else{if(r.enableRotate===!1)return;Ve(h),u=l.ROTATE}break;case mt.PAN:if(h.ctrlKey||h.metaKey||h.shiftKey){if(r.enableRotate===!1)return;Ve(h),u=l.ROTATE}else{if(r.enablePan===!1)return;Qe(h),u=l.PAN}break;default:u=l.NONE}u!==l.NONE&&r.dispatchEvent(i)}function sr(h){if(r.enabled!==!1)switch(u){case l.ROTATE:if(r.enableRotate===!1)return;Ze(h);break;case l.DOLLY:if(r.enableZoom===!1)return;ft(h);break;case l.PAN:if(r.enablePan===!1)return;pt(h);break}}function kt(h){r.enabled===!1||r.enableZoom===!1||u!==l.NONE&&u!==l.ROTATE||(h.preventDefault(),r.dispatchEvent(i),er(h),r.dispatchEvent(o))}function xt(h){r.enabled===!1||r.enablePan===!1||it(h)}function ar(h){switch(Je(h),R.length){case 1:switch(r.touches.ONE){case vt.ROTATE:if(r.enableRotate===!1)return;ye(),u=l.TOUCH_ROTATE;break;case vt.PAN:if(r.enablePan===!1)return;St(),u=l.TOUCH_PAN;break;default:u=l.NONE}break;case 2:switch(r.touches.TWO){case vt.DOLLY_PAN:if(r.enableZoom===!1&&r.enablePan===!1)return;Ae(),u=l.TOUCH_DOLLY_PAN;break;case vt.DOLLY_ROTATE:if(r.enableZoom===!1&&r.enableRotate===!1)return;ge(),u=l.TOUCH_DOLLY_ROTATE;break;default:u=l.NONE}break;default:u=l.NONE}u!==l.NONE&&r.dispatchEvent(i)}function ir(h){switch(Je(h),u){case l.TOUCH_ROTATE:if(r.enableRotate===!1)return;Ft(h),r.update();break;case l.TOUCH_PAN:if(r.enablePan===!1)return;F(h),r.update();break;case l.TOUCH_DOLLY_PAN:if(r.enableZoom===!1&&r.enablePan===!1)return;tr(h),r.update();break;case l.TOUCH_DOLLY_ROTATE:if(r.enableZoom===!1&&r.enableRotate===!1)return;rr(h),r.update();break;default:u=l.NONE}}function lt(h){r.enabled!==!1&&h.preventDefault()}function or(h){R.push(h)}function ct(h){delete X[h.pointerId];for(let z=0;z<R.length;z++)if(R[z].pointerId==h.pointerId){R.splice(z,1);return}}function Je(h){let z=X[h.pointerId];z===void 0&&(z=new re,X[h.pointerId]=z),z.set(h.pageX,h.pageY)}function Z(h){const z=h.pointerId===R[0].pointerId?R[1]:R[0];return X[z.pointerId]}this.dollyIn=(h=Q())=>{fe(h),r.update()},this.dollyOut=(h=Q())=>{Ie(h),r.update()},this.getScale=()=>S,this.setScale=h=>{Oe(h),r.update()},this.getZoomScale=()=>Q(),t!==void 0&&this.connect(t),this.update()}};class Ns extends Kr{constructor(t){super(t),this.type=Ue}parse(t){const r=function(y,C){switch(y){case 1:throw new Error("THREE.RGBELoader: Read Error: "+(C||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+(C||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+(C||""));default:case 4:throw new Error("THREE.RGBELoader: Memory Error: "+(C||""))}},a=function(y,C,P){C=C||1024;let g=y.pos,B=-1,_=0,O="",j=String.fromCharCode.apply(null,new Uint16Array(y.subarray(g,g+128)));for(;0>(B=j.indexOf(`
`))&&_<C&&g<y.byteLength;)O+=j,_+=j.length,g+=128,j+=String.fromCharCode.apply(null,new Uint16Array(y.subarray(g,g+128)));return-1<B?(y.pos+=_+B+1,O+j.slice(0,B)):!1},i=function(y){const C=/^#\?(\S+)/,P=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,g=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,B=/^\s*FORMAT=(\S+)\s*$/,_=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,O={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let j,k;for((y.pos>=y.byteLength||!(j=a(y)))&&r(1,"no header found"),(k=j.match(C))||r(3,"bad initial token"),O.valid|=1,O.programtype=k[1],O.string+=j+`
`;j=a(y),j!==!1;){if(O.string+=j+`
`,j.charAt(0)==="#"){O.comments+=j+`
`;continue}if((k=j.match(P))&&(O.gamma=parseFloat(k[1])),(k=j.match(g))&&(O.exposure=parseFloat(k[1])),(k=j.match(B))&&(O.valid|=2,O.format=k[1]),(k=j.match(_))&&(O.valid|=4,O.height=parseInt(k[1],10),O.width=parseInt(k[2],10)),O.valid&2&&O.valid&4)break}return O.valid&2||r(3,"missing format specifier"),O.valid&4||r(3,"missing image size specifier"),O},o=function(y,C,P){const g=C;if(g<8||g>32767||y[0]!==2||y[1]!==2||y[2]&128)return new Uint8Array(y);g!==(y[2]<<8|y[3])&&r(3,"wrong scanline width");const B=new Uint8Array(4*C*P);B.length||r(4,"unable to allocate buffer space");let _=0,O=0;const j=4*g,k=new Uint8Array(4),R=new Uint8Array(j);let X=P;for(;X>0&&O<y.byteLength;){O+4>y.byteLength&&r(1),k[0]=y[O++],k[1]=y[O++],k[2]=y[O++],k[3]=y[O++],(k[0]!=2||k[1]!=2||(k[2]<<8|k[3])!=g)&&r(3,"bad rgbe scanline format");let ee=0,Q;for(;ee<j&&O<y.byteLength;){Q=y[O++];const ne=Q>128;if(ne&&(Q-=128),(Q===0||ee+Q>j)&&r(3,"bad scanline data"),ne){const le=y[O++];for(let Ce=0;Ce<Q;Ce++)R[ee++]=le}else R.set(y.subarray(O,O+Q),ee),ee+=Q,O+=Q}const Ee=g;for(let ne=0;ne<Ee;ne++){let le=0;B[_]=R[ne+le],le+=g,B[_+1]=R[ne+le],le+=g,B[_+2]=R[ne+le],le+=g,B[_+3]=R[ne+le],_+=4}X--}return B},l=function(y,C,P,g){const B=y[C+3],_=Math.pow(2,B-128)/255;P[g+0]=y[C+0]*_,P[g+1]=y[C+1]*_,P[g+2]=y[C+2]*_,P[g+3]=1},u=function(y,C,P,g){const B=y[C+3],_=Math.pow(2,B-128)/255;P[g+0]=gt.toHalfFloat(Math.min(y[C+0]*_,65504)),P[g+1]=gt.toHalfFloat(Math.min(y[C+1]*_,65504)),P[g+2]=gt.toHalfFloat(Math.min(y[C+2]*_,65504)),P[g+3]=gt.toHalfFloat(1)},f=new Uint8Array(t);f.pos=0;const d=i(f),w=d.width,S=d.height,M=o(f.subarray(f.pos),w,S);let E,N,L;switch(this.type){case je:L=M.length/4;const y=new Float32Array(L*4);for(let P=0;P<L;P++)l(M,P*4,y,P*4);E=y,N=je;break;case Ue:L=M.length/4;const C=new Uint16Array(L*4);for(let P=0;P<L;P++)u(M,P*4,C,P*4);E=C,N=Ue;break;default:throw new Error("THREE.RGBELoader: Unsupported type: "+this.type)}return{width:w,height:S,data:E,header:d.string,gamma:d.gamma,exposure:d.exposure,type:N}}setDataType(t){return this.type=t,this}load(t,r,a,i){function o(l,u){switch(l.type){case je:case Ue:"colorSpace"in l?l.colorSpace="srgb-linear":l.encoding=3e3,l.minFilter=Me,l.magFilter=Me,l.generateMipmaps=!1,l.flipY=!0;break}r&&r(l,u)}return super.load(t,o,a,i)}}const Tt=$r>=152;class ks extends Kr{constructor(t){super(t),this.type=Ue}parse(t){const r=Math.pow(2.7182818,2.2);function a(n,s){for(var c=0,p=0;p<65536;++p)(p==0||n[p>>3]&1<<(p&7))&&(s[c++]=p);for(var v=c-1;c<65536;)s[c++]=0;return v}function i(n){for(var s=0;s<16384;s++)n[s]={},n[s].len=0,n[s].lit=0,n[s].p=null}const o={l:0,c:0,lc:0};function l(n,s,c,p,v){for(;c<n;)s=s<<8|St(p,v),c+=8;c-=n,o.l=s>>c&(1<<n)-1,o.c=s,o.lc=c}const u=new Array(59);function f(n){for(var s=0;s<=58;++s)u[s]=0;for(var s=0;s<65537;++s)u[n[s]]+=1;for(var c=0,s=58;s>0;--s){var p=c+u[s]>>1;u[s]=c,c=p}for(var s=0;s<65537;++s){var v=n[s];v>0&&(n[s]=v|u[v]++<<6)}}function d(n,s,c,p,v,m,T){for(var b=c,I=0,A=0;v<=m;v++){if(b.value-c.value>p)return!1;l(6,I,A,n,b);var D=o.l;if(I=o.c,A=o.lc,T[v]=D,D==63){if(b.value-c.value>p)throw"Something wrong with hufUnpackEncTable";l(8,I,A,n,b);var U=o.l+6;if(I=o.c,A=o.lc,v+U>m+1)throw"Something wrong with hufUnpackEncTable";for(;U--;)T[v++]=0;v--}else if(D>=59){var U=D-59+2;if(v+U>m+1)throw"Something wrong with hufUnpackEncTable";for(;U--;)T[v++]=0;v--}}f(T)}function w(n){return n&63}function S(n){return n>>6}function M(n,s,c,p){for(;s<=c;s++){var v=S(n[s]),m=w(n[s]);if(v>>m)throw"Invalid table entry";if(m>14){var T=p[v>>m-14];if(T.len)throw"Invalid table entry";if(T.lit++,T.p){var b=T.p;T.p=new Array(T.lit);for(var I=0;I<T.lit-1;++I)T.p[I]=b[I]}else T.p=new Array(1);T.p[T.lit-1]=s}else if(m)for(var A=0,I=1<<14-m;I>0;I--){var T=p[(v<<14-m)+A];if(T.len||T.p)throw"Invalid table entry";T.len=m,T.lit=s,A++}}return!0}const E={c:0,lc:0};function N(n,s,c,p){n=n<<8|St(c,p),s+=8,E.c=n,E.lc=s}const L={c:0,lc:0};function y(n,s,c,p,v,m,T,b,I,A){if(n==s){p<8&&(N(c,p,v,T),c=E.c,p=E.lc),p-=8;var D=c>>p,D=new Uint8Array([D])[0];if(I.value+D>A)return!1;for(var U=b[I.value-1];D-- >0;)b[I.value++]=U}else if(I.value<A)b[I.value++]=n;else return!1;L.c=c,L.lc=p}function C(n){return n&65535}function P(n){var s=C(n);return s>32767?s-65536:s}const g={a:0,b:0};function B(n,s){var c=P(n),p=P(s),v=p,m=c+(v&1)+(v>>1),T=m,b=m-v;g.a=T,g.b=b}function _(n,s){var c=C(n),p=C(s),v=c-(p>>1)&65535,m=p+v-32768&65535;g.a=m,g.b=v}function O(n,s,c,p,v,m,T){for(var b=T<16384,I=c>v?v:c,A=1,D;A<=I;)A<<=1;for(A>>=1,D=A,A>>=1;A>=1;){for(var U=0,ie=U+m*(v-D),H=m*A,G=m*D,W=p*A,$=p*D,se,me,oe,xe;U<=ie;U+=G){for(var ae=U,Ye=U+p*(c-D);ae<=Ye;ae+=$){var Re=ae+W,be=ae+H,Ke=be+W;b?(B(n[ae+s],n[be+s]),se=g.a,oe=g.b,B(n[Re+s],n[Ke+s]),me=g.a,xe=g.b,B(se,me),n[ae+s]=g.a,n[Re+s]=g.b,B(oe,xe),n[be+s]=g.a,n[Ke+s]=g.b):(_(n[ae+s],n[be+s]),se=g.a,oe=g.b,_(n[Re+s],n[Ke+s]),me=g.a,xe=g.b,_(se,me),n[ae+s]=g.a,n[Re+s]=g.b,_(oe,xe),n[be+s]=g.a,n[Ke+s]=g.b)}if(c&A){var be=ae+H;b?B(n[ae+s],n[be+s]):_(n[ae+s],n[be+s]),se=g.a,n[be+s]=g.b,n[ae+s]=se}}if(v&A)for(var ae=U,Ye=U+p*(c-D);ae<=Ye;ae+=$){var Re=ae+W;b?B(n[ae+s],n[Re+s]):_(n[ae+s],n[Re+s]),se=g.a,n[Re+s]=g.b,n[ae+s]=se}D=A,A>>=1}return U}function j(n,s,c,p,v,m,T,b,I,A){for(var D=0,U=0,ie=b,H=Math.trunc(v.value+(m+7)/8);v.value<H;)for(N(D,U,c,v),D=E.c,U=E.lc;U>=14;){var G=D>>U-14&16383,W=s[G];if(W.len)U-=W.len,y(W.lit,T,D,U,c,p,v,I,A,ie),D=L.c,U=L.lc;else{if(!W.p)throw"hufDecode issues";var $;for($=0;$<W.lit;$++){for(var se=w(n[W.p[$]]);U<se&&v.value<H;)N(D,U,c,v),D=E.c,U=E.lc;if(U>=se&&S(n[W.p[$]])==(D>>U-se&(1<<se)-1)){U-=se,y(W.p[$],T,D,U,c,p,v,I,A,ie),D=L.c,U=L.lc;break}}if($==W.lit)throw"hufDecode issues"}}var me=8-m&7;for(D>>=me,U-=me;U>0;){var W=s[D<<14-U&16383];if(W.len)U-=W.len,y(W.lit,T,D,U,c,p,v,I,A,ie),D=L.c,U=L.lc;else throw"hufDecode issues"}return!0}function k(n,s,c,p,v,m){var T={value:0},b=c.value,I=ye(s,c),A=ye(s,c);c.value+=4;var D=ye(s,c);if(c.value+=4,I<0||I>=65537||A<0||A>=65537)throw"Something wrong with HUF_ENCSIZE";var U=new Array(65537),ie=new Array(16384);i(ie);var H=p-(c.value-b);if(d(n,s,c,H,I,A,U),D>8*(p-(c.value-b)))throw"Something wrong with hufUncompress";M(U,I,A,ie),j(U,ie,n,s,c,D,A,m,v,T)}function R(n,s,c){for(var p=0;p<c;++p)s[p]=n[s[p]]}function X(n){for(var s=1;s<n.length;s++){var c=n[s-1]+n[s]-128;n[s]=c}}function ee(n,s){for(var c=0,p=Math.floor((n.length+1)/2),v=0,m=n.length-1;!(v>m||(s[v++]=n[c++],v>m));)s[v++]=n[p++]}function Q(n){for(var s=n.byteLength,c=new Array,p=0,v=new DataView(n);s>0;){var m=v.getInt8(p++);if(m<0){var T=-m;s-=T+1;for(var b=0;b<T;b++)c.push(v.getUint8(p++))}else{var T=m;s-=2;for(var I=v.getUint8(p++),b=0;b<T+1;b++)c.push(I)}}return c}function Ee(n,s,c,p,v,m){var T=new DataView(m.buffer),b=c[n.idx[0]].width,I=c[n.idx[0]].height,A=3,D=Math.floor(b/8),U=Math.ceil(b/8),ie=Math.ceil(I/8),H=b-(U-1)*8,G=I-(ie-1)*8,W={value:0},$=new Array(A),se=new Array(A),me=new Array(A),oe=new Array(A),xe=new Array(A);for(let ue=0;ue<A;++ue)xe[ue]=s[n.idx[ue]],$[ue]=ue<1?0:$[ue-1]+U*ie,se[ue]=new Float32Array(64),me[ue]=new Uint16Array(64),oe[ue]=new Uint16Array(U*64);for(let ue=0;ue<ie;++ue){var ae=8;ue==ie-1&&(ae=G);var Ye=8;for(let he=0;he<U;++he){he==U-1&&(Ye=H);for(let te=0;te<A;++te)me[te].fill(0),me[te][0]=v[$[te]++],ne(W,p,me[te]),le(me[te],se[te]),Ce(se[te]);_e(se);for(let te=0;te<A;++te)Oe(se[te],oe[te],he*64)}let ve=0;for(let he=0;he<A;++he){const te=c[n.idx[he]].type;for(let Ne=8*ue;Ne<8*ue+ae;++Ne){ve=xe[he][Ne];for(let ut=0;ut<D;++ut){const ze=ut*64+(Ne&7)*8;T.setUint16(ve+0*te,oe[he][ze+0],!0),T.setUint16(ve+2*te,oe[he][ze+1],!0),T.setUint16(ve+4*te,oe[he][ze+2],!0),T.setUint16(ve+6*te,oe[he][ze+3],!0),T.setUint16(ve+8*te,oe[he][ze+4],!0),T.setUint16(ve+10*te,oe[he][ze+5],!0),T.setUint16(ve+12*te,oe[he][ze+6],!0),T.setUint16(ve+14*te,oe[he][ze+7],!0),ve+=16*te}}if(D!=U)for(let Ne=8*ue;Ne<8*ue+ae;++Ne){const ut=xe[he][Ne]+8*D*2*te,ze=D*64+(Ne&7)*8;for(let et=0;et<Ye;++et)T.setUint16(ut+et*2*te,oe[he][ze+et],!0)}}}for(var Re=new Uint16Array(b),T=new DataView(m.buffer),be=0;be<A;++be){c[n.idx[be]].decoded=!0;var Ke=c[n.idx[be]].type;if(c[be].type==2)for(var Mt=0;Mt<I;++Mt){const ve=xe[be][Mt];for(var Fe=0;Fe<b;++Fe)Re[Fe]=T.getUint16(ve+Fe*2*Ke,!0);for(var Fe=0;Fe<b;++Fe)T.setFloat32(ve+Fe*2*Ke,F(Re[Fe]),!0)}}}function ne(n,s,c){for(var p,v=1;v<64;)p=s[n.value],p==65280?v=64:p>>8==255?v+=p&255:(c[v]=p,v++),n.value++}function le(n,s){s[0]=F(n[0]),s[1]=F(n[1]),s[2]=F(n[5]),s[3]=F(n[6]),s[4]=F(n[14]),s[5]=F(n[15]),s[6]=F(n[27]),s[7]=F(n[28]),s[8]=F(n[2]),s[9]=F(n[4]),s[10]=F(n[7]),s[11]=F(n[13]),s[12]=F(n[16]),s[13]=F(n[26]),s[14]=F(n[29]),s[15]=F(n[42]),s[16]=F(n[3]),s[17]=F(n[8]),s[18]=F(n[12]),s[19]=F(n[17]),s[20]=F(n[25]),s[21]=F(n[30]),s[22]=F(n[41]),s[23]=F(n[43]),s[24]=F(n[9]),s[25]=F(n[11]),s[26]=F(n[18]),s[27]=F(n[24]),s[28]=F(n[31]),s[29]=F(n[40]),s[30]=F(n[44]),s[31]=F(n[53]),s[32]=F(n[10]),s[33]=F(n[19]),s[34]=F(n[23]),s[35]=F(n[32]),s[36]=F(n[39]),s[37]=F(n[45]),s[38]=F(n[52]),s[39]=F(n[54]),s[40]=F(n[20]),s[41]=F(n[22]),s[42]=F(n[33]),s[43]=F(n[38]),s[44]=F(n[46]),s[45]=F(n[51]),s[46]=F(n[55]),s[47]=F(n[60]),s[48]=F(n[21]),s[49]=F(n[34]),s[50]=F(n[37]),s[51]=F(n[47]),s[52]=F(n[50]),s[53]=F(n[56]),s[54]=F(n[59]),s[55]=F(n[61]),s[56]=F(n[35]),s[57]=F(n[36]),s[58]=F(n[48]),s[59]=F(n[49]),s[60]=F(n[57]),s[61]=F(n[58]),s[62]=F(n[62]),s[63]=F(n[63])}function Ce(n){const s=.5*Math.cos(.7853975),c=.5*Math.cos(3.14159/16),p=.5*Math.cos(3.14159/8),v=.5*Math.cos(3*3.14159/16),m=.5*Math.cos(5*3.14159/16),T=.5*Math.cos(3*3.14159/8),b=.5*Math.cos(7*3.14159/16);for(var I=new Array(4),A=new Array(4),D=new Array(4),U=new Array(4),ie=0;ie<8;++ie){var H=ie*8;I[0]=p*n[H+2],I[1]=T*n[H+2],I[2]=p*n[H+6],I[3]=T*n[H+6],A[0]=c*n[H+1]+v*n[H+3]+m*n[H+5]+b*n[H+7],A[1]=v*n[H+1]-b*n[H+3]-c*n[H+5]-m*n[H+7],A[2]=m*n[H+1]-c*n[H+3]+b*n[H+5]+v*n[H+7],A[3]=b*n[H+1]-m*n[H+3]+v*n[H+5]-c*n[H+7],D[0]=s*(n[H+0]+n[H+4]),D[3]=s*(n[H+0]-n[H+4]),D[1]=I[0]+I[3],D[2]=I[1]-I[2],U[0]=D[0]+D[1],U[1]=D[3]+D[2],U[2]=D[3]-D[2],U[3]=D[0]-D[1],n[H+0]=U[0]+A[0],n[H+1]=U[1]+A[1],n[H+2]=U[2]+A[2],n[H+3]=U[3]+A[3],n[H+4]=U[3]-A[3],n[H+5]=U[2]-A[2],n[H+6]=U[1]-A[1],n[H+7]=U[0]-A[0]}for(var G=0;G<8;++G)I[0]=p*n[16+G],I[1]=T*n[16+G],I[2]=p*n[48+G],I[3]=T*n[48+G],A[0]=c*n[8+G]+v*n[24+G]+m*n[40+G]+b*n[56+G],A[1]=v*n[8+G]-b*n[24+G]-c*n[40+G]-m*n[56+G],A[2]=m*n[8+G]-c*n[24+G]+b*n[40+G]+v*n[56+G],A[3]=b*n[8+G]-m*n[24+G]+v*n[40+G]-c*n[56+G],D[0]=s*(n[G]+n[32+G]),D[3]=s*(n[G]-n[32+G]),D[1]=I[0]+I[3],D[2]=I[1]-I[2],U[0]=D[0]+D[1],U[1]=D[3]+D[2],U[2]=D[3]-D[2],U[3]=D[0]-D[1],n[0+G]=U[0]+A[0],n[8+G]=U[1]+A[1],n[16+G]=U[2]+A[2],n[24+G]=U[3]+A[3],n[32+G]=U[3]-A[3],n[40+G]=U[2]-A[2],n[48+G]=U[1]-A[1],n[56+G]=U[0]-A[0]}function _e(n){for(var s=0;s<64;++s){var c=n[0][s],p=n[1][s],v=n[2][s];n[0][s]=c+1.5747*v,n[1][s]=c-.1873*p-.4682*v,n[2][s]=c+1.8556*p}}function Oe(n,s,c){for(var p=0;p<64;++p)s[c+p]=gt.toHalfFloat(Ie(n[p]))}function Ie(n){return n<=1?Math.sign(n)*Math.pow(Math.abs(n),2.2):Math.sign(n)*Math.pow(r,Math.abs(n)-1)}function fe(n){return new DataView(n.array.buffer,n.offset.value,n.size)}function Ge(n){var s=n.viewer.buffer.slice(n.offset.value,n.offset.value+n.size),c=new Uint8Array(Q(s)),p=new Uint8Array(c.length);return X(c),ee(c,p),new DataView(p.buffer)}function pe(n){var s=n.array.slice(n.offset.value,n.offset.value+n.size),c=Ht(s),p=new Uint8Array(c.length);return X(c),ee(c,p),new DataView(p.buffer)}function Ve(n){for(var s=n.viewer,c={value:n.offset.value},p=new Uint16Array(n.width*n.scanlineBlockSize*(n.channels*n.type)),v=new Uint8Array(8192),m=0,T=new Array(n.channels),b=0;b<n.channels;b++)T[b]={},T[b].start=m,T[b].end=T[b].start,T[b].nx=n.width,T[b].ny=n.lines,T[b].size=n.type,m+=T[b].nx*T[b].ny*T[b].size;var I=qe(s,c),A=qe(s,c);if(A>=8192)throw"Something is wrong with PIZ_COMPRESSION BITMAP_SIZE";if(I<=A)for(var b=0;b<A-I+1;b++)v[b+I]=$e(s,c);var D=new Uint16Array(65536),U=a(v,D),ie=ye(s,c);k(n.array,s,c,ie,p,m);for(var b=0;b<n.channels;++b)for(var H=T[b],G=0;G<T[b].size;++G)O(p,H.start+G,H.nx,H.size,H.ny,H.nx*H.size,U);R(D,p,m);for(var W=0,$=new Uint8Array(p.buffer.byteLength),se=0;se<n.lines;se++)for(var me=0;me<n.channels;me++){var H=T[me],oe=H.nx*H.size,xe=new Uint8Array(p.buffer,H.end*2,oe*2);$.set(xe,W),W+=oe*2,H.end+=oe}return new DataView($.buffer)}function We(n){var s=n.array.slice(n.offset.value,n.offset.value+n.size),c=Ht(s);const p=n.lines*n.channels*n.width,v=n.type==1?new Uint16Array(p):new Uint32Array(p);let m=0,T=0;const b=new Array(4);for(let I=0;I<n.lines;I++)for(let A=0;A<n.channels;A++){let D=0;switch(n.type){case 1:b[0]=m,b[1]=b[0]+n.width,m=b[1]+n.width;for(let U=0;U<n.width;++U){const ie=c[b[0]++]<<8|c[b[1]++];D+=ie,v[T]=D,T++}break;case 2:b[0]=m,b[1]=b[0]+n.width,b[2]=b[1]+n.width,m=b[2]+n.width;for(let U=0;U<n.width;++U){const ie=c[b[0]++]<<24|c[b[1]++]<<16|c[b[2]++]<<8;D+=ie,v[T]=D,T++}break}}return new DataView(v.buffer)}function Qe(n){var s=n.viewer,c={value:n.offset.value},p=new Uint8Array(n.width*n.lines*(n.channels*n.type*2)),v={version:Ae(s,c),unknownUncompressedSize:Ae(s,c),unknownCompressedSize:Ae(s,c),acCompressedSize:Ae(s,c),dcCompressedSize:Ae(s,c),rleCompressedSize:Ae(s,c),rleUncompressedSize:Ae(s,c),rleRawSize:Ae(s,c),totalAcUncompressedCount:Ae(s,c),totalDcUncompressedCount:Ae(s,c),acCompression:Ae(s,c)};if(v.version<2)throw"EXRLoader.parse: "+Je.compression+" version "+v.version+" is unsupported";for(var m=new Array,T=qe(s,c)-2;T>0;){var b=Ze(s.buffer,c),I=$e(s,c),A=I>>2&3,D=(I>>4)-1,U=new Int8Array([D])[0],ie=$e(s,c);m.push({name:b,index:U,type:ie,compression:A}),T-=b.length+3}for(var H=Je.channels,G=new Array(n.channels),W=0;W<n.channels;++W){var $=G[W]={},se=H[W];$.name=se.name,$.compression=0,$.decoded=!1,$.type=se.pixelType,$.pLinear=se.pLinear,$.width=n.width,$.height=n.lines}for(var me={idx:new Array(3)},oe=0;oe<n.channels;++oe)for(var $=G[oe],W=0;W<m.length;++W){var xe=m[W];$.name==xe.name&&($.compression=xe.compression,xe.index>=0&&(me.idx[xe.index]=oe),$.offset=oe)}if(v.acCompressedSize>0)switch(v.acCompression){case 0:var Re=new Uint16Array(v.totalAcUncompressedCount);k(n.array,s,c,v.acCompressedSize,Re,v.totalAcUncompressedCount);break;case 1:var ae=n.array.slice(c.value,c.value+v.totalAcUncompressedCount),Ye=Ht(ae),Re=new Uint16Array(Ye.buffer);c.value+=v.totalAcUncompressedCount;break}if(v.dcCompressedSize>0){var be={array:n.array,offset:c,size:v.dcCompressedSize},Ke=new Uint16Array(pe(be).buffer);c.value+=v.dcCompressedSize}if(v.rleRawSize>0){var ae=n.array.slice(c.value,c.value+v.rleCompressedSize),Ye=Ht(ae),Mt=Q(Ye.buffer);c.value+=v.rleCompressedSize}for(var Fe=0,ue=new Array(G.length),W=0;W<ue.length;++W)ue[W]=new Array;for(var ve=0;ve<n.lines;++ve)for(var he=0;he<G.length;++he)ue[he].push(Fe),Fe+=G[he].width*n.type*2;Ee(me,ue,G,Re,Ke,p);for(var W=0;W<G.length;++W){var $=G[W];if(!$.decoded)switch($.compression){case 2:for(var te=0,Ne=0,ve=0;ve<n.lines;++ve){for(var ut=ue[W][te],ze=0;ze<$.width;++ze){for(var et=0;et<2*$.type;++et)p[ut++]=Mt[Ne+et*$.width*$.height];Ne++}te++}break;default:throw"EXRLoader.parse: unsupported channel compression"}}return new DataView(p.buffer)}function Ze(n,s){for(var c=new Uint8Array(n),p=0;c[s.value+p]!=0;)p+=1;var v=new TextDecoder().decode(c.slice(s.value,s.value+p));return s.value=s.value+p+1,v}function ft(n,s,c){var p=new TextDecoder().decode(new Uint8Array(n).slice(s.value,s.value+c));return s.value=s.value+c,p}function pt(n,s){var c=it(n,s),p=ye(n,s);return[c,p]}function er(n,s){var c=ye(n,s),p=ye(n,s);return[c,p]}function it(n,s){var c=n.getInt32(s.value,!0);return s.value=s.value+4,c}function ye(n,s){var c=n.getUint32(s.value,!0);return s.value=s.value+4,c}function St(n,s){var c=n[s.value];return s.value=s.value+1,c}function $e(n,s){var c=n.getUint8(s.value);return s.value=s.value+1,c}const Ae=function(n,s){let c;return"getBigInt64"in DataView.prototype?c=Number(n.getBigInt64(s.value,!0)):c=n.getUint32(s.value+4,!0)+Number(n.getUint32(s.value,!0)<<32),s.value+=8,c};function ge(n,s){var c=n.getFloat32(s.value,!0);return s.value+=4,c}function Ft(n,s){return gt.toHalfFloat(ge(n,s))}function F(n){var s=(n&31744)>>10,c=n&1023;return(n>>15?-1:1)*(s?s===31?c?NaN:1/0:Math.pow(2,s-15)*(1+c/1024):6103515625e-14*(c/1024))}function qe(n,s){var c=n.getUint16(s.value,!0);return s.value+=2,c}function tr(n,s){return F(qe(n,s))}function rr(n,s,c,p){for(var v=c.value,m=[];c.value<v+p-1;){var T=Ze(s,c),b=it(n,c),I=$e(n,c);c.value+=3;var A=it(n,c),D=it(n,c);m.push({name:T,pixelType:b,pLinear:I,xSampling:A,ySampling:D})}return c.value+=1,m}function Nt(n,s){var c=ge(n,s),p=ge(n,s),v=ge(n,s),m=ge(n,s),T=ge(n,s),b=ge(n,s),I=ge(n,s),A=ge(n,s);return{redX:c,redY:p,greenX:v,greenY:m,blueX:T,blueY:b,whiteX:I,whiteY:A}}function Et(n,s){var c=["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"],p=$e(n,s);return c[p]}function ot(n,s){var c=ye(n,s),p=ye(n,s),v=ye(n,s),m=ye(n,s);return{xMin:c,yMin:p,xMax:v,yMax:m}}function nr(n,s){var c=["INCREASING_Y"],p=$e(n,s);return c[p]}function sr(n,s){var c=ge(n,s),p=ge(n,s);return[c,p]}function kt(n,s){var c=ge(n,s),p=ge(n,s),v=ge(n,s);return[c,p,v]}function xt(n,s,c,p,v){if(p==="string"||p==="stringvector"||p==="iccProfile")return ft(s,c,v);if(p==="chlist")return rr(n,s,c,v);if(p==="chromaticities")return Nt(n,c);if(p==="compression")return Et(n,c);if(p==="box2i")return ot(n,c);if(p==="lineOrder")return nr(n,c);if(p==="float")return ge(n,c);if(p==="v2f")return sr(n,c);if(p==="v3f")return kt(n,c);if(p==="int")return it(n,c);if(p==="rational")return pt(n,c);if(p==="timecode")return er(n,c);if(p==="preview")return c.value+=v,"skipped";c.value+=v}function ar(n,s,c){const p={};if(n.getUint32(0,!0)!=20000630)throw"THREE.EXRLoader: provided file doesn't appear to be in OpenEXR format.";p.version=n.getUint8(4);const v=n.getUint8(5);p.spec={singleTile:!!(v&2),longName:!!(v&4),deepFormat:!!(v&8),multiPart:!!(v&16)},c.value=8;for(var m=!0;m;){var T=Ze(s,c);if(T==0)m=!1;else{var b=Ze(s,c),I=ye(n,c),A=xt(n,s,c,b,I);A===void 0?console.warn(`EXRLoader.parse: skipped unknown header attribute type '${b}'.`):p[T]=A}}if((v&-5)!=0)throw console.error("EXRHeader:",p),"THREE.EXRLoader: provided file is currently unsupported.";return p}function ir(n,s,c,p,v){const m={size:0,viewer:s,array:c,offset:p,width:n.dataWindow.xMax-n.dataWindow.xMin+1,height:n.dataWindow.yMax-n.dataWindow.yMin+1,channels:n.channels.length,bytesPerLine:null,lines:null,inputSize:null,type:n.channels[0].pixelType,uncompress:null,getter:null,format:null,[Tt?"colorSpace":"encoding"]:null};switch(n.compression){case"NO_COMPRESSION":m.lines=1,m.uncompress=fe;break;case"RLE_COMPRESSION":m.lines=1,m.uncompress=Ge;break;case"ZIPS_COMPRESSION":m.lines=1,m.uncompress=pe;break;case"ZIP_COMPRESSION":m.lines=16,m.uncompress=pe;break;case"PIZ_COMPRESSION":m.lines=32,m.uncompress=Ve;break;case"PXR24_COMPRESSION":m.lines=16,m.uncompress=We;break;case"DWAA_COMPRESSION":m.lines=32,m.uncompress=Qe;break;case"DWAB_COMPRESSION":m.lines=256,m.uncompress=Qe;break;default:throw"EXRLoader.parse: "+n.compression+" is unsupported"}if(m.scanlineBlockSize=m.lines,m.type==1)switch(v){case je:m.getter=tr,m.inputSize=2;break;case Ue:m.getter=qe,m.inputSize=2;break}else if(m.type==2)switch(v){case je:m.getter=ge,m.inputSize=4;break;case Ue:m.getter=Ft,m.inputSize=4}else throw"EXRLoader.parse: unsupported pixelType "+m.type+" for "+n.compression+".";m.blockCount=(n.dataWindow.yMax+1)/m.scanlineBlockSize;for(var T=0;T<m.blockCount;T++)Ae(s,p);m.outputChannels=m.channels==3?4:m.channels;const b=m.width*m.height*m.outputChannels;switch(v){case je:m.byteArray=new Float32Array(b),m.channels<m.outputChannels&&m.byteArray.fill(1,0,b);break;case Ue:m.byteArray=new Uint16Array(b),m.channels<m.outputChannels&&m.byteArray.fill(15360,0,b);break;default:console.error("THREE.EXRLoader: unsupported type: ",v);break}return m.bytesPerLine=m.width*m.inputSize*m.channels,m.outputChannels==4?m.format=zt:m.format=qn,Tt?m.colorSpace="srgb-linear":m.encoding=3e3,m}const lt=new DataView(t),or=new Uint8Array(t),ct={value:0},Je=ar(lt,t,ct),Z=ir(Je,lt,or,ct,this.type),h={value:0},z={R:0,G:1,B:2,A:3,Y:0};for(let n=0;n<Z.height/Z.scanlineBlockSize;n++){const s=ye(lt,ct);Z.size=ye(lt,ct),Z.lines=s+Z.scanlineBlockSize>Z.height?Z.height-s:Z.scanlineBlockSize;const c=Z.size<Z.lines*Z.bytesPerLine?Z.uncompress(Z):fe(Z);ct.value+=Z.size;for(let p=0;p<Z.scanlineBlockSize;p++){const v=p+n*Z.scanlineBlockSize;if(v>=Z.height)break;for(let m=0;m<Z.channels;m++){const T=z[Je.channels[m].name];for(let b=0;b<Z.width;b++){h.value=(p*(Z.channels*Z.width)+m*Z.width+b)*Z.inputSize;const I=(Z.height-1-v)*(Z.width*Z.outputChannels)+b*Z.outputChannels+T;Z.byteArray[I]=Z.getter(c,h)}}}}return{header:Je,width:Z.width,height:Z.height,data:Z.byteArray,format:Z.format,[Tt?"colorSpace":"encoding"]:Z[Tt?"colorSpace":"encoding"],type:this.type}}setDataType(t){return this.type=t,this}load(t,r,a,i){function o(l,u){Tt?l.colorSpace=u.colorSpace:l.encoding=u.encoding,l.minFilter=Me,l.magFilter=Me,l.generateMipmaps=!1,l.flipY=!1,r&&r(l,u)}return super.load(t,o,a,i)}}function Ls(e,t,r){const a=de(E=>E.size),i=de(E=>E.viewport),o=typeof e=="number"?e:a.width*i.dpr,l=a.height*i.dpr,u=(typeof e=="number"?r:e)||{},{samples:f=0,depth:d,...w}=u,S=d??u.depthBuffer,M=x.useMemo(()=>{const E=new De(o,l,{minFilter:Me,magFilter:Me,type:Ue,...w});return S&&(E.depthTexture=new Gr(o,l,je)),E.samples=f,E},[]);return x.useLayoutEffect(()=>{M.setSize(o,l),f&&(M.samples=f)},[f,M,o,l]),x.useEffect(()=>()=>M.dispose(),[]),M}const Hs=e=>typeof e=="function",js=x.forwardRef(({envMap:e,resolution:t=256,frames:r=1/0,makeDefault:a,children:i,...o},l)=>{const u=de(({set:y})=>y),f=de(({camera:y})=>y),d=de(({size:y})=>y),w=x.useRef(null);x.useImperativeHandle(l,()=>w.current,[]);const S=x.useRef(null),M=Ls(t);x.useLayoutEffect(()=>{o.manual||(w.current.aspect=d.width/d.height)},[d,o]),x.useLayoutEffect(()=>{w.current.updateProjectionMatrix()});let E=0,N=null;const L=Hs(i);return wt(y=>{L&&(r===1/0||E<r)&&(S.current.visible=!1,y.gl.setRenderTarget(M),N=y.scene.background,e&&(y.scene.background=e),y.gl.render(y.scene,w.current),y.scene.background=N,y.gl.setRenderTarget(null),S.current.visible=!0,E++)}),x.useLayoutEffect(()=>{if(a){const y=f;return u(()=>({camera:w.current})),()=>u(()=>({camera:y}))}},[w,a,u]),x.createElement(x.Fragment,null,x.createElement("perspectiveCamera",Kt({ref:w},o),!L&&i),x.createElement("group",{ref:S},L&&i(M.texture)))}),Gs=x.forwardRef(({makeDefault:e,camera:t,regress:r,domElement:a,enableDamping:i=!0,keyEvents:o=!1,onChange:l,onStart:u,onEnd:f,...d},w)=>{const S=de(O=>O.invalidate),M=de(O=>O.camera),E=de(O=>O.gl),N=de(O=>O.events),L=de(O=>O.setEvents),y=de(O=>O.set),C=de(O=>O.get),P=de(O=>O.performance),g=t||M,B=a||N.connected||E.domElement,_=x.useMemo(()=>new Fs(g),[g]);return wt(()=>{_.enabled&&_.update()},-1),x.useEffect(()=>(o&&_.connect(o===!0?B:o),_.connect(B),()=>{_.dispose()}),[o,B,r,_,S]),x.useEffect(()=>{const O=R=>{S(),r&&P.regress(),l&&l(R)},j=R=>{u&&u(R)},k=R=>{f&&f(R)};return _.addEventListener("change",O),_.addEventListener("start",j),_.addEventListener("end",k),()=>{_.removeEventListener("start",j),_.removeEventListener("end",k),_.removeEventListener("change",O)}},[l,u,f,_,S,L]),x.useEffect(()=>{if(e){const O=C().controls;return y({controls:_}),()=>y({controls:O})}},[e,_]),x.createElement("primitive",Kt({ref:w,object:_,enableDamping:i},d))}),on=(e,t,r)=>{let a;switch(e){case Xe:a=new Uint8ClampedArray(t*r*4);break;case Ue:a=new Uint16Array(t*r*4);break;case Yr:a=new Uint32Array(t*r*4);break;case is:a=new Int8Array(t*r*4);break;case as:a=new Int16Array(t*r*4);break;case ss:a=new Int32Array(t*r*4);break;case je:a=new Float32Array(t*r*4);break;default:throw new Error("Unsupported data type")}return a};let Gt;const Vs=(e,t,r,a)=>{if(Gt!==void 0)return Gt;const i=new De(1,1,a);t.setRenderTarget(i);const o=new qt(new Qr,new ns({color:16777215}));t.render(o,r),t.setRenderTarget(null);const l=on(e,i.width,i.height);return t.readRenderTargetPixels(i,0,0,i.width,i.height,l),i.dispose(),o.geometry.dispose(),o.material.dispose(),Gt=l[0]!==0,Gt};class br{_renderer;_rendererIsDisposable=!1;_material;_scene;_camera;_quad;_renderTarget;_width;_height;_type;_colorSpace;_supportsReadPixels=!0;constructor(t){this._width=t.width,this._height=t.height,this._type=t.type,this._colorSpace=t.colorSpace;const r={format:zt,depthBuffer:!1,stencilBuffer:!1,type:this._type,colorSpace:this._colorSpace,anisotropy:t.renderTargetOptions?.anisotropy!==void 0?t.renderTargetOptions?.anisotropy:1,generateMipmaps:t.renderTargetOptions?.generateMipmaps!==void 0?t.renderTargetOptions?.generateMipmaps:!1,magFilter:t.renderTargetOptions?.magFilter!==void 0?t.renderTargetOptions?.magFilter:Me,minFilter:t.renderTargetOptions?.minFilter!==void 0?t.renderTargetOptions?.minFilter:Me,samples:t.renderTargetOptions?.samples!==void 0?t.renderTargetOptions?.samples:void 0,wrapS:t.renderTargetOptions?.wrapS!==void 0?t.renderTargetOptions?.wrapS:st,wrapT:t.renderTargetOptions?.wrapT!==void 0?t.renderTargetOptions?.wrapT:st};if(this._material=t.material,t.renderer?this._renderer=t.renderer:(this._renderer=br.instantiateRenderer(),this._rendererIsDisposable=!0),this._scene=new Xt,this._camera=new Ut,this._camera.position.set(0,0,10),this._camera.left=-.5,this._camera.right=.5,this._camera.top=.5,this._camera.bottom=-.5,this._camera.updateProjectionMatrix(),!Vs(this._type,this._renderer,this._camera,r)){let a;this._type===Ue&&(a=this._renderer.extensions.has("EXT_color_buffer_float")?je:void 0),a!==void 0?(console.warn(`This browser does not support reading pixels from ${this._type} RenderTargets, switching to ${je}`),this._type=a):(this._supportsReadPixels=!1,console.warn("This browser dos not support toArray or toDataTexture, calls to those methods will result in an error thrown"))}this._quad=new qt(new Qr,this._material),this._quad.geometry.computeBoundingBox(),this._scene.add(this._quad),this._renderTarget=new De(this.width,this.height,r),this._renderTarget.texture.mapping=t.renderTargetOptions?.mapping!==void 0?t.renderTargetOptions?.mapping:$t}static instantiateRenderer(){const t=new ts;return t.setSize(128,128),t}render=()=>{this._renderer.setRenderTarget(this._renderTarget);try{this._renderer.render(this._scene,this._camera)}catch(t){throw this._renderer.setRenderTarget(null),t}this._renderer.setRenderTarget(null)};toArray(){if(!this._supportsReadPixels)throw new Error("Can't read pixels in this browser");const t=on(this._type,this._width,this._height);return this._renderer.readRenderTargetPixels(this._renderTarget,0,0,this._width,this._height,t),t}toDataTexture(t){const r=new rs(this.toArray(),this.width,this.height,zt,this._type,t?.mapping||$t,t?.wrapS||st,t?.wrapT||st,t?.magFilter||Me,t?.minFilter||Me,t?.anisotropy||1,Ot);return r.generateMipmaps=t?.generateMipmaps!==void 0?t?.generateMipmaps:!1,r}disposeOnDemandRenderer(){this._renderer.setRenderTarget(null),this._rendererIsDisposable&&(this._renderer.dispose(),this._renderer.forceContextLoss())}dispose(t){this.disposeOnDemandRenderer(),t&&this.renderTarget.dispose(),this.material instanceof Be&&Object.values(this.material.uniforms).forEach(r=>{r.value instanceof nt&&r.value.dispose()}),Object.values(this.material).forEach(r=>{r instanceof nt&&r.dispose()}),this.material.dispose(),this._quad.geometry.dispose()}get width(){return this._width}set width(t){this._width=t,this._renderTarget.setSize(this._width,this._height)}get height(){return this._height}set height(t){this._height=t,this._renderTarget.setSize(this._width,this._height)}get renderer(){return this._renderer}get renderTarget(){return this._renderTarget}set renderTarget(t){this._renderTarget=t,this._width=t.width,this._height=t.height}get material(){return this._material}get type(){return this._type}get colorSpace(){return this._colorSpace}}class ln extends Error{}class cn extends Error{}const _t=(e,t,r)=>{const a=new RegExp(`${t}="([^"]*)"`,"i").exec(e);if(a)return a[1];const i=new RegExp(`<${t}[^>]*>([\\s\\S]*?)</${t}>`,"i").exec(e);if(i){const o=i[1].match(/<rdf:li>([^<]*)<\/rdf:li>/g);return o&&o.length===3?o.map(l=>l.replace(/<\/?rdf:li>/g,"")):i[1].trim()}if(r!==void 0)return r;throw new Error(`Can't find ${t} in gainmap metadata`)},Ys=e=>{let t;typeof TextDecoder<"u"?t=new TextDecoder().decode(e):t=e.toString();let r=t.indexOf("<x:xmpmeta");for(;r!==-1;){const a=t.indexOf("x:xmpmeta>",r),i=t.slice(r,a+10);try{const o=_t(i,"hdrgm:GainMapMin","0"),l=_t(i,"hdrgm:GainMapMax"),u=_t(i,"hdrgm:Gamma","1"),f=_t(i,"hdrgm:OffsetSDR","0.015625"),d=_t(i,"hdrgm:OffsetHDR","0.015625"),w=/hdrgm:HDRCapacityMin="([^"]*)"/.exec(i),S=w?w[1]:"0",M=/hdrgm:HDRCapacityMax="([^"]*)"/.exec(i);if(!M)throw new Error("Incomplete gainmap metadata");const E=M[1];return{gainMapMin:Array.isArray(o)?o.map(N=>parseFloat(N)):[parseFloat(o),parseFloat(o),parseFloat(o)],gainMapMax:Array.isArray(l)?l.map(N=>parseFloat(N)):[parseFloat(l),parseFloat(l),parseFloat(l)],gamma:Array.isArray(u)?u.map(N=>parseFloat(N)):[parseFloat(u),parseFloat(u),parseFloat(u)],offsetSdr:Array.isArray(f)?f.map(N=>parseFloat(N)):[parseFloat(f),parseFloat(f),parseFloat(f)],offsetHdr:Array.isArray(d)?d.map(N=>parseFloat(N)):[parseFloat(d),parseFloat(d),parseFloat(d)],hdrCapacityMin:parseFloat(S),hdrCapacityMax:parseFloat(E)}}catch{}r=t.indexOf("<x:xmpmeta",a)}};class Xs{options;constructor(t){this.options={debug:t&&t.debug!==void 0?t.debug:!1,extractFII:t&&t.extractFII!==void 0?t.extractFII:!0,extractNonFII:t&&t.extractNonFII!==void 0?t.extractNonFII:!0}}extract(t){return new Promise((r,a)=>{const i=this.options.debug,o=new DataView(t.buffer);if(o.getUint16(0)!==65496){a(new Error("Not a valid jpeg"));return}const l=o.byteLength;let u=2,f=0,d;for(;u<l;){if(++f>250){a(new Error(`Found no marker after ${f} loops `));return}if(o.getUint8(u)!==255){a(new Error(`Not a valid marker at offset 0x${u.toString(16)}, found: 0x${o.getUint8(u).toString(16)}`));return}if(d=o.getUint8(u+1),i&&console.log(`Marker: ${d.toString(16)}`),d===226){i&&console.log("Found APP2 marker (0xffe2)");const w=u+4;if(o.getUint32(w)===1297106432){const S=w+4;let M;if(o.getUint16(S)===18761)M=!1;else if(o.getUint16(S)===19789)M=!0;else{a(new Error("No valid endianness marker found in TIFF header"));return}if(o.getUint16(S+2,!M)!==42){a(new Error("Not valid TIFF data! (no 0x002A marker)"));return}const E=o.getUint32(S+4,!M);if(E<8){a(new Error("Not valid TIFF data! (First offset less than 8)"));return}const N=S+E,L=o.getUint16(N,!M),y=N+2;let C=0;for(let B=y;B<y+12*L;B+=12)o.getUint16(B,!M)===45057&&(C=o.getUint32(B+8,!M));const P=N+2+L*12+4,g=[];for(let B=P;B<P+C*16;B+=16){const _={MPType:o.getUint32(B,!M),size:o.getUint32(B+4,!M),dataOffset:o.getUint32(B+8,!M),dependantImages:o.getUint32(B+12,!M),start:-1,end:-1,isFII:!1};_.dataOffset?(_.start=S+_.dataOffset,_.isFII=!1):(_.start=0,_.isFII=!0),_.end=_.start+_.size,g.push(_)}if(this.options.extractNonFII&&g.length){const B=new Blob([o]),_=[];for(const O of g){if(O.isFII&&!this.options.extractFII)continue;const j=B.slice(O.start,O.end+1,"image/jpeg");_.push(j)}r(_)}}}u+=2+o.getUint16(u+2)}})}}const Ws=async e=>{const t=Ys(e);if(!t)throw new cn("Gain map XMP metadata not found");const r=await new Xs({extractFII:!0,extractNonFII:!0}).extract(e);if(r.length!==2)throw new ln("Gain map recovery image not found");return{sdr:new Uint8Array(await r[0].arrayBuffer()),gainMap:new Uint8Array(await r[1].arrayBuffer()),metadata:t}},zr=e=>new Promise((t,r)=>{const a=document.createElement("img");a.onload=()=>{t(a)},a.onerror=i=>{r(i)},a.src=URL.createObjectURL(e)});class Zs extends Jn{_renderer;_renderTargetOptions;_internalLoadingManager;_config;constructor(t,r){super(r),this._config=t,t.renderer&&(this._renderer=t.renderer),this._internalLoadingManager=new es}setRenderer(t){return this._renderer=t,this}setRenderTargetOptions(t){return this._renderTargetOptions=t,this}prepareQuadRenderer(){this._renderer||console.warn("WARNING: A Renderer was not passed to this Loader constructor or in setRenderer, the result of this Loader will need to be converted to a Data Texture with toDataTexture() before you can use it in your renderer.");const t=this._config.createMaterial({gainMapMax:[1,1,1],gainMapMin:[0,0,0],gamma:[1,1,1],offsetHdr:[1,1,1],offsetSdr:[1,1,1],hdrCapacityMax:1,hdrCapacityMin:0,maxDisplayBoost:1,gainMap:new nt,sdr:new nt});return this._config.createQuadRenderer({width:16,height:16,type:Ue,colorSpace:Ot,material:t,renderer:this._renderer,renderTargetOptions:this._renderTargetOptions})}async processImages(t,r,a){const i=r?new Blob([r],{type:"image/jpeg"}):void 0,o=new Blob([t],{type:"image/jpeg"});let l,u,f=!1;if(typeof createImageBitmap>"u"){const d=await Promise.all([i?zr(i):Promise.resolve(void 0),zr(o)]);u=d[0],l=d[1],f=a==="flipY"}else{const d=await Promise.all([i?createImageBitmap(i,{imageOrientation:a||"flipY"}):Promise.resolve(void 0),createImageBitmap(o,{imageOrientation:a||"flipY"})]);u=d[0],l=d[1]}return{sdrImage:l,gainMapImage:u,needsFlip:f}}createTextures(t,r,a){const i=new nt(r||new ImageData(2,2),$t,st,st,Me,Ur,zt,Xe,1,Ot);i.flipY=a,i.needsUpdate=!0;const o=new nt(t,$t,st,st,Me,Ur,zt,Xe,1,Se);return o.flipY=a,o.needsUpdate=!0,{gainMap:i,sdr:o}}updateQuadRenderer(t,r,a,i,o){t.width=r.width,t.height=r.height,t.material.gainMap=a,t.material.sdr=i,t.material.gainMapMin=o.gainMapMin,t.material.gainMapMax=o.gainMapMax,t.material.offsetHdr=o.offsetHdr,t.material.offsetSdr=o.offsetSdr,t.material.gamma=o.gamma,t.material.hdrCapacityMin=o.hdrCapacityMin,t.material.hdrCapacityMax=o.hdrCapacityMax,t.material.maxDisplayBoost=Math.pow(2,o.hdrCapacityMax),t.material.needsUpdate=!0}}const $s=`
varying vec2 vUv;

void main() {
  vUv = uv;
  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
`,Ks=`
// min half float value
#define HALF_FLOAT_MIN vec3( -65504, -65504, -65504 )
// max half float value
#define HALF_FLOAT_MAX vec3( 65504, 65504, 65504 )

uniform sampler2D sdr;
uniform sampler2D gainMap;
uniform vec3 gamma;
uniform vec3 offsetHdr;
uniform vec3 offsetSdr;
uniform vec3 gainMapMin;
uniform vec3 gainMapMax;
uniform float weightFactor;

varying vec2 vUv;

void main() {
  vec3 rgb = texture2D( sdr, vUv ).rgb;
  vec3 recovery = texture2D( gainMap, vUv ).rgb;
  vec3 logRecovery = pow( recovery, gamma );
  vec3 logBoost = gainMapMin * ( 1.0 - logRecovery ) + gainMapMax * logRecovery;
  vec3 hdrColor = (rgb + offsetSdr) * exp2( logBoost * weightFactor ) - offsetHdr;
  vec3 clampedHdrColor = max( HALF_FLOAT_MIN, min( HALF_FLOAT_MAX, hdrColor ));
  gl_FragColor = vec4( clampedHdrColor , 1.0 );
}
`;class Qs extends Be{_maxDisplayBoost;_hdrCapacityMin;_hdrCapacityMax;constructor({gamma:t,offsetHdr:r,offsetSdr:a,gainMapMin:i,gainMapMax:o,maxDisplayBoost:l,hdrCapacityMin:u,hdrCapacityMax:f,sdr:d,gainMap:w}){super({name:"GainMapDecoderMaterial",vertexShader:$s,fragmentShader:Ks,uniforms:{sdr:{value:d},gainMap:{value:w},gamma:{value:new we(1/t[0],1/t[1],1/t[2])},offsetHdr:{value:new we().fromArray(r)},offsetSdr:{value:new we().fromArray(a)},gainMapMin:{value:new we().fromArray(i)},gainMapMax:{value:new we().fromArray(o)},weightFactor:{value:(Math.log2(l)-u)/(f-u)}},blending:at,depthTest:!1,depthWrite:!1}),this._maxDisplayBoost=l,this._hdrCapacityMin=u,this._hdrCapacityMax=f,this.needsUpdate=!0,this.uniformsNeedUpdate=!0}get sdr(){return this.uniforms.sdr.value}set sdr(t){this.uniforms.sdr.value=t}get gainMap(){return this.uniforms.gainMap.value}set gainMap(t){this.uniforms.gainMap.value=t}get offsetHdr(){return this.uniforms.offsetHdr.value.toArray()}set offsetHdr(t){this.uniforms.offsetHdr.value.fromArray(t)}get offsetSdr(){return this.uniforms.offsetSdr.value.toArray()}set offsetSdr(t){this.uniforms.offsetSdr.value.fromArray(t)}get gainMapMin(){return this.uniforms.gainMapMin.value.toArray()}set gainMapMin(t){this.uniforms.gainMapMin.value.fromArray(t)}get gainMapMax(){return this.uniforms.gainMapMax.value.toArray()}set gainMapMax(t){this.uniforms.gainMapMax.value.fromArray(t)}get gamma(){const t=this.uniforms.gamma.value;return[1/t.x,1/t.y,1/t.z]}set gamma(t){const r=this.uniforms.gamma.value;r.x=1/t[0],r.y=1/t[1],r.z=1/t[2]}get hdrCapacityMin(){return this._hdrCapacityMin}set hdrCapacityMin(t){this._hdrCapacityMin=t,this.calculateWeight()}get hdrCapacityMax(){return this._hdrCapacityMax}set hdrCapacityMax(t){this._hdrCapacityMax=t,this.calculateWeight()}get maxDisplayBoost(){return this._maxDisplayBoost}set maxDisplayBoost(t){this._maxDisplayBoost=Math.max(1,Math.min(65504,t)),this.calculateWeight()}calculateWeight(){const t=(Math.log2(this._maxDisplayBoost)-this._hdrCapacityMin)/(this._hdrCapacityMax-this._hdrCapacityMin);this.uniforms.weightFactor.value=Math.max(0,Math.min(1,t))}}class un extends Zs{constructor(t,r){super({renderer:t,createMaterial:a=>new Qs(a),createQuadRenderer:a=>new br(a)},r)}async render(t,r,a,i){const{sdrImage:o,gainMapImage:l,needsFlip:u}=await this.processImages(a,i,"flipY"),{gainMap:f,sdr:d}=this.createTextures(o,l,u);this.updateQuadRenderer(t,o,f,d,r),t.render()}}class qs extends un{load([t,r,a],i,o,l){const u=this.prepareQuadRenderer();let f,d,w;const S=async()=>{if(f&&d&&w){try{await this.render(u,w,f,d)}catch(R){this.manager.itemError(t),this.manager.itemError(r),this.manager.itemError(a),typeof l=="function"&&l(R),u.disposeOnDemandRenderer();return}typeof i=="function"&&i(u),this.manager.itemEnd(t),this.manager.itemEnd(r),this.manager.itemEnd(a),u.disposeOnDemandRenderer()}};let M=!0,E=0,N=0,L=!0,y=0,C=0,P=!0,g=0,B=0;const _=()=>{if(typeof o=="function"){const R=E+y+g,X=N+C+B,ee=M&&L&&P;o(new ProgressEvent("progress",{lengthComputable:ee,loaded:X,total:R}))}};this.manager.itemStart(t),this.manager.itemStart(r),this.manager.itemStart(a);const O=new Yt(this._internalLoadingManager);O.setResponseType("arraybuffer"),O.setRequestHeader(this.requestHeader),O.setPath(this.path),O.setWithCredentials(this.withCredentials),O.load(t,async R=>{if(typeof R=="string")throw new Error("Invalid sdr buffer");f=R,await S()},R=>{M=R.lengthComputable,N=R.loaded,E=R.total,_()},R=>{this.manager.itemError(t),typeof l=="function"&&l(R)});const j=new Yt(this._internalLoadingManager);j.setResponseType("arraybuffer"),j.setRequestHeader(this.requestHeader),j.setPath(this.path),j.setWithCredentials(this.withCredentials),j.load(r,async R=>{if(typeof R=="string")throw new Error("Invalid gainmap buffer");d=R,await S()},R=>{L=R.lengthComputable,C=R.loaded,y=R.total,_()},R=>{this.manager.itemError(r),typeof l=="function"&&l(R)});const k=new Yt(this._internalLoadingManager);return k.setRequestHeader(this.requestHeader),k.setPath(this.path),k.setWithCredentials(this.withCredentials),k.load(a,async R=>{if(typeof R!="string")throw new Error("Invalid metadata string");w=JSON.parse(R),await S()},R=>{P=R.lengthComputable,B=R.loaded,g=R.total,_()},R=>{this.manager.itemError(a),typeof l=="function"&&l(R)}),u}}class Js extends un{load(t,r,a,i){const o=this.prepareQuadRenderer(),l=new Yt(this._internalLoadingManager);return l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setPath(this.path),l.setWithCredentials(this.withCredentials),this.manager.itemStart(t),l.load(t,async u=>{if(typeof u=="string")throw new Error("Invalid buffer, received [string], was expecting [ArrayBuffer]");const f=new Uint8Array(u);let d,w,S;try{const M=await Ws(f);d=M.sdr,w=M.gainMap,S=M.metadata}catch(M){if(M instanceof cn||M instanceof ln)console.warn(`Failure to reconstruct an HDR image from ${t}: Gain map metadata not found in the file, HDRJPGLoader will render the SDR jpeg`),S={gainMapMin:[0,0,0],gainMapMax:[1,1,1],gamma:[1,1,1],hdrCapacityMin:0,hdrCapacityMax:1,offsetHdr:[0,0,0],offsetSdr:[0,0,0]},d=f;else throw M}try{await this.render(o,S,d.buffer,w?.buffer)}catch(M){this.manager.itemError(t),typeof i=="function"&&i(M),o.disposeOnDemandRenderer();return}typeof r=="function"&&r(o),this.manager.itemEnd(t),o.disposeOnDemandRenderer()},a,u=>{this.manager.itemError(t),typeof i=="function"&&i(u)}),o}}const Dt={apartment:"lebombo_1k.hdr",city:"potsdamer_platz_1k.hdr",dawn:"kiara_1_dawn_1k.hdr",forest:"forest_slope_1k.hdr",lobby:"st_fagans_interior_1k.hdr",night:"dikhololo_night_1k.hdr",park:"rooitou_park_1k.hdr",studio:"studio_small_03_1k.hdr",sunset:"venice_sunset_1k.hdr",warehouse:"empty_warehouse_01_1k.hdr"},hn="https://raw.githack.com/pmndrs/drei-assets/456060a26bbeb8fdf79326f224b6d99b8bcce736/hdri/",bt=e=>Array.isArray(e),wr=["/px.png","/nx.png","/py.png","/ny.png","/pz.png","/nz.png"];function Jt({files:e=wr,path:t="",preset:r=void 0,colorSpace:a=void 0,extensions:i}={}){r&&(yr(r),e=Dt[r],t=hn);const o=bt(e),{extension:l,isCubemap:u}=Sr(e),f=Er(l);if(!f)throw new Error("useEnvironment: Unrecognized file extension: "+e);const d=de(E=>E.gl);x.useLayoutEffect(()=>{if(l!=="webp"&&l!=="jpg"&&l!=="jpeg")return;function E(){Zt.clear(f,o?[e]:e)}d.domElement.addEventListener("webglcontextlost",E,{once:!0})},[e,d.domElement]);const w=Zt(f,o?[e]:e,E=>{(l==="webp"||l==="jpg"||l==="jpeg")&&E.setRenderer(d),E.setPath==null||E.setPath(t),i&&i(E)});let S=o?w[0]:w;if(l==="jpg"||l==="jpeg"||l==="webp"){var M;S=(M=S.renderTarget)==null?void 0:M.texture}return S.mapping=u?Yn:Xn,S.colorSpace=a??(u?"srgb":"srgb-linear"),S}const ea={files:wr,path:"",preset:void 0,extensions:void 0};Jt.preload=e=>{const t={...ea,...e};let{files:r,path:a=""}=t;const{preset:i,extensions:o}=t;i&&(yr(i),r=Dt[i],a=hn);const{extension:l}=Sr(r);if(l==="webp"||l==="jpg"||l==="jpeg")throw new Error("useEnvironment: Preloading gainmaps is not supported");const u=Er(l);if(!u)throw new Error("useEnvironment: Unrecognized file extension: "+r);Zt.preload(u,bt(r)?[r]:r,f=>{f.setPath==null||f.setPath(a),o&&o(f)})};const ta={files:wr,preset:void 0};Jt.clear=e=>{const t={...ta,...e};let{files:r}=t;const{preset:a}=t;a&&(yr(a),r=Dt[a]);const{extension:i}=Sr(r),o=Er(i);if(!o)throw new Error("useEnvironment: Unrecognized file extension: "+r);Zt.clear(o,bt(r)?[r]:r)};function yr(e){if(!(e in Dt))throw new Error("Preset must be one of: "+Object.keys(Dt).join(", "))}function Sr(e){var t;const r=bt(e)&&e.length===6,a=bt(e)&&e.length===3&&e.some(o=>o.endsWith("json")),i=bt(e)?e[0]:e;return{extension:r?"cube":a?"webp":i.startsWith("data:application/exr")?"exr":i.startsWith("data:application/hdr")?"hdr":i.startsWith("data:image/jpeg")?"jpg":(t=i.split(".").pop())==null||(t=t.split("?"))==null||(t=t.shift())==null?void 0:t.toLowerCase(),isCubemap:r,isGainmap:a}}function Er(e){return e==="cube"?Qn:e==="hdr"?Ns:e==="exr"?ks:e==="jpg"||e==="jpeg"?Js:e==="webp"?qs:null}const ra=e=>e.current&&e.current.isScene,na=e=>ra(e)?e.current:e;function xr(e,t,r,a,i={}){var o,l,u,f;i={backgroundBlurriness:0,backgroundIntensity:1,backgroundRotation:[0,0,0],environmentIntensity:1,environmentRotation:[0,0,0],...i};const d=na(t||r),w=d.background,S=d.environment,M={backgroundBlurriness:d.backgroundBlurriness,backgroundIntensity:d.backgroundIntensity,backgroundRotation:(o=(l=d.backgroundRotation)==null||l.clone==null?void 0:l.clone())!==null&&o!==void 0?o:[0,0,0],environmentIntensity:d.environmentIntensity,environmentRotation:(u=(f=d.environmentRotation)==null||f.clone==null?void 0:f.clone())!==null&&u!==void 0?u:[0,0,0]};return e!=="only"&&(d.environment=a),e&&(d.background=a),Rr(d,i),()=>{e!=="only"&&(d.environment=S),e&&(d.background=w),Rr(d,M)}}function Mr({scene:e,background:t=!1,map:r,...a}){const i=de(o=>o.scene);return x.useLayoutEffect(()=>{if(r)return xr(t,e,i,r,a)}),null}function dn({background:e=!1,scene:t,blur:r,backgroundBlurriness:a,backgroundIntensity:i,backgroundRotation:o,environmentIntensity:l,environmentRotation:u,...f}){const d=Jt(f),w=de(S=>S.scene);return x.useLayoutEffect(()=>xr(e,t,w,d,{backgroundBlurriness:r??a,backgroundIntensity:i,backgroundRotation:o,environmentIntensity:l,environmentRotation:u})),x.useEffect(()=>()=>{d.dispose()},[d]),null}function sa({children:e,near:t=.1,far:r=1e3,resolution:a=256,frames:i=1,map:o,background:l=!1,blur:u,backgroundBlurriness:f,backgroundIntensity:d,backgroundRotation:w,environmentIntensity:S,environmentRotation:M,scene:E,files:N,path:L,preset:y=void 0,extensions:C}){const P=de(k=>k.gl),g=de(k=>k.scene),B=x.useRef(null),[_]=x.useState(()=>new Xt),O=x.useMemo(()=>{const k=new Nn(a);return k.texture.type=Ue,k},[a]);x.useEffect(()=>()=>{O.dispose()},[O]),x.useLayoutEffect(()=>{if(i===1){const k=P.autoClear;P.autoClear=!0,B.current.update(P,_),P.autoClear=k}return xr(l,E,g,O.texture,{backgroundBlurriness:u??f,backgroundIntensity:d,backgroundRotation:w,environmentIntensity:S,environmentRotation:M})},[e,_,O.texture,E,g,l,i,P]);let j=1;return wt(()=>{if(i===1/0||j<i){const k=P.autoClear;P.autoClear=!0,B.current.update(P,_),P.autoClear=k,j++}}),x.createElement(x.Fragment,null,kn(x.createElement(x.Fragment,null,e,x.createElement("cubeCamera",{ref:B,args:[t,r,O]}),N||y?x.createElement(dn,{background:!0,files:N,preset:y,path:L,extensions:C}):o?x.createElement(Mr,{background:!0,map:o,extensions:C}):null),_))}function aa(e){var t,r,a,i;const o=Jt(e),l=e.map||o;x.useMemo(()=>Qt({GroundProjectedEnvImpl:Us}),[]),x.useEffect(()=>()=>{o.dispose()},[o]);const u=x.useMemo(()=>[l],[l]),f=(t=e.ground)==null?void 0:t.height,d=(r=e.ground)==null?void 0:r.radius,w=(a=(i=e.ground)==null?void 0:i.scale)!==null&&a!==void 0?a:1e3;return x.createElement(x.Fragment,null,x.createElement(Mr,Kt({},e,{map:l})),x.createElement("groundProjectedEnvImpl",{args:u,scale:w,height:f,radius:d}))}function ia(e){return e.ground?x.createElement(aa,e):e.map?x.createElement(Mr,e):e.children?x.createElement(sa,e):x.createElement(dn,e)}class oa extends Be{constructor(){super({uniforms:{time:{value:0},fade:{value:1}},vertexShader:`
      uniform float time;
      attribute float size;
      varying vec3 vColor;
      void main() {
        vColor = color;
        vec4 mvPosition = modelViewMatrix * vec4(position, 0.5);
        gl_PointSize = size * (30.0 / -mvPosition.z) * (3.0 + sin(time + 100.0));
        gl_Position = projectionMatrix * mvPosition;
      }`,fragmentShader:`
      uniform sampler2D pointTexture;
      uniform float fade;
      varying vec3 vColor;
      void main() {
        float opacity = 1.0;
        if (fade == 1.0) {
          float d = distance(gl_PointCoord, vec2(0.5, 0.5));
          opacity = 1.0 / (1.0 + exp(16.0 * (d - 0.25)));
        }
        gl_FragColor = vec4(vColor, opacity);

        #include <tonemapping_fragment>
	      #include <${Vr>=154?"colorspace_fragment":"encodings_fragment"}>
      }`})}}const la=e=>new we().setFromSpherical(new dr(e,Math.acos(1-Math.random()*2),Math.random()*2*Math.PI)),ca=x.forwardRef(({radius:e=100,depth:t=50,count:r=5e3,saturation:a=0,factor:i=4,fade:o=!1,speed:l=1},u)=>{const f=x.useRef(null),[d,w,S]=x.useMemo(()=>{const E=[],N=[],L=Array.from({length:r},()=>(.5+.5*Math.random())*i),y=new Bt;let C=e+t;const P=t/r;for(let g=0;g<r;g++)C-=P*Math.random(),E.push(...la(C).toArray()),y.setHSL(g/r,a,.9),N.push(y.r,y.g,y.b);return[new Float32Array(E),new Float32Array(N),new Float32Array(L)]},[r,t,i,e,a]);wt(E=>f.current&&(f.current.uniforms.time.value=E.clock.elapsedTime*l));const[M]=x.useState(()=>new oa);return x.createElement("points",{ref:u},x.createElement("bufferGeometry",null,x.createElement("bufferAttribute",{attach:"attributes-position",args:[d,3]}),x.createElement("bufferAttribute",{attach:"attributes-color",args:[w,3]}),x.createElement("bufferAttribute",{attach:"attributes-size",args:[S,1]})),x.createElement("primitive",{ref:f,object:M,attach:"material",blending:_n,"uniforms-fade-value":o,depthWrite:!1,transparent:!0,vertexColors:!0}))});class ua extends Be{constructor(){super({uniforms:{time:{value:0},pixelRatio:{value:1}},vertexShader:`
        uniform float pixelRatio;
        uniform float time;
        attribute float size;  
        attribute float speed;  
        attribute float opacity;
        attribute vec3 noise;
        attribute vec3 color;
        varying vec3 vColor;
        varying float vOpacity;

        void main() {
          vec4 modelPosition = modelMatrix * vec4(position, 1.0);
          modelPosition.y += sin(time * speed + modelPosition.x * noise.x * 100.0) * 0.2;
          modelPosition.z += cos(time * speed + modelPosition.x * noise.y * 100.0) * 0.2;
          modelPosition.x += cos(time * speed + modelPosition.x * noise.z * 100.0) * 0.2;
          vec4 viewPosition = viewMatrix * modelPosition;
          vec4 projectionPostion = projectionMatrix * viewPosition;
          gl_Position = projectionPostion;
          gl_PointSize = size * 25. * pixelRatio;
          gl_PointSize *= (1.0 / - viewPosition.z);
          vColor = color;
          vOpacity = opacity;
        }
      `,fragmentShader:`
        varying vec3 vColor;
        varying float vOpacity;
        void main() {
          float distanceToCenter = distance(gl_PointCoord, vec2(0.5));
          float strength = 0.05 / distanceToCenter - 0.1;
          gl_FragColor = vec4(vColor, strength * vOpacity);
          #include <tonemapping_fragment>
          #include <${Vr>=154?"colorspace_fragment":"encodings_fragment"}>
        }
      `})}get time(){return this.uniforms.time.value}set time(t){this.uniforms.time.value=t}get pixelRatio(){return this.uniforms.pixelRatio.value}set pixelRatio(t){this.uniforms.pixelRatio.value=t}}const fn=e=>e&&e.constructor===Float32Array,ha=e=>[e.r,e.g,e.b],pn=e=>e instanceof re||e instanceof we||e instanceof fr,mn=e=>Array.isArray(e)?e:pn(e)?e.toArray():[e,e,e];function Rt(e,t,r){return x.useMemo(()=>{if(t!==void 0){if(fn(t))return t;if(t instanceof Bt){const a=Array.from({length:e*3},()=>ha(t)).flat();return Float32Array.from(a)}else if(pn(t)||Array.isArray(t)){const a=Array.from({length:e*3},()=>mn(t)).flat();return Float32Array.from(a)}return Float32Array.from({length:e},()=>t)}return Float32Array.from({length:e},r)},[t])}const da=x.forwardRef(({noise:e=1,count:t=100,speed:r=1,opacity:a=1,scale:i=1,size:o,color:l,children:u,...f},d)=>{x.useMemo(()=>Qt({SparklesImplMaterial:ua}),[]);const w=x.useRef(null),S=de(g=>g.viewport.dpr),M=mn(i),E=x.useMemo(()=>Float32Array.from(Array.from({length:t},()=>M.map(Rn.randFloatSpread)).flat()),[t,...M]),N=Rt(t,o,Math.random),L=Rt(t,a),y=Rt(t,r),C=Rt(t*3,e),P=Rt(l===void 0?t*3:t,fn(l)?l:new Bt(l),()=>1);return wt(g=>{w.current&&w.current.material&&(w.current.material.time=g.clock.elapsedTime)}),x.useImperativeHandle(d,()=>w.current,[]),x.createElement("points",Kt({key:`particle-${t}-${JSON.stringify(i)}`},f,{ref:w}),x.createElement("bufferGeometry",null,x.createElement("bufferAttribute",{attach:"attributes-position",args:[E,3]}),x.createElement("bufferAttribute",{attach:"attributes-size",args:[N,1]}),x.createElement("bufferAttribute",{attach:"attributes-opacity",args:[L,1]}),x.createElement("bufferAttribute",{attach:"attributes-speed",args:[y,1]}),x.createElement("bufferAttribute",{attach:"attributes-color",args:[P,3]}),x.createElement("bufferAttribute",{attach:"attributes-noise",args:[C,3]})),u||x.createElement("sparklesImplMaterial",{transparent:!0,pixelRatio:S,depthWrite:!1}))});var ur=1/1e3,fa=1e3,pa=class{constructor(){this.startTime=performance.now(),this.previousTime=0,this.currentTime=0,this._delta=0,this._elapsed=0,this._fixedDelta=1e3/60,this.timescale=1,this.useFixedDelta=!1,this._autoReset=!1}get autoReset(){return this._autoReset}set autoReset(e){typeof document<"u"&&document.hidden!==void 0&&(e?document.addEventListener("visibilitychange",this):document.removeEventListener("visibilitychange",this),this._autoReset=e)}get delta(){return this._delta*ur}get fixedDelta(){return this._fixedDelta*ur}set fixedDelta(e){this._fixedDelta=e*fa}get elapsed(){return this._elapsed*ur}update(e){this.useFixedDelta?this._delta=this.fixedDelta:(this.previousTime=this.currentTime,this.currentTime=(e!==void 0?e:performance.now())-this.startTime,this._delta=this.currentTime-this.previousTime),this._delta*=this.timescale,this._elapsed+=this._delta}reset(){this._delta=0,this._elapsed=0,this.currentTime=performance.now()-this.startTime}getDelta(){return this.delta}getElapsed(){return this.elapsed}handleEvent(e){document.hidden||(this.currentTime=performance.now()-this.startTime)}dispose(){this.autoReset=!1}},ma=(()=>{const e=new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),t=new Float32Array([0,0,2,0,0,2]),r=new Kn;return r.setAttribute("position",new Ar(e,3)),r.setAttribute("uv",new Ar(t,2)),r})(),Pe=class mr{static get fullscreenGeometry(){return ma}constructor(t="Pass",r=new Xt,a=new Ut){this.name=t,this.renderer=null,this.scene=r,this.camera=a,this.screen=null,this.rtt=!0,this.needsSwap=!0,this.needsDepthTexture=!1,this.enabled=!0}get renderToScreen(){return!this.rtt}set renderToScreen(t){if(this.rtt===t){const r=this.fullscreenMaterial;r!==null&&(r.needsUpdate=!0),this.rtt=!t}}set mainScene(t){}set mainCamera(t){}setRenderer(t){this.renderer=t}isEnabled(){return this.enabled}setEnabled(t){this.enabled=t}get fullscreenMaterial(){return this.screen!==null?this.screen.material:null}set fullscreenMaterial(t){let r=this.screen;r!==null?r.material=t:(r=new qt(mr.fullscreenGeometry,t),r.frustumCulled=!1,this.scene===null&&(this.scene=new Xt),this.scene.add(r),this.screen=r)}getFullscreenMaterial(){return this.fullscreenMaterial}setFullscreenMaterial(t){this.fullscreenMaterial=t}getDepthTexture(){return null}setDepthTexture(t,r=yt){}render(t,r,a,i,o){throw new Error("Render method not implemented!")}setSize(t,r){}initialize(t,r,a){}dispose(){for(const t of Object.keys(this)){const r=this[t];(r instanceof De||r instanceof Wr||r instanceof nt||r instanceof mr)&&this[t].dispose()}this.fullscreenMaterial!==null&&this.fullscreenMaterial.dispose()}},va=class extends Pe{constructor(){super("ClearMaskPass",null,null),this.needsSwap=!1}render(e,t,r,a,i){const o=e.state.buffers.stencil;o.setLocked(!1),o.setTest(!1)}},ga=`#ifdef COLOR_WRITE
#include <common>
#include <dithering_pars_fragment>
#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
#endif
#ifdef DEPTH_WRITE
#include <packing>
#ifdef GL_FRAGMENT_PRECISION_HIGH
uniform highp sampler2D depthBuffer;
#else
uniform mediump sampler2D depthBuffer;
#endif
float readDepth(const in vec2 uv){
#if DEPTH_PACKING == 3201
return unpackRGBAToDepth(texture2D(depthBuffer,uv));
#else
return texture2D(depthBuffer,uv).r;
#endif
}
#endif
#ifdef USE_WEIGHTS
uniform vec4 channelWeights;
#endif
uniform float opacity;varying vec2 vUv;void main(){
#ifdef COLOR_WRITE
vec4 texel=texture2D(inputBuffer,vUv);
#ifdef USE_WEIGHTS
texel*=channelWeights;
#endif
gl_FragColor=opacity*texel;
#ifdef COLOR_SPACE_CONVERSION
#include <colorspace_fragment>
#endif
#include <dithering_fragment>
#else
gl_FragColor=vec4(0.0);
#endif
#ifdef DEPTH_WRITE
gl_FragDepth=readDepth(vUv);
#endif
}`,vn="varying vec2 vUv;void main(){vUv=position.xy*0.5+0.5;gl_Position=vec4(position.xy,1.0,1.0);}",gn=class extends Be{constructor(){super({name:"CopyMaterial",defines:{COLOR_SPACE_CONVERSION:"1",DEPTH_PACKING:"0",COLOR_WRITE:"1"},uniforms:{inputBuffer:new J(null),depthBuffer:new J(null),channelWeights:new J(null),opacity:new J(1)},blending:at,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:ga,vertexShader:vn}),this.depthFunc=$n}get inputBuffer(){return this.uniforms.inputBuffer.value}set inputBuffer(e){const t=e!==null;this.colorWrite!==t&&(t?this.defines.COLOR_WRITE=!0:delete this.defines.COLOR_WRITE,this.colorWrite=t,this.needsUpdate=!0),this.uniforms.inputBuffer.value=e}get depthBuffer(){return this.uniforms.depthBuffer.value}set depthBuffer(e){const t=e!==null;this.depthWrite!==t&&(t?this.defines.DEPTH_WRITE=!0:delete this.defines.DEPTH_WRITE,this.depthTest=t,this.depthWrite=t,this.needsUpdate=!0),this.uniforms.depthBuffer.value=e}set depthPacking(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}get colorSpaceConversion(){return this.defines.COLOR_SPACE_CONVERSION!==void 0}set colorSpaceConversion(e){this.colorSpaceConversion!==e&&(e?this.defines.COLOR_SPACE_CONVERSION=!0:delete this.defines.COLOR_SPACE_CONVERSION,this.needsUpdate=!0)}get channelWeights(){return this.uniforms.channelWeights.value}set channelWeights(e){e!==null?(this.defines.USE_WEIGHTS="1",this.uniforms.channelWeights.value=e):delete this.defines.USE_WEIGHTS,this.needsUpdate=!0}setInputBuffer(e){this.uniforms.inputBuffer.value=e}getOpacity(e){return this.uniforms.opacity.value}setOpacity(e){this.uniforms.opacity.value=e}},ba=class extends Pe{constructor(e,t=!0){super("CopyPass"),this.fullscreenMaterial=new gn,this.needsSwap=!1,this.renderTarget=e,e===void 0&&(this.renderTarget=new De(1,1,{minFilter:Me,magFilter:Me,stencilBuffer:!1,depthBuffer:!1}),this.renderTarget.texture.name="CopyPass.Target"),this.autoResize=t}get resize(){return this.autoResize}set resize(e){this.autoResize=e}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}setAutoResizeEnabled(e){this.autoResize=e}render(e,t,r,a,i){this.fullscreenMaterial.inputBuffer=t.texture,e.setRenderTarget(this.renderToScreen?null:this.renderTarget),e.render(this.scene,this.camera)}setSize(e,t){this.autoResize&&this.renderTarget.setSize(e,t)}initialize(e,t,r){r!==void 0&&(this.renderTarget.texture.type=r,r!==Xe?this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1":e!==null&&e.outputColorSpace===Se&&(this.renderTarget.texture.colorSpace=Se))}},Dr=new Bt,bn=class extends Pe{constructor(e=!0,t=!0,r=!1){super("ClearPass",null,null),this.needsSwap=!1,this.color=e,this.depth=t,this.stencil=r,this.overrideClearColor=null,this.overrideClearAlpha=-1}setClearFlags(e,t,r){this.color=e,this.depth=t,this.stencil=r}getOverrideClearColor(){return this.overrideClearColor}setOverrideClearColor(e){this.overrideClearColor=e}getOverrideClearAlpha(){return this.overrideClearAlpha}setOverrideClearAlpha(e){this.overrideClearAlpha=e}render(e,t,r,a,i){const o=this.overrideClearColor,l=this.overrideClearAlpha,u=e.getClearAlpha(),f=o!==null,d=l>=0;f?(e.getClearColor(Dr),e.setClearColor(o,d?l:u)):d&&e.setClearAlpha(l),e.setRenderTarget(this.renderToScreen?null:t),e.clear(this.color,this.depth,this.stencil),f?e.setClearColor(Dr,u):d&&e.setClearAlpha(u)}},wa=class extends Pe{constructor(e,t){super("MaskPass",e,t),this.needsSwap=!1,this.clearPass=new bn(!1,!1,!0),this.inverse=!1}set mainScene(e){this.scene=e}set mainCamera(e){this.camera=e}get inverted(){return this.inverse}set inverted(e){this.inverse=e}get clear(){return this.clearPass.enabled}set clear(e){this.clearPass.enabled=e}getClearPass(){return this.clearPass}isInverted(){return this.inverted}setInverted(e){this.inverted=e}render(e,t,r,a,i){const o=e.getContext(),l=e.state.buffers,u=this.scene,f=this.camera,d=this.clearPass,w=this.inverted?0:1,S=1-w;l.color.setMask(!1),l.depth.setMask(!1),l.color.setLocked(!0),l.depth.setLocked(!0),l.stencil.setTest(!0),l.stencil.setOp(o.REPLACE,o.REPLACE,o.REPLACE),l.stencil.setFunc(o.ALWAYS,w,4294967295),l.stencil.setClear(S),l.stencil.setLocked(!0),this.clearPass.enabled&&(this.renderToScreen?d.render(e,null):(d.render(e,t),d.render(e,r))),this.renderToScreen?(e.setRenderTarget(null),e.render(u,f)):(e.setRenderTarget(t),e.render(u,f),e.setRenderTarget(r),e.render(u,f)),l.color.setLocked(!1),l.depth.setLocked(!1),l.stencil.setLocked(!1),l.stencil.setFunc(o.EQUAL,1,4294967295),l.stencil.setOp(o.KEEP,o.KEEP,o.KEEP),l.stencil.setLocked(!0)}},ya=class{constructor(e=null,{depthBuffer:t=!0,stencilBuffer:r=!1,multisampling:a=0,frameBufferType:i}={}){this.renderer=null,this.inputBuffer=this.createBuffer(t,r,i,a),this.outputBuffer=this.inputBuffer.clone(),this.copyPass=new ba,this.depthTexture=null,this.passes=[],this.timer=new pa,this.autoRenderToScreen=!0,this.setRenderer(e)}get multisampling(){return this.inputBuffer.samples||0}set multisampling(e){const t=this.inputBuffer,r=this.multisampling;r>0&&e>0?(this.inputBuffer.samples=e,this.outputBuffer.samples=e,this.inputBuffer.dispose(),this.outputBuffer.dispose()):r!==e&&(this.inputBuffer.dispose(),this.outputBuffer.dispose(),this.inputBuffer=this.createBuffer(t.depthBuffer,t.stencilBuffer,t.texture.type,e),this.inputBuffer.depthTexture=this.depthTexture,this.outputBuffer=this.inputBuffer.clone())}getTimer(){return this.timer}getRenderer(){return this.renderer}setRenderer(e){if(this.renderer=e,e!==null){const t=e.getSize(new re),r=e.getContext().getContextAttributes().alpha,a=this.inputBuffer.texture.type;a===Xe&&e.outputColorSpace===Se&&(this.inputBuffer.texture.colorSpace=Se,this.outputBuffer.texture.colorSpace=Se,this.inputBuffer.dispose(),this.outputBuffer.dispose()),e.autoClear=!1,this.setSize(t.width,t.height);for(const i of this.passes)i.initialize(e,r,a)}}replaceRenderer(e,t=!0){const r=this.renderer,a=r.domElement.parentNode;return this.setRenderer(e),t&&a!==null&&(a.removeChild(r.domElement),a.appendChild(e.domElement)),r}createDepthTexture(){const e=this.depthTexture=new Gr;return this.inputBuffer.depthTexture=e,this.inputBuffer.dispose(),this.inputBuffer.stencilBuffer?(e.format=Ln,e.type=Hn):e.type=Yr,e}deleteDepthTexture(){if(this.depthTexture!==null){this.depthTexture.dispose(),this.depthTexture=null,this.inputBuffer.depthTexture=null,this.inputBuffer.dispose();for(const e of this.passes)e.setDepthTexture(null)}}createBuffer(e,t,r,a){const i=this.renderer,o=i===null?new re:i.getDrawingBufferSize(new re),l={minFilter:Me,magFilter:Me,stencilBuffer:t,depthBuffer:e,type:r},u=new De(o.width,o.height,l);return a>0&&(u.samples=a),r===Xe&&i!==null&&i.outputColorSpace===Se&&(u.texture.colorSpace=Se),u.texture.name="EffectComposer.Buffer",u.texture.generateMipmaps=!1,u}setMainScene(e){for(const t of this.passes)t.mainScene=e}setMainCamera(e){for(const t of this.passes)t.mainCamera=e}addPass(e,t){const r=this.passes,a=this.renderer,i=a.getDrawingBufferSize(new re),o=a.getContext().getContextAttributes().alpha,l=this.inputBuffer.texture.type;if(e.setRenderer(a),e.setSize(i.width,i.height),e.initialize(a,o,l),this.autoRenderToScreen&&(r.length>0&&(r[r.length-1].renderToScreen=!1),e.renderToScreen&&(this.autoRenderToScreen=!1)),t!==void 0?r.splice(t,0,e):r.push(e),this.autoRenderToScreen&&(r[r.length-1].renderToScreen=!0),e.needsDepthTexture||this.depthTexture!==null)if(this.depthTexture===null){const u=this.createDepthTexture();for(e of r)e.setDepthTexture(u)}else e.setDepthTexture(this.depthTexture)}removePass(e){const t=this.passes,r=t.indexOf(e);if(r!==-1&&t.splice(r,1).length>0){if(this.depthTexture!==null){const a=(i,o)=>i||o.needsDepthTexture;t.reduce(a,!1)||(e.getDepthTexture()===this.depthTexture&&e.setDepthTexture(null),this.deleteDepthTexture())}this.autoRenderToScreen&&r===t.length&&(e.renderToScreen=!1,t.length>0&&(t[t.length-1].renderToScreen=!0))}}removeAllPasses(){const e=this.passes;this.deleteDepthTexture(),e.length>0&&(this.autoRenderToScreen&&(e[e.length-1].renderToScreen=!1),this.passes=[])}render(e){const t=this.renderer,r=this.copyPass;let a=this.inputBuffer,i=this.outputBuffer,o=!1,l,u,f;e===void 0&&(this.timer.update(),e=this.timer.getDelta());for(const d of this.passes)d.enabled&&(d.render(t,a,i,e,o),d.needsSwap&&(o&&(r.renderToScreen=d.renderToScreen,l=t.getContext(),u=t.state.buffers.stencil,u.setFunc(l.NOTEQUAL,1,4294967295),r.render(t,a,i,e,o),u.setFunc(l.EQUAL,1,4294967295)),f=a,a=i,i=f),d instanceof wa?o=!0:d instanceof va&&(o=!1))}setSize(e,t,r){const a=this.renderer,i=a.getSize(new re);(e===void 0||t===void 0)&&(e=i.width,t=i.height),(i.width!==e||i.height!==t)&&a.setSize(e,t,r);const o=a.getDrawingBufferSize(new re);this.inputBuffer.setSize(o.width,o.height),this.outputBuffer.setSize(o.width,o.height);for(const l of this.passes)l.setSize(o.width,o.height)}reset(){this.dispose(),this.autoRenderToScreen=!0}dispose(){for(const e of this.passes)e.dispose();this.passes=[],this.inputBuffer!==null&&this.inputBuffer.dispose(),this.outputBuffer!==null&&this.outputBuffer.dispose(),this.deleteDepthTexture(),this.copyPass.dispose(),this.timer.dispose(),Pe.fullscreenGeometry.dispose()}},dt={NONE:0,DEPTH:1,CONVOLUTION:2},q={FRAGMENT_HEAD:"FRAGMENT_HEAD",FRAGMENT_MAIN_UV:"FRAGMENT_MAIN_UV",FRAGMENT_MAIN_IMAGE:"FRAGMENT_MAIN_IMAGE",VERTEX_HEAD:"VERTEX_HEAD",VERTEX_MAIN_SUPPORT:"VERTEX_MAIN_SUPPORT"},Sa=class{constructor(){this.shaderParts=new Map([[q.FRAGMENT_HEAD,null],[q.FRAGMENT_MAIN_UV,null],[q.FRAGMENT_MAIN_IMAGE,null],[q.VERTEX_HEAD,null],[q.VERTEX_MAIN_SUPPORT,null]]),this.defines=new Map,this.uniforms=new Map,this.blendModes=new Map,this.extensions=new Set,this.attributes=dt.NONE,this.varyings=new Set,this.uvTransformation=!1,this.readDepth=!1,this.colorSpace=Ot}},hr=!1,Br=class{constructor(e=null){this.originalMaterials=new Map,this.material=null,this.materials=null,this.materialsBackSide=null,this.materialsDoubleSide=null,this.materialsFlatShaded=null,this.materialsFlatShadedBackSide=null,this.materialsFlatShadedDoubleSide=null,this.setMaterial(e),this.meshCount=0,this.replaceMaterial=t=>{if(t.isMesh){let r;if(t.material.flatShading)switch(t.material.side){case At:r=this.materialsFlatShadedDoubleSide;break;case Lt:r=this.materialsFlatShadedBackSide;break;default:r=this.materialsFlatShaded;break}else switch(t.material.side){case At:r=this.materialsDoubleSide;break;case Lt:r=this.materialsBackSide;break;default:r=this.materials;break}this.originalMaterials.set(t,t.material),t.isSkinnedMesh?t.material=r[2]:t.isInstancedMesh?t.material=r[1]:t.material=r[0],++this.meshCount}}}cloneMaterial(e){if(!(e instanceof Be))return e.clone();const t=e.uniforms,r=new Map;for(const i in t){const o=t[i].value;o.isRenderTargetTexture&&(t[i].value=null,r.set(i,o))}const a=e.clone();for(const i of r)t[i[0]].value=i[1],a.uniforms[i[0]].value=i[1];return a}setMaterial(e){if(this.disposeMaterials(),this.material=e,e!==null){const t=this.materials=[this.cloneMaterial(e),this.cloneMaterial(e),this.cloneMaterial(e)];for(const r of t)r.uniforms=Object.assign({},e.uniforms),r.side=Zn;t[2].skinning=!0,this.materialsBackSide=t.map(r=>{const a=this.cloneMaterial(r);return a.uniforms=Object.assign({},e.uniforms),a.side=Lt,a}),this.materialsDoubleSide=t.map(r=>{const a=this.cloneMaterial(r);return a.uniforms=Object.assign({},e.uniforms),a.side=At,a}),this.materialsFlatShaded=t.map(r=>{const a=this.cloneMaterial(r);return a.uniforms=Object.assign({},e.uniforms),a.flatShading=!0,a}),this.materialsFlatShadedBackSide=t.map(r=>{const a=this.cloneMaterial(r);return a.uniforms=Object.assign({},e.uniforms),a.flatShading=!0,a.side=Lt,a}),this.materialsFlatShadedDoubleSide=t.map(r=>{const a=this.cloneMaterial(r);return a.uniforms=Object.assign({},e.uniforms),a.flatShading=!0,a.side=At,a})}}render(e,t,r){const a=e.shadowMap.enabled;if(e.shadowMap.enabled=!1,hr){const i=this.originalMaterials;this.meshCount=0,t.traverse(this.replaceMaterial),e.render(t,r);for(const o of i)o[0].material=o[1];this.meshCount!==i.size&&i.clear()}else{const i=t.overrideMaterial;t.overrideMaterial=this.material,e.render(t,r),t.overrideMaterial=i}e.shadowMap.enabled=a}disposeMaterials(){if(this.material!==null){const e=this.materials.concat(this.materialsBackSide).concat(this.materialsDoubleSide).concat(this.materialsFlatShaded).concat(this.materialsFlatShadedBackSide).concat(this.materialsFlatShadedDoubleSide);for(const t of e)t.dispose()}}dispose(){this.originalMaterials.clear(),this.disposeMaterials()}static get workaroundEnabled(){return hr}static set workaroundEnabled(e){hr=e}},rt=-1,Te=class extends gr{constructor(e,t=rt,r=rt,a=1){super(),this.resizable=e,this.baseSize=new re(1,1),this.preferredSize=new re(t,r),this.target=this.preferredSize,this.s=a,this.effectiveSize=new re,this.addEventListener("change",()=>this.updateEffectiveSize()),this.updateEffectiveSize()}updateEffectiveSize(){const e=this.baseSize,t=this.preferredSize,r=this.effectiveSize,a=this.scale;t.width!==rt?r.width=t.width:t.height!==rt?r.width=Math.round(t.height*(e.width/Math.max(e.height,1))):r.width=Math.round(e.width*a),t.height!==rt?r.height=t.height:t.width!==rt?r.height=Math.round(t.width/Math.max(e.width/Math.max(e.height,1),1)):r.height=Math.round(e.height*a)}get width(){return this.effectiveSize.width}set width(e){this.preferredWidth=e}get height(){return this.effectiveSize.height}set height(e){this.preferredHeight=e}getWidth(){return this.width}getHeight(){return this.height}get scale(){return this.s}set scale(e){this.s!==e&&(this.s=e,this.preferredSize.setScalar(rt),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getScale(){return this.scale}setScale(e){this.scale=e}get baseWidth(){return this.baseSize.width}set baseWidth(e){this.baseSize.width!==e&&(this.baseSize.width=e,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getBaseWidth(){return this.baseWidth}setBaseWidth(e){this.baseWidth=e}get baseHeight(){return this.baseSize.height}set baseHeight(e){this.baseSize.height!==e&&(this.baseSize.height=e,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getBaseHeight(){return this.baseHeight}setBaseHeight(e){this.baseHeight=e}setBaseSize(e,t){(this.baseSize.width!==e||this.baseSize.height!==t)&&(this.baseSize.set(e,t),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}get preferredWidth(){return this.preferredSize.width}set preferredWidth(e){this.preferredSize.width!==e&&(this.preferredSize.width=e,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getPreferredWidth(){return this.preferredWidth}setPreferredWidth(e){this.preferredWidth=e}get preferredHeight(){return this.preferredSize.height}set preferredHeight(e){this.preferredSize.height!==e&&(this.preferredSize.height=e,this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}getPreferredHeight(){return this.preferredHeight}setPreferredHeight(e){this.preferredHeight=e}setPreferredSize(e,t){(this.preferredSize.width!==e||this.preferredSize.height!==t)&&(this.preferredSize.set(e,t),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height))}copy(e){this.s=e.scale,this.baseSize.set(e.baseWidth,e.baseHeight),this.preferredSize.set(e.preferredWidth,e.preferredHeight),this.dispatchEvent({type:"change"}),this.resizable.setSize(this.baseSize.width,this.baseSize.height)}static get AUTO_SIZE(){return rt}},K={ADD:0,ALPHA:1,AVERAGE:2,COLOR:3,COLOR_BURN:4,COLOR_DODGE:5,DARKEN:6,DIFFERENCE:7,DIVIDE:8,DST:9,EXCLUSION:10,HARD_LIGHT:11,HARD_MIX:12,HUE:13,INVERT:14,INVERT_RGB:15,LIGHTEN:16,LINEAR_BURN:17,LINEAR_DODGE:18,LINEAR_LIGHT:19,LUMINOSITY:20,MULTIPLY:21,NEGATION:22,NORMAL:23,OVERLAY:24,PIN_LIGHT:25,REFLECT:26,SATURATION:27,SCREEN:28,SOFT_LIGHT:29,SRC:30,SUBTRACT:31,VIVID_LIGHT:32},Ea="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb+src.rgb;return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",xa="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){return mix(dst,src,src.a*opacity);}",Ma="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=(dst.rgb+src.rgb)*0.5;return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Ta="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=RGBToHSL(dst.rgb);vec3 b=RGBToHSL(src.rgb);vec3 c=HSLToRGB(vec3(b.xy,a.z));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",_a="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=dst.rgb,b=src.rgb;vec3 c=mix(step(0.0,b)*(1.0-min(vec3(1.0),(1.0-a)/max(b,1e-9))),vec3(1.0),step(1.0,a));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Ra="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=dst.rgb,b=src.rgb;vec3 c=step(0.0,a)*mix(min(vec3(1.0),a/max(1.0-b,1e-9)),vec3(1.0),step(1.0,b));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Aa="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=min(dst.rgb,src.rgb);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Ua="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=abs(dst.rgb-src.rgb);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Pa="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb/max(src.rgb,1e-9);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Ca="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb+src.rgb-2.0*dst.rgb*src.rgb;return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Oa="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=min(dst.rgb,1.0);vec3 b=min(src.rgb,1.0);vec3 c=mix(2.0*a*b,1.0-2.0*(1.0-a)*(1.0-b),step(0.5,b));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",za="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=step(1.0,dst.rgb+src.rgb);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Da="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=RGBToHSL(dst.rgb);vec3 b=RGBToHSL(src.rgb);vec3 c=HSLToRGB(vec3(b.x,a.yz));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Ba="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=max(1.0-src.rgb,0.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Ia="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=src.rgb*max(1.0-dst.rgb,0.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Fa="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=max(dst.rgb,src.rgb);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Na="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=clamp(src.rgb+dst.rgb-1.0,0.0,1.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",ka="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=min(dst.rgb+src.rgb,1.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",La="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=clamp(2.0*src.rgb+dst.rgb-1.0,0.0,1.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Ha="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=RGBToHSL(dst.rgb);vec3 b=RGBToHSL(src.rgb);vec3 c=HSLToRGB(vec3(a.xy,b.z));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",ja="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb*src.rgb;return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Ga="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=max(1.0-abs(1.0-dst.rgb-src.rgb),0.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Va="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){return mix(dst,src,opacity);}",Ya="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=2.0*src.rgb*dst.rgb;vec3 b=1.0-2.0*(1.0-src.rgb)*(1.0-dst.rgb);vec3 c=mix(a,b,step(0.5,dst.rgb));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Xa="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 src2=2.0*src.rgb;vec3 c=mix(mix(src2,dst.rgb,step(0.5*dst.rgb,src.rgb)),max(src2-1.0,vec3(0.0)),step(dst.rgb,src2-1.0));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Wa="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=min(dst.rgb*dst.rgb/max(1.0-src.rgb,1e-9),1.0);vec3 c=mix(a,src.rgb,step(1.0,src.rgb));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Za="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 a=RGBToHSL(dst.rgb);vec3 b=RGBToHSL(src.rgb);vec3 c=HSLToRGB(vec3(a.x,b.y,a.z));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",$a="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=dst.rgb+src.rgb-min(dst.rgb*src.rgb,1.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Ka="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 src2=2.0*src.rgb;vec3 d=dst.rgb+(src2-1.0);vec3 w=step(0.5,src.rgb);vec3 a=dst.rgb-(1.0-src2)*dst.rgb*(1.0-dst.rgb);vec3 b=mix(d*(sqrt(dst.rgb)-dst.rgb),d*dst.rgb*((16.0*dst.rgb-12.0)*dst.rgb+3.0),w*(1.0-step(0.25,dst.rgb)));vec3 c=mix(a,b,w);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Qa="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){return src;}",qa="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=max(dst.rgb-src.rgb,0.0);return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",Ja="vec4 blend(const in vec4 dst,const in vec4 src,const in float opacity){vec3 c=mix(max(1.0-min((1.0-dst.rgb)/(2.0*src.rgb),1.0),0.0),min(dst.rgb/(2.0*(1.0-src.rgb)),1.0),step(0.5,src.rgb));return mix(dst,vec4(c,max(dst.a,src.a)),opacity);}",ei=new Map([[K.ADD,Ea],[K.ALPHA,xa],[K.AVERAGE,Ma],[K.COLOR,Ta],[K.COLOR_BURN,_a],[K.COLOR_DODGE,Ra],[K.DARKEN,Aa],[K.DIFFERENCE,Ua],[K.DIVIDE,Pa],[K.DST,null],[K.EXCLUSION,Ca],[K.HARD_LIGHT,Oa],[K.HARD_MIX,za],[K.HUE,Da],[K.INVERT,Ba],[K.INVERT_RGB,Ia],[K.LIGHTEN,Fa],[K.LINEAR_BURN,Na],[K.LINEAR_DODGE,ka],[K.LINEAR_LIGHT,La],[K.LUMINOSITY,Ha],[K.MULTIPLY,ja],[K.NEGATION,Ga],[K.NORMAL,Va],[K.OVERLAY,Ya],[K.PIN_LIGHT,Xa],[K.REFLECT,Wa],[K.SATURATION,Za],[K.SCREEN,$a],[K.SOFT_LIGHT,Ka],[K.SRC,Qa],[K.SUBTRACT,qa],[K.VIVID_LIGHT,Ja]]),ti=class extends gr{constructor(e,t=1){super(),this._blendFunction=e,this.opacity=new J(t)}getOpacity(){return this.opacity.value}setOpacity(e){this.opacity.value=e}get blendFunction(){return this._blendFunction}set blendFunction(e){this._blendFunction=e,this.dispatchEvent({type:"change"})}getBlendFunction(){return this.blendFunction}setBlendFunction(e){this.blendFunction=e}getShaderCode(){return ei.get(this.blendFunction)}},vr=class extends gr{constructor(e,t,{attributes:r=dt.NONE,blendFunction:a=K.NORMAL,defines:i=new Map,uniforms:o=new Map,extensions:l=null,vertexShader:u=null}={}){super(),this.name=e,this.renderer=null,this.attributes=r,this.fragmentShader=t,this.vertexShader=u,this.defines=i,this.uniforms=o,this.extensions=l,this.blendMode=new ti(a),this.blendMode.addEventListener("change",f=>this.setChanged()),this._inputColorSpace=Ot,this._outputColorSpace=Xr}get inputColorSpace(){return this._inputColorSpace}set inputColorSpace(e){this._inputColorSpace=e,this.setChanged()}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e,this.setChanged()}set mainScene(e){}set mainCamera(e){}getName(){return this.name}setRenderer(e){this.renderer=e}getDefines(){return this.defines}getUniforms(){return this.uniforms}getExtensions(){return this.extensions}getBlendMode(){return this.blendMode}getAttributes(){return this.attributes}setAttributes(e){this.attributes=e,this.setChanged()}getFragmentShader(){return this.fragmentShader}setFragmentShader(e){this.fragmentShader=e,this.setChanged()}getVertexShader(){return this.vertexShader}setVertexShader(e){this.vertexShader=e,this.setChanged()}setChanged(){this.dispatchEvent({type:"change"})}setDepthTexture(e,t=yt){}update(e,t,r){}setSize(e,t){}initialize(e,t,r){}dispose(){for(const e of Object.keys(this)){const t=this[e];(t instanceof De||t instanceof Wr||t instanceof nt||t instanceof Pe)&&this[e].dispose()}}},Tr={MEDIUM:2,LARGE:3},ri=`#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec4 sum=texture2D(inputBuffer,vUv0);sum+=texture2D(inputBuffer,vUv1);sum+=texture2D(inputBuffer,vUv2);sum+=texture2D(inputBuffer,vUv3);gl_FragColor=sum*0.25;
#include <colorspace_fragment>
}`,ni="uniform vec4 texelSize;uniform float kernel;uniform float scale;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 uv=position.xy*0.5+0.5;vec2 dUv=(texelSize.xy*vec2(kernel)+texelSize.zw)*scale;vUv0=vec2(uv.x-dUv.x,uv.y+dUv.y);vUv1=vec2(uv.x+dUv.x,uv.y+dUv.y);vUv2=vec2(uv.x+dUv.x,uv.y-dUv.y);vUv3=vec2(uv.x-dUv.x,uv.y-dUv.y);gl_Position=vec4(position.xy,1.0,1.0);}",si=[new Float32Array([0,0]),new Float32Array([0,1,1]),new Float32Array([0,1,1,2]),new Float32Array([0,1,2,2,3]),new Float32Array([0,1,2,3,4,4,5]),new Float32Array([0,1,2,3,4,5,7,8,9,10])],ai=class extends Be{constructor(e=new fr){super({name:"KawaseBlurMaterial",uniforms:{inputBuffer:new J(null),texelSize:new J(new fr),scale:new J(1),kernel:new J(0)},blending:at,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:ri,vertexShader:ni}),this.setTexelSize(e.x,e.y),this.kernelSize=Tr.MEDIUM}set inputBuffer(e){this.uniforms.inputBuffer.value=e}setInputBuffer(e){this.inputBuffer=e}get kernelSequence(){return si[this.kernelSize]}get scale(){return this.uniforms.scale.value}set scale(e){this.uniforms.scale.value=e}getScale(){return this.uniforms.scale.value}setScale(e){this.uniforms.scale.value=e}getKernel(){return null}get kernel(){return this.uniforms.kernel.value}set kernel(e){this.uniforms.kernel.value=e}setKernel(e){this.kernel=e}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t,e*.5,t*.5)}setSize(e,t){const r=1/e,a=1/t;this.uniforms.texelSize.value.set(r,a,r*.5,a*.5)}},ii=class extends Pe{constructor({kernelSize:e=Tr.MEDIUM,resolutionScale:t=.5,width:r=Te.AUTO_SIZE,height:a=Te.AUTO_SIZE,resolutionX:i=r,resolutionY:o=a}={}){super("KawaseBlurPass"),this.renderTargetA=new De(1,1,{depthBuffer:!1}),this.renderTargetA.texture.name="Blur.Target.A",this.renderTargetB=this.renderTargetA.clone(),this.renderTargetB.texture.name="Blur.Target.B";const l=this.resolution=new Te(this,i,o,t);l.addEventListener("change",u=>this.setSize(l.baseWidth,l.baseHeight)),this._blurMaterial=new ai,this._blurMaterial.kernelSize=e,this.copyMaterial=new gn}getResolution(){return this.resolution}get blurMaterial(){return this._blurMaterial}set blurMaterial(e){this._blurMaterial=e}get dithering(){return this.copyMaterial.dithering}set dithering(e){this.copyMaterial.dithering=e}get kernelSize(){return this.blurMaterial.kernelSize}set kernelSize(e){this.blurMaterial.kernelSize=e}get width(){return this.resolution.width}set width(e){this.resolution.preferredWidth=e}get height(){return this.resolution.height}set height(e){this.resolution.preferredHeight=e}get scale(){return this.blurMaterial.scale}set scale(e){this.blurMaterial.scale=e}getScale(){return this.blurMaterial.scale}setScale(e){this.blurMaterial.scale=e}getKernelSize(){return this.kernelSize}setKernelSize(e){this.kernelSize=e}getResolutionScale(){return this.resolution.scale}setResolutionScale(e){this.resolution.scale=e}render(e,t,r,a,i){const o=this.scene,l=this.camera,u=this.renderTargetA,f=this.renderTargetB,d=this.blurMaterial,w=d.kernelSequence;let S=t;this.fullscreenMaterial=d;for(let M=0,E=w.length;M<E;++M){const N=(M&1)===0?u:f;d.kernel=w[M],d.inputBuffer=S.texture,e.setRenderTarget(N),e.render(o,l),S=N}this.fullscreenMaterial=this.copyMaterial,this.copyMaterial.inputBuffer=S.texture,e.setRenderTarget(this.renderToScreen?null:r),e.render(o,l)}setSize(e,t){const r=this.resolution;r.setBaseSize(e,t);const a=r.width,i=r.height;this.renderTargetA.setSize(a,i),this.renderTargetB.setSize(a,i),this.blurMaterial.setSize(e,t)}initialize(e,t,r){r!==void 0&&(this.renderTargetA.texture.type=r,this.renderTargetB.texture.type=r,r!==Xe?(this.blurMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1",this.copyMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1"):e!==null&&e.outputColorSpace===Se&&(this.renderTargetA.texture.colorSpace=Se,this.renderTargetB.texture.colorSpace=Se))}static get AUTO_SIZE(){return Te.AUTO_SIZE}},oi=`#include <common>
#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
#ifdef RANGE
uniform vec2 range;
#elif defined(THRESHOLD)
uniform float threshold;uniform float smoothing;
#endif
varying vec2 vUv;void main(){vec4 texel=texture2D(inputBuffer,vUv);float l=luminance(texel.rgb);float mask=1.0;
#ifdef RANGE
float low=step(range.x,l);float high=step(l,range.y);mask=low*high;
#elif defined(THRESHOLD)
mask=smoothstep(threshold,threshold+smoothing,l);
#endif
#ifdef COLOR
gl_FragColor=texel*mask;
#else
gl_FragColor=vec4(l*mask);
#endif
}`,li=class extends Be{constructor(e=!1,t=null){super({name:"LuminanceMaterial",defines:{THREE_REVISION:Zr.replace(/\D+/g,"")},uniforms:{inputBuffer:new J(null),threshold:new J(0),smoothing:new J(1),range:new J(null)},blending:at,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:oi,vertexShader:vn}),this.colorOutput=e,this.luminanceRange=t}set inputBuffer(e){this.uniforms.inputBuffer.value=e}setInputBuffer(e){this.uniforms.inputBuffer.value=e}get threshold(){return this.uniforms.threshold.value}set threshold(e){this.smoothing>0||e>0?this.defines.THRESHOLD="1":delete this.defines.THRESHOLD,this.uniforms.threshold.value=e}getThreshold(){return this.threshold}setThreshold(e){this.threshold=e}get smoothing(){return this.uniforms.smoothing.value}set smoothing(e){this.threshold>0||e>0?this.defines.THRESHOLD="1":delete this.defines.THRESHOLD,this.uniforms.smoothing.value=e}getSmoothingFactor(){return this.smoothing}setSmoothingFactor(e){this.smoothing=e}get useThreshold(){return this.threshold>0||this.smoothing>0}set useThreshold(e){}get colorOutput(){return this.defines.COLOR!==void 0}set colorOutput(e){e?this.defines.COLOR="1":delete this.defines.COLOR,this.needsUpdate=!0}isColorOutputEnabled(e){return this.colorOutput}setColorOutputEnabled(e){this.colorOutput=e}get useRange(){return this.luminanceRange!==null}set useRange(e){this.luminanceRange=null}get luminanceRange(){return this.uniforms.range.value}set luminanceRange(e){e!==null?this.defines.RANGE="1":delete this.defines.RANGE,this.uniforms.range.value=e,this.needsUpdate=!0}getLuminanceRange(){return this.luminanceRange}setLuminanceRange(e){this.luminanceRange=e}},ci=class extends Pe{constructor({renderTarget:e,luminanceRange:t,colorOutput:r,resolutionScale:a=1,width:i=Te.AUTO_SIZE,height:o=Te.AUTO_SIZE,resolutionX:l=i,resolutionY:u=o}={}){super("LuminancePass"),this.fullscreenMaterial=new li(r,t),this.needsSwap=!1,this.renderTarget=e,this.renderTarget===void 0&&(this.renderTarget=new De(1,1,{depthBuffer:!1}),this.renderTarget.texture.name="LuminancePass.Target");const f=this.resolution=new Te(this,l,u,a);f.addEventListener("change",d=>this.setSize(f.baseWidth,f.baseHeight))}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}getResolution(){return this.resolution}render(e,t,r,a,i){const o=this.fullscreenMaterial;o.inputBuffer=t.texture,e.setRenderTarget(this.renderToScreen?null:this.renderTarget),e.render(this.scene,this.camera)}setSize(e,t){const r=this.resolution;r.setBaseSize(e,t),this.renderTarget.setSize(r.width,r.height)}initialize(e,t,r){r!==void 0&&r!==Xe&&(this.renderTarget.texture.type=r,this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1")}},ui=`#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
#define WEIGHT_INNER 0.125
#define WEIGHT_OUTER 0.0555555
varying vec2 vUv;varying vec2 vUv00;varying vec2 vUv01;varying vec2 vUv02;varying vec2 vUv03;varying vec2 vUv04;varying vec2 vUv05;varying vec2 vUv06;varying vec2 vUv07;varying vec2 vUv08;varying vec2 vUv09;varying vec2 vUv10;varying vec2 vUv11;float clampToBorder(const in vec2 uv){return float(uv.s>=0.0&&uv.s<=1.0&&uv.t>=0.0&&uv.t<=1.0);}void main(){vec4 c=vec4(0.0);vec4 w=WEIGHT_INNER*vec4(clampToBorder(vUv00),clampToBorder(vUv01),clampToBorder(vUv02),clampToBorder(vUv03));c+=w.x*texture2D(inputBuffer,vUv00);c+=w.y*texture2D(inputBuffer,vUv01);c+=w.z*texture2D(inputBuffer,vUv02);c+=w.w*texture2D(inputBuffer,vUv03);w=WEIGHT_OUTER*vec4(clampToBorder(vUv04),clampToBorder(vUv05),clampToBorder(vUv06),clampToBorder(vUv07));c+=w.x*texture2D(inputBuffer,vUv04);c+=w.y*texture2D(inputBuffer,vUv05);c+=w.z*texture2D(inputBuffer,vUv06);c+=w.w*texture2D(inputBuffer,vUv07);w=WEIGHT_OUTER*vec4(clampToBorder(vUv08),clampToBorder(vUv09),clampToBorder(vUv10),clampToBorder(vUv11));c+=w.x*texture2D(inputBuffer,vUv08);c+=w.y*texture2D(inputBuffer,vUv09);c+=w.z*texture2D(inputBuffer,vUv10);c+=w.w*texture2D(inputBuffer,vUv11);c+=WEIGHT_OUTER*texture2D(inputBuffer,vUv);gl_FragColor=c;
#include <colorspace_fragment>
}`,hi="uniform vec2 texelSize;varying vec2 vUv;varying vec2 vUv00;varying vec2 vUv01;varying vec2 vUv02;varying vec2 vUv03;varying vec2 vUv04;varying vec2 vUv05;varying vec2 vUv06;varying vec2 vUv07;varying vec2 vUv08;varying vec2 vUv09;varying vec2 vUv10;varying vec2 vUv11;void main(){vUv=position.xy*0.5+0.5;vUv00=vUv+texelSize*vec2(-1.0,1.0);vUv01=vUv+texelSize*vec2(1.0,1.0);vUv02=vUv+texelSize*vec2(-1.0,-1.0);vUv03=vUv+texelSize*vec2(1.0,-1.0);vUv04=vUv+texelSize*vec2(-2.0,2.0);vUv05=vUv+texelSize*vec2(0.0,2.0);vUv06=vUv+texelSize*vec2(2.0,2.0);vUv07=vUv+texelSize*vec2(-2.0,0.0);vUv08=vUv+texelSize*vec2(2.0,0.0);vUv09=vUv+texelSize*vec2(-2.0,-2.0);vUv10=vUv+texelSize*vec2(0.0,-2.0);vUv11=vUv+texelSize*vec2(2.0,-2.0);gl_Position=vec4(position.xy,1.0,1.0);}",di=class extends Be{constructor(){super({name:"DownsamplingMaterial",uniforms:{inputBuffer:new J(null),texelSize:new J(new re)},blending:at,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:ui,vertexShader:hi})}set inputBuffer(e){this.uniforms.inputBuffer.value=e}setSize(e,t){this.uniforms.texelSize.value.set(1/e,1/t)}},fi=`#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;uniform mediump sampler2D supportBuffer;
#else
uniform lowp sampler2D inputBuffer;uniform lowp sampler2D supportBuffer;
#endif
uniform float radius;varying vec2 vUv;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;varying vec2 vUv4;varying vec2 vUv5;varying vec2 vUv6;varying vec2 vUv7;void main(){vec4 c=vec4(0.0);c+=texture2D(inputBuffer,vUv0)*0.0625;c+=texture2D(inputBuffer,vUv1)*0.125;c+=texture2D(inputBuffer,vUv2)*0.0625;c+=texture2D(inputBuffer,vUv3)*0.125;c+=texture2D(inputBuffer,vUv)*0.25;c+=texture2D(inputBuffer,vUv4)*0.125;c+=texture2D(inputBuffer,vUv5)*0.0625;c+=texture2D(inputBuffer,vUv6)*0.125;c+=texture2D(inputBuffer,vUv7)*0.0625;vec4 baseColor=texture2D(supportBuffer,vUv);gl_FragColor=mix(baseColor,c,radius);
#include <colorspace_fragment>
}`,pi="uniform vec2 texelSize;varying vec2 vUv;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;varying vec2 vUv4;varying vec2 vUv5;varying vec2 vUv6;varying vec2 vUv7;void main(){vUv=position.xy*0.5+0.5;vUv0=vUv+texelSize*vec2(-1.0,1.0);vUv1=vUv+texelSize*vec2(0.0,1.0);vUv2=vUv+texelSize*vec2(1.0,1.0);vUv3=vUv+texelSize*vec2(-1.0,0.0);vUv4=vUv+texelSize*vec2(1.0,0.0);vUv5=vUv+texelSize*vec2(-1.0,-1.0);vUv6=vUv+texelSize*vec2(0.0,-1.0);vUv7=vUv+texelSize*vec2(1.0,-1.0);gl_Position=vec4(position.xy,1.0,1.0);}",mi=class extends Be{constructor(){super({name:"UpsamplingMaterial",uniforms:{inputBuffer:new J(null),supportBuffer:new J(null),texelSize:new J(new re),radius:new J(.85)},blending:at,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:fi,vertexShader:pi})}set inputBuffer(e){this.uniforms.inputBuffer.value=e}set supportBuffer(e){this.uniforms.supportBuffer.value=e}get radius(){return this.uniforms.radius.value}set radius(e){this.uniforms.radius.value=e}setSize(e,t){this.uniforms.texelSize.value.set(1/e,1/t)}},vi=class extends Pe{constructor(){super("MipmapBlurPass"),this.needsSwap=!1,this.renderTarget=new De(1,1,{depthBuffer:!1}),this.renderTarget.texture.name="Upsampling.Mipmap0",this.downsamplingMipmaps=[],this.upsamplingMipmaps=[],this.downsamplingMaterial=new di,this.upsamplingMaterial=new mi,this.resolution=new re}get texture(){return this.renderTarget.texture}get levels(){return this.downsamplingMipmaps.length}set levels(e){if(this.levels!==e){const t=this.renderTarget;this.dispose(),this.downsamplingMipmaps=[],this.upsamplingMipmaps=[];for(let r=0;r<e;++r){const a=t.clone();a.texture.name="Downsampling.Mipmap"+r,this.downsamplingMipmaps.push(a)}this.upsamplingMipmaps.push(t);for(let r=1,a=e-1;r<a;++r){const i=t.clone();i.texture.name="Upsampling.Mipmap"+r,this.upsamplingMipmaps.push(i)}this.setSize(this.resolution.x,this.resolution.y)}}get radius(){return this.upsamplingMaterial.radius}set radius(e){this.upsamplingMaterial.radius=e}render(e,t,r,a,i){const{scene:o,camera:l}=this,{downsamplingMaterial:u,upsamplingMaterial:f}=this,{downsamplingMipmaps:d,upsamplingMipmaps:w}=this;let S=t;this.fullscreenMaterial=u;for(let M=0,E=d.length;M<E;++M){const N=d[M];u.setSize(S.width,S.height),u.inputBuffer=S.texture,e.setRenderTarget(N),e.render(o,l),S=N}this.fullscreenMaterial=f;for(let M=w.length-1;M>=0;--M){const E=w[M];f.setSize(S.width,S.height),f.inputBuffer=S.texture,f.supportBuffer=d[M].texture,e.setRenderTarget(E),e.render(o,l),S=E}}setSize(e,t){const r=this.resolution;r.set(e,t);let a=r.width,i=r.height;for(let o=0,l=this.downsamplingMipmaps.length;o<l;++o)a=Math.round(a*.5),i=Math.round(i*.5),this.downsamplingMipmaps[o].setSize(a,i),o<this.upsamplingMipmaps.length&&this.upsamplingMipmaps[o].setSize(a,i)}initialize(e,t,r){if(r!==void 0){const a=this.downsamplingMipmaps.concat(this.upsamplingMipmaps);for(const i of a)i.texture.type=r;if(r!==Xe)this.downsamplingMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1",this.upsamplingMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1";else if(e!==null&&e.outputColorSpace===Se)for(const i of a)i.texture.colorSpace=Se}}dispose(){super.dispose();for(const e of this.downsamplingMipmaps.concat(this.upsamplingMipmaps))e.dispose()}},gi=`#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D map;
#else
uniform lowp sampler2D map;
#endif
uniform float intensity;void mainImage(const in vec4 inputColor,const in vec2 uv,out vec4 outputColor){outputColor=texture2D(map,uv)*intensity;}`,bi=class extends vr{constructor({blendFunction:e=K.SCREEN,luminanceThreshold:t=1,luminanceSmoothing:r=.03,mipmapBlur:a=!0,intensity:i=1,radius:o=.85,levels:l=8,kernelSize:u=Tr.LARGE,resolutionScale:f=.5,width:d=Te.AUTO_SIZE,height:w=Te.AUTO_SIZE,resolutionX:S=d,resolutionY:M=w}={}){super("BloomEffect",gi,{blendFunction:e,uniforms:new Map([["map",new J(null)],["intensity",new J(i)]])}),this.renderTarget=new De(1,1,{depthBuffer:!1}),this.renderTarget.texture.name="Bloom.Target",this.blurPass=new ii({kernelSize:u}),this.luminancePass=new ci({colorOutput:!0}),this.luminanceMaterial.threshold=t,this.luminanceMaterial.smoothing=r,this.mipmapBlurPass=new vi,this.mipmapBlurPass.enabled=a,this.mipmapBlurPass.radius=o,this.mipmapBlurPass.levels=l,this.uniforms.get("map").value=a?this.mipmapBlurPass.texture:this.renderTarget.texture;const E=this.resolution=new Te(this,S,M,f);E.addEventListener("change",N=>this.setSize(E.baseWidth,E.baseHeight))}get texture(){return this.mipmapBlurPass.enabled?this.mipmapBlurPass.texture:this.renderTarget.texture}getTexture(){return this.texture}getResolution(){return this.resolution}getBlurPass(){return this.blurPass}getLuminancePass(){return this.luminancePass}get luminanceMaterial(){return this.luminancePass.fullscreenMaterial}getLuminanceMaterial(){return this.luminancePass.fullscreenMaterial}get width(){return this.resolution.width}set width(e){this.resolution.preferredWidth=e}get height(){return this.resolution.height}set height(e){this.resolution.preferredHeight=e}get dithering(){return this.blurPass.dithering}set dithering(e){this.blurPass.dithering=e}get kernelSize(){return this.blurPass.kernelSize}set kernelSize(e){this.blurPass.kernelSize=e}get distinction(){return console.warn(this.name,"distinction was removed"),1}set distinction(e){console.warn(this.name,"distinction was removed")}get intensity(){return this.uniforms.get("intensity").value}set intensity(e){this.uniforms.get("intensity").value=e}getIntensity(){return this.intensity}setIntensity(e){this.intensity=e}getResolutionScale(){return this.resolution.scale}setResolutionScale(e){this.resolution.scale=e}update(e,t,r){const a=this.renderTarget,i=this.luminancePass;i.enabled?(i.render(e,t),this.mipmapBlurPass.enabled?this.mipmapBlurPass.render(e,i.renderTarget):this.blurPass.render(e,i.renderTarget,a)):this.mipmapBlurPass.enabled?this.mipmapBlurPass.render(e,t):this.blurPass.render(e,t,a)}setSize(e,t){const r=this.resolution;r.setBaseSize(e,t),this.renderTarget.setSize(r.width,r.height),this.blurPass.resolution.copy(r),this.luminancePass.setSize(e,t),this.mipmapBlurPass.setSize(e,t)}initialize(e,t,r){this.blurPass.initialize(e,t,r),this.luminancePass.initialize(e,t,r),this.mipmapBlurPass.initialize(e,t,r),r!==void 0&&(this.renderTarget.texture.type=r,e!==null&&e.outputColorSpace===Se&&(this.renderTarget.texture.colorSpace=Se))}},wn=class extends Pe{constructor(e,t,r=null){super("RenderPass",e,t),this.needsSwap=!1,this.clearPass=new bn,this.overrideMaterialManager=r===null?null:new Br(r),this.ignoreBackground=!1,this.skipShadowMapUpdate=!1,this.selection=null}set mainScene(e){this.scene=e}set mainCamera(e){this.camera=e}get renderToScreen(){return super.renderToScreen}set renderToScreen(e){super.renderToScreen=e,this.clearPass.renderToScreen=e}get overrideMaterial(){const e=this.overrideMaterialManager;return e!==null?e.material:null}set overrideMaterial(e){const t=this.overrideMaterialManager;e!==null?t!==null?t.setMaterial(e):this.overrideMaterialManager=new Br(e):t!==null&&(t.dispose(),this.overrideMaterialManager=null)}getOverrideMaterial(){return this.overrideMaterial}setOverrideMaterial(e){this.overrideMaterial=e}get clear(){return this.clearPass.enabled}set clear(e){this.clearPass.enabled=e}getSelection(){return this.selection}setSelection(e){this.selection=e}isBackgroundDisabled(){return this.ignoreBackground}setBackgroundDisabled(e){this.ignoreBackground=e}isShadowMapDisabled(){return this.skipShadowMapUpdate}setShadowMapDisabled(e){this.skipShadowMapUpdate=e}getClearPass(){return this.clearPass}render(e,t,r,a,i){const o=this.scene,l=this.camera,u=this.selection,f=l.layers.mask,d=o.background,w=e.shadowMap.autoUpdate,S=this.renderToScreen?null:t;u!==null&&l.layers.set(u.getLayer()),this.skipShadowMapUpdate&&(e.shadowMap.autoUpdate=!1),(this.ignoreBackground||this.clearPass.overrideClearColor!==null)&&(o.background=null),this.clearPass.enabled&&this.clearPass.render(e,t),e.setRenderTarget(S),this.overrideMaterialManager!==null?this.overrideMaterialManager.render(e,o,l):e.render(o,l),l.layers.mask=f,o.background=d,e.shadowMap.autoUpdate=w}},wi=`#include <packing>
#ifdef GL_FRAGMENT_PRECISION_HIGH
uniform highp sampler2D depthBuffer;
#else
uniform mediump sampler2D depthBuffer;
#endif
#ifdef DOWNSAMPLE_NORMALS
uniform lowp sampler2D normalBuffer;
#endif
varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;float readDepth(const in vec2 uv){
#if DEPTH_PACKING == 3201
return unpackRGBAToDepth(texture2D(depthBuffer,uv));
#else
return texture2D(depthBuffer,uv).r;
#endif
}int findBestDepth(const in float samples[4]){float c=(samples[0]+samples[1]+samples[2]+samples[3])*0.25;float distances[4];distances[0]=abs(c-samples[0]);distances[1]=abs(c-samples[1]);distances[2]=abs(c-samples[2]);distances[3]=abs(c-samples[3]);float maxDistance=max(max(distances[0],distances[1]),max(distances[2],distances[3]));int remaining[3];int rejected[3];int i,j,k;for(i=0,j=0,k=0;i<4;++i){if(distances[i]<maxDistance){remaining[j++]=i;}else{rejected[k++]=i;}}for(;j<3;++j){remaining[j]=rejected[--k];}vec3 s=vec3(samples[remaining[0]],samples[remaining[1]],samples[remaining[2]]);c=(s.x+s.y+s.z)/3.0;distances[0]=abs(c-s.x);distances[1]=abs(c-s.y);distances[2]=abs(c-s.z);float minDistance=min(distances[0],min(distances[1],distances[2]));for(i=0;i<3;++i){if(distances[i]==minDistance){break;}}return remaining[i];}void main(){float d[4];d[0]=readDepth(vUv0);d[1]=readDepth(vUv1);d[2]=readDepth(vUv2);d[3]=readDepth(vUv3);int index=findBestDepth(d);
#ifdef DOWNSAMPLE_NORMALS
vec3 n[4];n[0]=texture2D(normalBuffer,vUv0).rgb;n[1]=texture2D(normalBuffer,vUv1).rgb;n[2]=texture2D(normalBuffer,vUv2).rgb;n[3]=texture2D(normalBuffer,vUv3).rgb;
#else
vec3 n[4];n[0]=vec3(0.0);n[1]=vec3(0.0);n[2]=vec3(0.0);n[3]=vec3(0.0);
#endif
gl_FragColor=vec4(n[index],d[index]);}`,yi="uniform vec2 texelSize;varying vec2 vUv0;varying vec2 vUv1;varying vec2 vUv2;varying vec2 vUv3;void main(){vec2 uv=position.xy*0.5+0.5;vUv0=uv;vUv1=vec2(uv.x,uv.y+texelSize.y);vUv2=vec2(uv.x+texelSize.x,uv.y);vUv3=uv+texelSize;gl_Position=vec4(position.xy,1.0,1.0);}",Si=class extends Be{constructor(){super({name:"DepthDownsamplingMaterial",defines:{DEPTH_PACKING:"0"},uniforms:{depthBuffer:new J(null),normalBuffer:new J(null),texelSize:new J(new re)},blending:at,toneMapped:!1,depthWrite:!1,depthTest:!1,fragmentShader:wi,vertexShader:yi})}set depthBuffer(e){this.uniforms.depthBuffer.value=e}set depthPacking(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}setDepthBuffer(e,t=yt){this.depthBuffer=e,this.depthPacking=t}set normalBuffer(e){this.uniforms.normalBuffer.value=e,e!==null?this.defines.DOWNSAMPLE_NORMALS="1":delete this.defines.DOWNSAMPLE_NORMALS,this.needsUpdate=!0}setNormalBuffer(e){this.normalBuffer=e}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t)}setSize(e,t){this.uniforms.texelSize.value.set(1/e,1/t)}},Ei=class extends Pe{constructor({normalBuffer:e=null,resolutionScale:t=.5,width:r=Te.AUTO_SIZE,height:a=Te.AUTO_SIZE,resolutionX:i=r,resolutionY:o=a}={}){super("DepthDownsamplingPass");const l=new Si;l.normalBuffer=e,this.fullscreenMaterial=l,this.needsDepthTexture=!0,this.needsSwap=!1,this.renderTarget=new De(1,1,{minFilter:Wt,magFilter:Wt,depthBuffer:!1,type:je}),this.renderTarget.texture.name="DepthDownsamplingPass.Target",this.renderTarget.texture.generateMipmaps=!1;const u=this.resolution=new Te(this,i,o,t);u.addEventListener("change",f=>this.setSize(u.baseWidth,u.baseHeight))}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}getResolution(){return this.resolution}setDepthTexture(e,t=yt){this.fullscreenMaterial.depthBuffer=e,this.fullscreenMaterial.depthPacking=t}render(e,t,r,a,i){e.setRenderTarget(this.renderToScreen?null:this.renderTarget),e.render(this.scene,this.camera)}setSize(e,t){const r=this.resolution;r.setBaseSize(e,t),this.renderTarget.setSize(r.width,r.height),this.fullscreenMaterial.setSize(e,t)}initialize(e,t,r){const a=e.getContext();if(!(a.getExtension("EXT_color_buffer_float")||a.getExtension("EXT_color_buffer_half_float")))throw new Error("Rendering to float texture is not supported.")}},xi=`#include <common>
#include <packing>
#include <dithering_pars_fragment>
#define packFloatToRGBA(v) packDepthToRGBA(v)
#define unpackRGBAToFloat(v) unpackRGBAToDepth(v)
#ifdef FRAMEBUFFER_PRECISION_HIGH
uniform mediump sampler2D inputBuffer;
#else
uniform lowp sampler2D inputBuffer;
#endif
#if DEPTH_PACKING == 3201
uniform lowp sampler2D depthBuffer;
#elif defined(GL_FRAGMENT_PRECISION_HIGH)
uniform highp sampler2D depthBuffer;
#else
uniform mediump sampler2D depthBuffer;
#endif
uniform vec2 resolution;uniform vec2 texelSize;uniform float cameraNear;uniform float cameraFar;uniform float aspect;uniform float time;varying vec2 vUv;vec4 sRGBToLinear(const in vec4 value){return vec4(mix(pow(value.rgb*0.9478672986+vec3(0.0521327014),vec3(2.4)),value.rgb*0.0773993808,vec3(lessThanEqual(value.rgb,vec3(0.04045)))),value.a);}float readDepth(const in vec2 uv){
#if DEPTH_PACKING == 3201
float depth=unpackRGBAToDepth(texture2D(depthBuffer,uv));
#else
float depth=texture2D(depthBuffer,uv).r;
#endif
#if defined(USE_LOGARITHMIC_DEPTH_BUFFER) || defined(LOG_DEPTH)
float d=pow(2.0,depth*log2(cameraFar+1.0))-1.0;float a=cameraFar/(cameraFar-cameraNear);float b=cameraFar*cameraNear/(cameraNear-cameraFar);depth=a+b/d;
#elif defined(USE_REVERSED_DEPTH_BUFFER)
depth=1.0-depth;
#endif
return depth;}float getViewZ(const in float depth){
#ifdef PERSPECTIVE_CAMERA
return perspectiveDepthToViewZ(depth,cameraNear,cameraFar);
#else
return orthographicDepthToViewZ(depth,cameraNear,cameraFar);
#endif
}vec3 RGBToHCV(const in vec3 RGB){vec4 P=mix(vec4(RGB.bg,-1.0,2.0/3.0),vec4(RGB.gb,0.0,-1.0/3.0),step(RGB.b,RGB.g));vec4 Q=mix(vec4(P.xyw,RGB.r),vec4(RGB.r,P.yzx),step(P.x,RGB.r));float C=Q.x-min(Q.w,Q.y);float H=abs((Q.w-Q.y)/(6.0*C+EPSILON)+Q.z);return vec3(H,C,Q.x);}vec3 RGBToHSL(const in vec3 RGB){vec3 HCV=RGBToHCV(RGB);float L=HCV.z-HCV.y*0.5;float S=HCV.y/(1.0-abs(L*2.0-1.0)+EPSILON);return vec3(HCV.x,S,L);}vec3 HueToRGB(const in float H){float R=abs(H*6.0-3.0)-1.0;float G=2.0-abs(H*6.0-2.0);float B=2.0-abs(H*6.0-4.0);return clamp(vec3(R,G,B),0.0,1.0);}vec3 HSLToRGB(const in vec3 HSL){vec3 RGB=HueToRGB(HSL.x);float C=(1.0-abs(2.0*HSL.z-1.0))*HSL.y;return(RGB-0.5)*C+HSL.z;}FRAGMENT_HEAD void main(){FRAGMENT_MAIN_UV vec4 color0=texture2D(inputBuffer,UV);vec4 color1=vec4(0.0);FRAGMENT_MAIN_IMAGE color0.a=clamp(color0.a,0.0,1.0);gl_FragColor=color0;
#ifdef ENCODE_OUTPUT
#include <colorspace_fragment>
#endif
#include <dithering_fragment>
}`,Mi="uniform vec2 resolution;uniform vec2 texelSize;uniform float cameraNear;uniform float cameraFar;uniform float aspect;uniform float time;varying vec2 vUv;VERTEX_HEAD void main(){vUv=position.xy*0.5+0.5;VERTEX_MAIN_SUPPORT gl_Position=vec4(position.xy,1.0,1.0);}",Ti=class extends Be{constructor(e,t,r,a,i=!1){super({name:"EffectMaterial",defines:{THREE_REVISION:Zr.replace(/\D+/g,""),DEPTH_PACKING:"0",ENCODE_OUTPUT:"1"},uniforms:{inputBuffer:new J(null),depthBuffer:new J(null),resolution:new J(new re),texelSize:new J(new re),cameraNear:new J(.3),cameraFar:new J(1e3),aspect:new J(1),time:new J(0)},blending:at,toneMapped:!1,depthWrite:!1,depthTest:!1,dithering:i}),e&&this.setShaderParts(e),t&&this.setDefines(t),r&&this.setUniforms(r),this.copyCameraSettings(a)}set inputBuffer(e){this.uniforms.inputBuffer.value=e}setInputBuffer(e){this.uniforms.inputBuffer.value=e}get depthBuffer(){return this.uniforms.depthBuffer.value}set depthBuffer(e){this.uniforms.depthBuffer.value=e}get depthPacking(){return Number(this.defines.DEPTH_PACKING)}set depthPacking(e){this.defines.DEPTH_PACKING=e.toFixed(0),this.needsUpdate=!0}setDepthBuffer(e,t=yt){this.depthBuffer=e,this.depthPacking=t}setShaderData(e){this.setShaderParts(e.shaderParts),this.setDefines(e.defines),this.setUniforms(e.uniforms),this.setExtensions(e.extensions)}setShaderParts(e){return this.fragmentShader=xi.replace(q.FRAGMENT_HEAD,e.get(q.FRAGMENT_HEAD)||"").replace(q.FRAGMENT_MAIN_UV,e.get(q.FRAGMENT_MAIN_UV)||"").replace(q.FRAGMENT_MAIN_IMAGE,e.get(q.FRAGMENT_MAIN_IMAGE)||""),this.vertexShader=Mi.replace(q.VERTEX_HEAD,e.get(q.VERTEX_HEAD)||"").replace(q.VERTEX_MAIN_SUPPORT,e.get(q.VERTEX_MAIN_SUPPORT)||""),this.needsUpdate=!0,this}setDefines(e){for(const t of e.entries())this.defines[t[0]]=t[1];return this.needsUpdate=!0,this}setUniforms(e){for(const t of e.entries())this.uniforms[t[0]]=t[1];return this}setExtensions(e){this.extensions={};for(const t of e)this.extensions[t]=!0;return this}get encodeOutput(){return this.defines.ENCODE_OUTPUT!==void 0}set encodeOutput(e){this.encodeOutput!==e&&(e?this.defines.ENCODE_OUTPUT="1":delete this.defines.ENCODE_OUTPUT,this.needsUpdate=!0)}isOutputEncodingEnabled(e){return this.encodeOutput}setOutputEncodingEnabled(e){this.encodeOutput=e}get time(){return this.uniforms.time.value}set time(e){this.uniforms.time.value=e}setDeltaTime(e){this.uniforms.time.value+=e}adoptCameraSettings(e){this.copyCameraSettings(e)}copyCameraSettings(e){e&&(this.uniforms.cameraNear.value=e.near,this.uniforms.cameraFar.value=e.far,e instanceof Vt?this.defines.PERSPECTIVE_CAMERA="1":delete this.defines.PERSPECTIVE_CAMERA,this.needsUpdate=!0)}setSize(e,t){const r=this.uniforms;r.resolution.value.set(e,t),r.texelSize.value.set(1/e,1/t),r.aspect.value=e/t}static get Section(){return q}};function Ir(e,t,r){for(const a of t){const i="$1"+e+a.charAt(0).toUpperCase()+a.slice(1),o=new RegExp("([^\\.])(\\b"+a+"\\b)","g");for(const l of r.entries())l[1]!==null&&r.set(l[0],l[1].replace(o,i))}}function _i(e,t,r){let a=t.getFragmentShader(),i=t.getVertexShader();const o=a!==void 0&&/mainImage/.test(a),l=a!==void 0&&/mainUv/.test(a);if(r.attributes|=t.getAttributes(),a===void 0)throw new Error(`Missing fragment shader (${t.name})`);if(l&&(r.attributes&dt.CONVOLUTION)!==0)throw new Error(`Effects that transform UVs are incompatible with convolution effects (${t.name})`);if(!o&&!l)throw new Error(`Could not find mainImage or mainUv function (${t.name})`);{const u=/\w+\s+(\w+)\([\w\s,]*\)\s*{/g,f=r.shaderParts;let d=f.get(q.FRAGMENT_HEAD)||"",w=f.get(q.FRAGMENT_MAIN_UV)||"",S=f.get(q.FRAGMENT_MAIN_IMAGE)||"",M=f.get(q.VERTEX_HEAD)||"",E=f.get(q.VERTEX_MAIN_SUPPORT)||"";const N=new Set,L=new Set;if(l&&(w+=`	${e}MainUv(UV);
`,r.uvTransformation=!0),i!==null&&/mainSupport/.test(i)){const P=/mainSupport *\([\w\s]*?uv\s*?\)/.test(i);E+=`	${e}MainSupport(`,E+=P?`vUv);
`:`);
`;for(const g of i.matchAll(/(?:varying\s+\w+\s+([\S\s]*?);)/g))for(const B of g[1].split(/\s*,\s*/))r.varyings.add(B),N.add(B),L.add(B);for(const g of i.matchAll(u))L.add(g[1])}for(const P of a.matchAll(u))L.add(P[1]);for(const P of t.defines.keys())L.add(P.replace(/\([\w\s,]*\)/g,""));for(const P of t.uniforms.keys())L.add(P);L.delete("while"),L.delete("for"),L.delete("if"),t.uniforms.forEach((P,g)=>r.uniforms.set(e+g.charAt(0).toUpperCase()+g.slice(1),P)),t.defines.forEach((P,g)=>r.defines.set(e+g.charAt(0).toUpperCase()+g.slice(1),P));const y=new Map([["fragment",a],["vertex",i]]);Ir(e,L,r.defines),Ir(e,L,y),a=y.get("fragment"),i=y.get("vertex");const C=t.blendMode;if(r.blendModes.set(C.blendFunction,C),o){t.inputColorSpace!==null&&t.inputColorSpace!==r.colorSpace&&(S+=t.inputColorSpace===Se?`color0 = sRGBTransferOETF(color0);
	`:`color0 = sRGBToLinear(color0);
	`),t.outputColorSpace!==Xr?r.colorSpace=t.outputColorSpace:t.inputColorSpace!==null&&(r.colorSpace=t.inputColorSpace);const P=/MainImage *\([\w\s,]*?depth[\w\s,]*?\)/;S+=`${e}MainImage(color0, UV, `,(r.attributes&dt.DEPTH)!==0&&P.test(a)&&(S+="depth, ",r.readDepth=!0),S+=`color1);
	`;const g=e+"BlendOpacity";r.uniforms.set(g,C.opacity),S+=`color0 = blend${C.blendFunction}(color0, color1, ${g});

	`,d+=`uniform float ${g};

`}if(d+=a+`
`,i!==null&&(M+=i+`
`),f.set(q.FRAGMENT_HEAD,d),f.set(q.FRAGMENT_MAIN_UV,w),f.set(q.FRAGMENT_MAIN_IMAGE,S),f.set(q.VERTEX_HEAD,M),f.set(q.VERTEX_MAIN_SUPPORT,E),t.extensions!==null)for(const P of t.extensions)r.extensions.add(P)}}var Ri=class extends Pe{constructor(e,...t){super("EffectPass"),this.fullscreenMaterial=new Ti(null,null,null,e),this.listener=r=>this.handleEvent(r),this.effects=[],this.setEffects(t),this.skipRendering=!1,this.minTime=1,this.maxTime=Number.POSITIVE_INFINITY,this.timeScale=1}set mainScene(e){for(const t of this.effects)t.mainScene=e}set mainCamera(e){this.fullscreenMaterial.copyCameraSettings(e);for(const t of this.effects)t.mainCamera=e}get encodeOutput(){return this.fullscreenMaterial.encodeOutput}set encodeOutput(e){this.fullscreenMaterial.encodeOutput=e}get dithering(){return this.fullscreenMaterial.dithering}set dithering(e){const t=this.fullscreenMaterial;t.dithering=e,t.needsUpdate=!0}setEffects(e){for(const t of this.effects)t.removeEventListener("change",this.listener);this.effects=e.sort((t,r)=>r.attributes-t.attributes);for(const t of this.effects)t.addEventListener("change",this.listener)}updateMaterial(){const e=new Sa;let t=0;for(const l of this.effects)if(l.blendMode.blendFunction===K.DST)e.attributes|=l.getAttributes()&dt.DEPTH;else{if((e.attributes&l.getAttributes()&dt.CONVOLUTION)!==0)throw new Error(`Convolution effects cannot be merged (${l.name})`);_i("e"+t++,l,e)}let r=e.shaderParts.get(q.FRAGMENT_HEAD),a=e.shaderParts.get(q.FRAGMENT_MAIN_IMAGE),i=e.shaderParts.get(q.FRAGMENT_MAIN_UV);const o=/\bblend\b/g;for(const l of e.blendModes.values())r+=l.getShaderCode().replace(o,`blend${l.blendFunction}`)+`
`;(e.attributes&dt.DEPTH)!==0?(e.readDepth&&(a=`float depth = readDepth(UV);

	`+a),this.needsDepthTexture=this.getDepthTexture()===null):this.needsDepthTexture=!1,e.colorSpace===Se&&(a+=`color0 = sRGBToLinear(color0);
	`),e.uvTransformation?(i=`vec2 transformedUv = vUv;
`+i,e.defines.set("UV","transformedUv")):e.defines.set("UV","vUv"),e.shaderParts.set(q.FRAGMENT_HEAD,r),e.shaderParts.set(q.FRAGMENT_MAIN_IMAGE,a),e.shaderParts.set(q.FRAGMENT_MAIN_UV,i);for(const[l,u]of e.shaderParts)u!==null&&e.shaderParts.set(l,u.trim().replace(/^#/,`
#`));this.skipRendering=t===0,this.needsSwap=!this.skipRendering,this.fullscreenMaterial.setShaderData(e)}recompile(){this.updateMaterial()}getDepthTexture(){return this.fullscreenMaterial.depthBuffer}setDepthTexture(e,t=yt){this.fullscreenMaterial.depthBuffer=e,this.fullscreenMaterial.depthPacking=t;for(const r of this.effects)r.setDepthTexture(e,t)}render(e,t,r,a,i){for(const o of this.effects)o.update(e,t,a);if(!this.skipRendering||this.renderToScreen){const o=this.fullscreenMaterial;o.inputBuffer=t.texture,o.time+=a*this.timeScale,e.setRenderTarget(this.renderToScreen?null:r),e.render(this.scene,this.camera)}}setSize(e,t){this.fullscreenMaterial.setSize(e,t);for(const r of this.effects)r.setSize(e,t)}initialize(e,t,r){this.renderer=e;for(const a of this.effects)a.initialize(e,t,r);this.updateMaterial(),r!==void 0&&r!==Xe&&(this.fullscreenMaterial.defines.FRAMEBUFFER_PRECISION_HIGH="1")}dispose(){super.dispose();for(const e of this.effects)e.removeEventListener("change",this.listener),e.dispose()}handleEvent(e){e.type==="change"&&this.recompile()}},Ai=class extends Pe{constructor(e,t,{renderTarget:r,resolutionScale:a=1,width:i=Te.AUTO_SIZE,height:o=Te.AUTO_SIZE,resolutionX:l=i,resolutionY:u=o}={}){super("NormalPass"),this.needsSwap=!1,this.renderPass=new wn(e,t,new jn);const f=this.renderPass;f.ignoreBackground=!0,f.skipShadowMapUpdate=!0;const d=f.getClearPass();d.overrideClearColor=new Bt(7829503),d.overrideClearAlpha=1,this.renderTarget=r,this.renderTarget===void 0&&(this.renderTarget=new De(1,1,{minFilter:Wt,magFilter:Wt}),this.renderTarget.texture.name="NormalPass.Target");const w=this.resolution=new Te(this,l,u,a);w.addEventListener("change",S=>this.setSize(w.baseWidth,w.baseHeight))}set mainScene(e){this.renderPass.mainScene=e}set mainCamera(e){this.renderPass.mainCamera=e}get texture(){return this.renderTarget.texture}getTexture(){return this.renderTarget.texture}getResolution(){return this.resolution}getResolutionScale(){return this.resolution.scale}setResolutionScale(e){this.resolution.scale=e}render(e,t,r,a,i){const o=this.renderToScreen?null:this.renderTarget;this.renderPass.render(e,o,o)}setSize(e,t){const r=this.resolution;r.setBaseSize(e,t),this.renderTarget.setSize(r.width,r.height)}};function Ct(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}new re;new re;function yn(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var ke=function e(t,r,a){var i=this;yn(this,e),Ct(this,"dot2",function(o,l){return i.x*o+i.y*l}),Ct(this,"dot3",function(o,l,u){return i.x*o+i.y*l+i.z*u}),this.x=t,this.y=r,this.z=a},Ui=[new ke(1,1,0),new ke(-1,1,0),new ke(1,-1,0),new ke(-1,-1,0),new ke(1,0,1),new ke(-1,0,1),new ke(1,0,-1),new ke(-1,0,-1),new ke(0,1,1),new ke(0,-1,1),new ke(0,1,-1),new ke(0,-1,-1)],Fr=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],Nr=new Array(512),kr=new Array(512),Pi=function(e){e>0&&e<1&&(e*=65536),e=Math.floor(e),e<256&&(e|=e<<8);for(var t=0;t<256;t++){var r;t&1?r=Fr[t]^e&255:r=Fr[t]^e>>8&255,Nr[t]=Nr[t+256]=r,kr[t]=kr[t+256]=Ui[r%12]}};Pi(0);function Ci(e){if(typeof e=="number")e=Math.abs(e);else if(typeof e=="string"){var t=e;e=0;for(var r=0;r<t.length;r++)e=(e+(r+1)*(t.charCodeAt(r)%96))%2147483647}return e===0&&(e=311),e}function Lr(e){var t=Ci(e);return function(){var r=t*48271%2147483647;return t=r,r/2147483647}}var Oi=function e(t){var r=this;yn(this,e),Ct(this,"seed",0),Ct(this,"init",function(a){r.seed=a,r.value=Lr(a)}),Ct(this,"value",Lr(this.seed)),this.init(t)};new Oi(Math.random());const zi=x.createContext(null),Hr=e=>(e.getAttributes()&2)===2,Di=x.memo(x.forwardRef(({children:e,camera:t,scene:r,resolutionScale:a,enabled:i=!0,renderPriority:o=1,autoClear:l=!0,depthBuffer:u,enableNormalPass:f,stencilBuffer:d,multisampling:w=8,frameBufferType:S=Ue},M)=>{const{gl:E,scene:N,camera:L,size:y}=de(),C=r||N,P=t||L,[g,B,_]=x.useMemo(()=>{const k=new ya(E,{depthBuffer:u,stencilBuffer:d,multisampling:w,frameBufferType:S});k.addPass(new wn(C,P));let R=null,X=null;return f&&(X=new Ai(C,P),X.enabled=!1,k.addPass(X),a!==void 0&&(R=new Ei({normalBuffer:X.texture,resolutionScale:a}),R.enabled=!1,k.addPass(R))),[k,X,R]},[P,E,u,d,w,S,C,f,a]);x.useEffect(()=>g?.setSize(y.width,y.height),[g,y]),wt((k,R)=>{if(i){const X=E.autoClear;E.autoClear=l,d&&!l&&E.clearStencil(),g.render(R),E.autoClear=X}},i?o:0);const O=x.useRef(null);x.useLayoutEffect(()=>{const k=[],R=O.current.__r3f;if(R&&g){const X=R.children;for(let ee=0;ee<X.length;ee++){const Q=X[ee].object;if(Q instanceof vr){const Ee=[Q];if(!Hr(Q)){let le=null;for(;(le=X[ee+1]?.object)instanceof vr&&!Hr(le);)Ee.push(le),ee++}const ne=new Ri(P,...Ee);k.push(ne)}else Q instanceof Pe&&k.push(Q)}for(const ee of k)g?.addPass(ee);B&&(B.enabled=!0),_&&(_.enabled=!0)}return()=>{for(const X of k)g?.removePass(X);B&&(B.enabled=!1),_&&(_.enabled=!1)}},[g,e,P,B,_]),x.useEffect(()=>{const k=E.toneMapping;return E.toneMapping=An,()=>{E.toneMapping=k}},[E]);const j=x.useMemo(()=>({composer:g,normalPass:B,downSamplingPass:_,resolutionScale:a,camera:P,scene:C}),[g,B,_,a,P,C]);return x.useImperativeHandle(M,()=>g,[g]),V.jsx(zi.Provider,{value:j,children:V.jsx("group",{ref:O,children:e})})}));let Bi=0;const jr=new WeakMap,Ii=(e,t)=>function({blendFunction:r=t?.blendFunction,opacity:a=t?.opacity,...i}){let o=jr.get(e);if(!o){const f=`@react-three/postprocessing/${e.name}-${Bi++}`;Qt({[f]:e}),jr.set(e,o=f)}const l=de(f=>f.camera),u=Sn.useMemo(()=>[...t?.args??[],...i.args??[{...t,...i}]],[JSON.stringify(i)]);return V.jsx(o,{camera:l,"blendMode-blendFunction":r,"blendMode-opacity-value":a,...i,args:u})},Fi=Ii(bi,{blendFunction:0}),Gi=({data:e,config:t,onHoverPoint:r,hoveredPoint:a})=>V.jsxs("div",{className:"ark-scene3d",children:[V.jsx(ps,{shadows:!0,dpr:[1,2],gl:{toneMappingExposure:1},children:V.jsxs(x.Suspense,{fallback:null,children:[V.jsx(js,{makeDefault:!0,position:[15,15,25],fov:50}),V.jsx(Gs,{target:[10,5,5],maxPolarAngle:Math.PI/2-.1,minDistance:5,maxDistance:50}),V.jsx("color",{attach:"background",args:["#02040a"]}),V.jsx(ca,{radius:100,depth:50,count:5e3,factor:4,saturation:0,fade:!0,speed:1}),V.jsx(da,{count:40,scale:20,size:3,speed:.4,opacity:.2,position:[10,5,5],color:"#ffffff"}),V.jsx(ia,{preset:"city",background:!1,blur:.8}),V.jsx("ambientLight",{intensity:.2}),V.jsx("pointLight",{position:[10,20,10],intensity:.8,color:"#ffffff"}),V.jsx("pointLight",{position:[-10,5,20],intensity:1.5,color:"#3b82f6"}),V.jsx("pointLight",{position:[30,5,-10],intensity:1.5,color:"#f43f5e"}),V.jsxs("group",{children:[t.showGrid&&V.jsx(En,{brightness:t.gridBrightness,fontFamily:t.fontFamily,fontSizeLabels:t.fontSizeLabels,fontSizeValues:t.fontSizeValues,bgImageOpacity:t.bgImageOpacity,bgImageUrl:t.bgImageUrl,bgImageScale:t.bgImageScale}),V.jsx(xn,{data:e,config:t,onHover:r,hoveredPointId:a?.id||null}),V.jsx(Mn,{data:e,config:t})]}),V.jsx(Di,{enableNormalPass:!1,children:V.jsx(Fi,{luminanceThreshold:.2,mipmapBlur:!0,intensity:t.bloomIntensity,radius:.6})})]})}),a&&V.jsxs("div",{className:"ark-scene3d__tooltip",children:[V.jsx("h3",{className:"ark-scene3d__tooltip-title",children:"Data Point"}),V.jsxs("div",{className:"ark-scene3d__tooltip-row",children:[V.jsx("span",{children:"Value (Y):"}),V.jsx("span",{className:"ark-scene3d__tooltip-value",children:a.y.toFixed(4)})]}),V.jsxs("div",{className:"ark-scene3d__tooltip-row",children:[V.jsx("span",{children:"Time (X):"}),V.jsx("span",{children:a.x.toFixed(2)})]}),V.jsxs("div",{className:"ark-scene3d__tooltip-row",children:[V.jsx("span",{children:"Series (Z):"}),V.jsx("span",{children:a.z.toFixed(2)})]}),a.open!==void 0&&V.jsxs(V.Fragment,{children:[V.jsxs("div",{className:"ark-scene3d__tooltip-row",children:[V.jsx("span",{children:"Open:"}),V.jsx("span",{children:a.open.toFixed(2)})]}),V.jsxs("div",{className:"ark-scene3d__tooltip-row",children:[V.jsx("span",{children:"Close:"}),V.jsx("span",{children:a.close?.toFixed(2)})]})]})]}),V.jsxs("div",{className:"ark-scene3d__title",children:[V.jsx("h1",{children:"Ark.Alliance.Chart3D"}),V.jsx("p",{children:"Real-time Visualization"})]})]});export{Gi as Scene3D,Gi as default};
